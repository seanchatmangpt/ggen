# Level 5: Enterprise CI/CD Workflow
# Demonstrates enterprise-scale CI/CD with distributed processing

name: Enterprise CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * *'  # Daily builds

jobs:
  generate-distributed:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tenant: [tenant1, tenant2, shared]
    steps:
      - uses: actions/checkout@v3
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
      - name: Generate for ${{ matrix.tenant }}
        run: |
          ggen lifecycle run generate --tenant ${{ matrix.tenant }} --distributed

  build:
    runs-on: ubuntu-latest
    needs: generate-distributed
    steps:
      - uses: actions/checkout@v3
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
      - name: Build Workspace
        run: |
          cd generated && cargo build --workspace -j 20

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
      - name: Run Test Suite
        run: |
          cd generated && cargo test --workspace --no-fail-fast

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Production
        run: |
          ggen lifecycle run deploy

