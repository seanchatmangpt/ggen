# Generated GCP Cloud SQL Configuration - DO NOT EDIT
#
# This file is automatically generated by ggen from ontology/infra.ttl
# To make changes, edit the ontology and run: ggen sync

{% for row in sparql_results -%}
{%- set instance_name = row["?instanceName"] | default(value="attribution-event-store") -%}
{%- set region = row["?region"] | default(value="us-central1") -%}
{%- set tier = row["?tier"] | default(value="db-custom-2-7680") -%}
{%- set database_version = row["?databaseVersion"] | default(value="POSTGRES_15") -%}
{%- set availability_type = row["?availabilityType"] | default(value="REGIONAL") -%}

# Cloud SQL PostgreSQL instance for event sourcing
resource "google_sql_database_instance" "{{ instance_name | replace(from="-", to="_") }}" {
  name             = "{{ instance_name }}"
  database_version = "{{ database_version }}"
  region           = "{{ region }}"

  settings {
    tier              = "{{ tier }}"
    availability_type = "{{ availability_type }}" # Regional for HA
    edition           = "ENTERPRISE"

    disk_type       = "PD_SSD"
    disk_size       = 100
    disk_autoresize = true
    disk_autoresize_limit = 1000

    backup_configuration {
      enabled                        = true
      start_time                     = "03:00"
      point_in_time_recovery_enabled = true
      transaction_log_retention_days = 7
      backup_retention_settings {
        retained_backups = 30
        retention_unit   = "COUNT"
      }
    }

    ip_configuration {
      ipv4_enabled    = false
      private_network = google_compute_network.vpc.id
      require_ssl     = true

      psc_config {
        psc_enabled = true
      }
    }

    database_flags {
      name  = "max_connections"
      value = "200"
    }

    database_flags {
      name  = "shared_buffers"
      value = "1835008" # 1.75GB for 7GB RAM instance
    }

    database_flags {
      name  = "effective_cache_size"
      value = "5505024" # 5.25GB (75% of RAM)
    }

    database_flags {
      name  = "maintenance_work_mem"
      value = "458752" # 448MB
    }

    database_flags {
      name  = "work_mem"
      value = "9370" # ~9MB
    }

    database_flags {
      name  = "random_page_cost"
      value = "1.1" # Optimized for SSD
    }

    database_flags {
      name  = "effective_io_concurrency"
      value = "200"
    }

    database_flags {
      name  = "wal_buffers"
      value = "16384" # 16MB
    }

    database_flags {
      name  = "default_statistics_target"
      value = "100"
    }

    database_flags {
      name  = "checkpoint_completion_target"
      value = "0.9"
    }

    database_flags {
      name  = "log_min_duration_statement"
      value = "1000" # Log queries taking >1s
    }

    database_flags {
      name  = "cloudsql.enable_pg_cron"
      value = "on"
    }

    insights_config {
      query_insights_enabled  = true
      query_plans_per_minute  = 5
      query_string_length     = 4500
      record_application_tags = true
      record_client_address   = true
    }

    maintenance_window {
      day          = 7 # Sunday
      hour         = 3
      update_track = "stable"
    }
  }

  deletion_protection = true

  depends_on = [
    google_service_networking_connection.private_vpc_connection,
  ]
}

# Event store database
resource "google_sql_database" "event_store_db" {
  name     = "event_store"
  instance = google_sql_database_instance.{{ instance_name | replace(from="-", to="_") }}.name
  charset  = "UTF8"
  collation = "en_US.UTF8"
}

# Application database user
resource "google_sql_user" "app_user" {
  name     = "attribution_app"
  instance = google_sql_database_instance.{{ instance_name | replace(from="-", to="_") }}.name
  password = random_password.db_password.result
}

# Strong random password for database
resource "random_password" "db_password" {
  length  = 32
  special = true
}

# Store connection string in Secret Manager
resource "google_secret_manager_secret" "db_connection_string" {
  secret_id = "db-connection-string"

  replication {
    auto {}
  }

  lifecycle {
    prevent_destroy = true
  }
}

resource "google_secret_manager_secret_version" "db_connection_string" {
  secret = google_secret_manager_secret.db_connection_string.id
  secret_data = "postgresql://${google_sql_user.app_user.name}:${google_sql_user.app_user.password}@${google_sql_database_instance.{{ instance_name | replace(from="-", to="_") }}.private_ip_address}:5432/${google_sql_database.event_store_db.name}?sslmode=require"
}

# Read replica for analytics/reporting (optional but production-ready)
resource "google_sql_database_instance" "{{ instance_name | replace(from="-", to="_") }}_replica" {
  name                 = "{{ instance_name }}-replica"
  database_version     = "{{ database_version }}"
  region               = "us-east1" # Different region for geo-redundancy
  master_instance_name = google_sql_database_instance.{{ instance_name | replace(from="-", to="_") }}.name

  replica_configuration {
    failover_target = false
  }

  settings {
    tier              = "{{ tier }}"
    availability_type = "ZONAL"
    edition           = "ENTERPRISE"

    disk_type       = "PD_SSD"
    disk_size       = 100
    disk_autoresize = true

    ip_configuration {
      ipv4_enabled    = false
      private_network = google_compute_network.vpc.id
      require_ssl     = true
    }

    insights_config {
      query_insights_enabled = true
    }
  }

  deletion_protection = true
}

{% endfor %}

# Enable required APIs
resource "google_project_service" "sql_api" {
  service            = "sqladmin.googleapis.com"
  disable_on_destroy = false
}

resource "google_project_service" "servicenetworking_api" {
  service            = "servicenetworking.googleapis.com"
  disable_on_destroy = false
}

resource "google_project_service" "secretmanager_api" {
  service            = "secretmanager.googleapis.com"
  disable_on_destroy = false
}

# Private VPC peering for Cloud SQL
resource "google_compute_global_address" "private_ip_range" {
  name          = "private-ip-range"
  purpose       = "VPC_PEERING"
  address_type  = "INTERNAL"
  prefix_length = 16
  network       = google_compute_network.vpc.id

  depends_on = [google_project_service.servicenetworking_api]
}

resource "google_service_networking_connection" "private_vpc_connection" {
  network                 = google_compute_network.vpc.id
  service                 = "servicenetworking.googleapis.com"
  reserved_peering_ranges = [google_compute_global_address.private_ip_range.name]

  depends_on = [google_project_service.servicenetworking_api]
}
