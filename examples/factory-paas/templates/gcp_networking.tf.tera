# Generated GCP Networking Configuration - DO NOT EDIT
#
# This file is automatically generated by ggen from ontology/infra.ttl
# To make changes, edit the ontology and run: ggen sync

{% for row in sparql_results -%}
{%- set network_name = row["?networkName"] | default(value="attribution-vpc") -%}
{%- set region = row["?region"] | default(value="us-central1") -%}

# VPC Network
resource "google_compute_network" "vpc" {
  name                            = "{{ network_name }}"
  auto_create_subnetworks         = false
  delete_default_routes_on_create = false
  routing_mode                    = "REGIONAL"
  mtu                             = 1460
}

# Public subnet for Cloud Run VPC connector
resource "google_compute_subnetwork" "public" {
  name          = "{{ network_name }}-public-subnet"
  ip_cidr_range = "10.0.1.0/24"
  region        = "{{ region }}"
  network       = google_compute_network.vpc.id

  private_ip_google_access = true

  log_config {
    aggregation_interval = "INTERVAL_10_MIN"
    flow_sampling        = 0.5
    metadata             = "INCLUDE_ALL_METADATA"
  }
}

# Private subnet for Cloud SQL and internal services
resource "google_compute_subnetwork" "private" {
  name          = "{{ network_name }}-private-subnet"
  ip_cidr_range = "10.0.2.0/24"
  region        = "{{ region }}"
  network       = google_compute_network.vpc.id

  private_ip_google_access = true

  log_config {
    aggregation_interval = "INTERVAL_10_MIN"
    flow_sampling        = 0.5
    metadata             = "INCLUDE_ALL_METADATA"
  }
}

# Cloud Router for NAT
resource "google_compute_router" "router" {
  name    = "{{ network_name }}-router"
  region  = "{{ region }}"
  network = google_compute_network.vpc.id
}

# Cloud NAT for outbound connectivity from private resources
resource "google_compute_router_nat" "nat" {
  name                               = "{{ network_name }}-nat"
  router                             = google_compute_router.router.name
  region                             = google_compute_router.router.region
  nat_ip_allocate_option             = "AUTO_ONLY"
  source_subnetwork_ip_ranges_to_nat = "ALL_SUBNETWORKS_ALL_IP_RANGES"

  log_config {
    enable = true
    filter = "ERRORS_ONLY"
  }
}

# Firewall rule: Allow health checks from Google Cloud
resource "google_compute_firewall" "allow_health_checks" {
  name    = "{{ network_name }}-allow-health-checks"
  network = google_compute_network.vpc.name

  allow {
    protocol = "tcp"
    ports    = ["8080"]
  }

  source_ranges = [
    "130.211.0.0/22",  # Google Cloud health check ranges
    "35.191.0.0/16",
  ]

  target_tags = ["allow-health-check"]
}

# Firewall rule: Allow internal VPC communication
resource "google_compute_firewall" "allow_internal" {
  name    = "{{ network_name }}-allow-internal"
  network = google_compute_network.vpc.name

  allow {
    protocol = "tcp"
    ports    = ["0-65535"]
  }

  allow {
    protocol = "udp"
    ports    = ["0-65535"]
  }

  allow {
    protocol = "icmp"
  }

  source_ranges = [
    "10.0.0.0/16",
  ]

  priority = 1000
}

# Firewall rule: Deny all ingress by default (implicit deny)
resource "google_compute_firewall" "deny_all_ingress" {
  name    = "{{ network_name }}-deny-all-ingress"
  network = google_compute_network.vpc.name

  deny {
    protocol = "all"
  }

  source_ranges = ["0.0.0.0/0"]
  priority      = 65534
}

# Cloud Armor security policy for DDoS protection
resource "google_compute_security_policy" "cloud_armor_policy" {
  name = "{{ network_name }}-security-policy"

  # Rate limiting rule
  rule {
    action   = "rate_based_ban"
    priority = 1000

    match {
      versioned_expr = "SRC_IPS_V1"
      config {
        src_ip_ranges = ["*"]
      }
    }

    rate_limit_options {
      conform_action = "allow"
      exceed_action  = "deny(429)"
      enforce_on_key = "IP"

      rate_limit_threshold {
        count        = 100
        interval_sec = 60
      }

      ban_duration_sec = 600
    }
  }

  # Block SQL injection attempts
  rule {
    action   = "deny(403)"
    priority = 2000

    match {
      expr {
        expression = "evaluatePreconfiguredExpr('sqli-stable')"
      }
    }
  }

  # Block XSS attempts
  rule {
    action   = "deny(403)"
    priority = 3000

    match {
      expr {
        expression = "evaluatePreconfiguredExpr('xss-stable')"
      }
    }
  }

  # Block known bad bots
  rule {
    action   = "deny(403)"
    priority = 4000

    match {
      expr {
        expression = "evaluatePreconfiguredExpr('lfi-stable')"
      }
    }
  }

  # Default rule - allow
  rule {
    action   = "allow"
    priority = 2147483647

    match {
      versioned_expr = "SRC_IPS_V1"
      config {
        src_ip_ranges = ["*"]
      }
    }
  }

  adaptive_protection_config {
    layer_7_ddos_defense_config {
      enable = true
    }
  }
}

# DNS zone for custom domain
resource "google_dns_managed_zone" "attribution_zone" {
  name        = "attribution-zone"
  dns_name    = "attribution.example.com."
  description = "DNS zone for attribution service"

  dnssec_config {
    state = "on"

    default_key_specs {
      algorithm  = "rsasha256"
      key_length = 2048
      key_type   = "keySigning"
    }

    default_key_specs {
      algorithm  = "rsasha256"
      key_length = 1024
      key_type   = "zoneSigning"
    }
  }
}

# A record for Cloud Run service
resource "google_dns_record_set" "api_a_record" {
  name         = "api.attribution.example.com."
  type         = "A"
  ttl          = 300
  managed_zone = google_dns_managed_zone.attribution_zone.name

  rrdatas = [google_compute_global_address.cloud_run_ip.address]
}

# A record for CDN
resource "google_dns_record_set" "static_a_record" {
  name         = "static.attribution.example.com."
  type         = "A"
  ttl          = 300
  managed_zone = google_dns_managed_zone.attribution_zone.name

  rrdatas = [google_compute_global_address.attribution_static_content_cdn.address]
}

# Global IP for Cloud Run custom domain
resource "google_compute_global_address" "cloud_run_ip" {
  name = "cloud-run-ip"
}

{% endfor %}

# Enable required APIs
resource "google_project_service" "compute_api" {
  service            = "compute.googleapis.com"
  disable_on_destroy = false
}

resource "google_project_service" "dns_api" {
  service            = "dns.googleapis.com"
  disable_on_destroy = false
}
