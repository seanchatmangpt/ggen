# Generated GCP IAM Configuration - DO NOT EDIT
#
# This file is automatically generated by ggen from ontology/infra.ttl
# To make changes, edit the ontology and run: ggen sync

# Custom IAM role for Cloud Run service with least privilege
resource "google_project_iam_custom_role" "cloud_run_app_role" {
  role_id     = "cloudRunAppRole"
  title       = "Cloud Run Application Role"
  description = "Least privilege role for Cloud Run attribution service"

  permissions = [
    # Cloud SQL
    "cloudsql.instances.connect",
    "cloudsql.instances.get",

    # Cloud Trace
    "cloudtrace.traces.patch",

    # Cloud Monitoring
    "monitoring.timeSeries.create",

    # Secret Manager
    "secretmanager.versions.access",

    # Logging
    "logging.logEntries.create",
  ]
}

# Service account for CI/CD deployment
resource "google_service_account" "cicd_deployer" {
  account_id   = "cicd-deployer"
  display_name = "CI/CD Deployment Service Account"
  description  = "Service account for automated deployments via GitHub Actions / Cloud Build"
}

# Grant CI/CD service account necessary permissions
resource "google_project_iam_member" "cicd_cloud_run_admin" {
  project = var.project_id
  role    = "roles/run.admin"
  member  = "serviceAccount:${google_service_account.cicd_deployer.email}"
}

resource "google_project_iam_member" "cicd_storage_admin" {
  project = var.project_id
  role    = "roles/storage.admin"
  member  = "serviceAccount:${google_service_account.cicd_deployer.email}"
}

resource "google_project_iam_member" "cicd_artifact_registry_writer" {
  project = var.project_id
  role    = "roles/artifactregistry.writer"
  member  = "serviceAccount:${google_service_account.cicd_deployer.email}"
}

resource "google_project_iam_member" "cicd_service_account_user" {
  project = var.project_id
  role    = "roles/iam.serviceAccountUser"
  member  = "serviceAccount:${google_service_account.cicd_deployer.email}"
}

# Service account for database migrations
resource "google_service_account" "db_migrator" {
  account_id   = "db-migrator"
  display_name = "Database Migration Service Account"
  description  = "Service account for running database migrations"
}

# Grant database migrator Cloud SQL permissions
resource "google_project_iam_member" "db_migrator_sql_client" {
  project = var.project_id
  role    = "roles/cloudsql.client"
  member  = "serviceAccount:${google_service_account.db_migrator.email}"
}

resource "google_project_iam_member" "db_migrator_secret_accessor" {
  project = var.project_id
  role    = "roles/secretmanager.secretAccessor"
  member  = "serviceAccount:${google_service_account.db_migrator.email}"
}

# Workload Identity binding for GKE (if migrating to GKE in future)
resource "google_service_account_iam_binding" "workload_identity_binding" {
  service_account_id = google_service_account.attribution_service_sa.name
  role               = "roles/iam.workloadIdentityUser"

  members = [
    "serviceAccount:${var.project_id}.svc.id.goog[attribution/attribution-service]"
  ]
}

# Artifact Registry for container images
resource "google_artifact_registry_repository" "container_images" {
  location      = var.region
  repository_id = "attribution-containers"
  description   = "Container images for attribution service"
  format        = "DOCKER"

  cleanup_policies {
    id     = "keep-minimum-versions"
    action = "KEEP"

    most_recent_versions {
      keep_count = 10
    }
  }

  cleanup_policies {
    id     = "delete-old-untagged"
    action = "DELETE"

    condition {
      tag_state  = "UNTAGGED"
      older_than = "2592000s" # 30 days
    }
  }
}

# Grant Cloud Run service account pull access to Artifact Registry
resource "google_artifact_registry_repository_iam_member" "cloud_run_artifact_reader" {
  project    = var.project_id
  location   = google_artifact_registry_repository.container_images.location
  repository = google_artifact_registry_repository.container_images.name
  role       = "roles/artifactregistry.reader"
  member     = "serviceAccount:${google_service_account.attribution_service_sa.email}"
}

# Organization policy to enforce VPC Service Controls (if using org-level security)
resource "google_org_policy_policy" "require_shielded_vm" {
  count  = var.enforce_org_policies ? 1 : 0
  name   = "projects/${var.project_id}/policies/compute.requireShieldedVm"
  parent = "projects/${var.project_id}"

  spec {
    rules {
      enforce = "TRUE"
    }
  }
}

# Organization policy to restrict external IP assignment
resource "google_org_policy_policy" "restrict_external_ips" {
  count  = var.enforce_org_policies ? 1 : 0
  name   = "projects/${var.project_id}/policies/compute.vmExternalIpAccess"
  parent = "projects/${var.project_id}"

  spec {
    rules {
      deny_all = "TRUE"
    }
  }
}

# Audit logging configuration
resource "google_project_iam_audit_config" "audit_config" {
  project = var.project_id
  service = "allServices"

  audit_log_config {
    log_type = "ADMIN_READ"
  }

  audit_log_config {
    log_type = "DATA_READ"
  }

  audit_log_config {
    log_type = "DATA_WRITE"
  }
}

# Binary Authorization policy for container image verification
resource "google_binary_authorization_policy" "policy" {
  admission_whitelist_patterns {
    name_pattern = "gcr.io/google_containers/*"
  }

  admission_whitelist_patterns {
    name_pattern = "gcr.io/google-containers/*"
  }

  default_admission_rule {
    evaluation_mode  = "REQUIRE_ATTESTATION"
    enforcement_mode = "ENFORCED_BLOCK_AND_AUDIT_LOG"

    require_attestations_by = [
      google_binary_authorization_attestor.attestor.name
    ]
  }

  global_policy_evaluation_mode = "ENABLE"
}

# Binary Authorization attestor
resource "google_binary_authorization_attestor" "attestor" {
  name = "attribution-attestor"

  attestation_authority_note {
    note_reference = google_container_analysis_note.note.name
  }
}

# Container Analysis note for attestation
resource "google_container_analysis_note" "note" {
  name = "attribution-attestor-note"

  attestation_authority {
    hint {
      human_readable_name = "Attribution Service Attestor"
    }
  }
}

# Enable required APIs
resource "google_project_service" "iam_api" {
  service            = "iam.googleapis.com"
  disable_on_destroy = false
}

resource "google_project_service" "artifactregistry_api" {
  service            = "artifactregistry.googleapis.com"
  disable_on_destroy = false
}

resource "google_project_service" "binaryauthorization_api" {
  service            = "binaryauthorization.googleapis.com"
  disable_on_destroy = false
}

resource "google_project_service" "containeranalysis_api" {
  service            = "containeranalysis.googleapis.com"
  disable_on_destroy = false
}
