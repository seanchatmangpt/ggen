# Generated Terraform Configuration - DO NOT EDIT
#
# This file is automatically generated by ggen from ontology/infra.ttl
# To make changes, edit the ontology and run: ggen sync

terraform {
  required_version = ">= 1.0"

  required_providers {
{% for row in sparql_results -%}
{%- if row["?provider"] == "oci" %}
    oci = {
      source  = "oracle/oci"
      version = "~> 5.0"
    }
{% endif -%}
{%- if row["?provider"] == "aws" %}
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
{% endif -%}
{%- endfor %}
  }
}

{% for row in sparql_results -%}
{%- if row["?provider"] == "oci" %}
provider "oci" {
  region = var.oci_region
}
{% endif -%}
{%- endfor %}

{% for row in sparql_results -%}
{%- set resource_name = row["?resourceName"] -%}
{%- set provider = row["?provider"] -%}
{%- set shape = row["?shape"] | default(value="VM.Standard.A1.Flex") -%}
{%- set cpus = row["?cpus"] | default(value="2") -%}
{%- set memory_gb = row["?memoryGB"] | default(value="12") -%}
{%- set os_image = row["?osImage"] | default(value="Oracle-Linux-8.8-aarch64") -%}

{% if provider == "oci" %}
resource "oci_core_instance" "{{ resource_name | replace(from="-", to="_") }}" {
  availability_domain = data.oci_identity_availability_domain.ad.name
  compartment_id      = var.compartment_id
  display_name        = "{{ resource_name }}"
  shape               = "{{ shape }}"

  shape_config {
    ocpus         = {{ cpus }}
    memory_in_gbs = {{ memory_gb }}
  }

  source_details {
    source_type = "image"
    source_id   = data.oci_core_images.{{ os_image | replace(from="-", to="_") | replace(from=".", to="_") }}.images[0].id
  }

  create_vnic_details {
    subnet_id        = oci_core_subnet.public.id
    assign_public_ip = true
  }

  metadata = {
    ssh_authorized_keys = var.ssh_public_key
    user_data           = base64encode(file("${path.module}/cloud-init.yaml"))
  }
}
{% endif %}

{% endfor %}

# Data sources for latest images
{% for row in sparql_results -%}
{%- set os_image = row["?osImage"] | default(value="Oracle-Linux-8.8-aarch64") -%}
data "oci_core_images" "{{ os_image | replace(from="-", to="_") | replace(from=".", to="_") }}" {
  compartment_id           = var.compartment_id
  operating_system         = "Oracle Linux"
  operating_system_version = "8.8"
  shape                    = "{{ row["?shape"] | default(value="VM.Standard.A1.Flex") }}"
  sort_by                  = "TIMECREATED"
  sort_order               = "DESC"
}
{% endfor %}

data "oci_identity_availability_domain" "ad" {
  compartment_id = var.compartment_id
  ad_number      = 1
}
