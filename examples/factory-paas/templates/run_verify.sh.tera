#!/usr/bin/env bash
# Generated World Closure: VERIFY - DO NOT EDIT
#
# This file is automatically generated by ggen from ontology/
# To make changes, edit the ontology and run: ggen sync

set -euo pipefail

PROJECT_NAME="{{ sparql_results[0]["?contextName"] | default(value="attribution") }}"
SERVICE_PORT="{{ sparql_results[0]["?servicePort"] | default(value="8080") }}"

echo "üß™ TCPS: Verifying {{ sparql_results[0]["?contextName"] | default(value="Attribution") }} World"

EXIT_CODE=0

# Check if service is running
echo "1Ô∏è‚É£ Checking if service is running..."
PID_FILE="/tmp/${PROJECT_NAME}.pid"
if [ -f "$PID_FILE" ] && ps -p $(cat "$PID_FILE") > /dev/null 2>&1; then
    echo "   ‚úÖ Service is running"
else
    echo "   ‚ùå Service is not running"
    EXIT_CODE=1
fi

# Check if port is listening
echo "2Ô∏è‚É£ Checking if port ${SERVICE_PORT} is listening..."
if command -v lsof &> /dev/null; then
    if lsof -i :${SERVICE_PORT} > /dev/null 2>&1; then
        echo "   ‚úÖ Port ${SERVICE_PORT} is listening"
    else
        echo "   ‚ùå Port ${SERVICE_PORT} is not listening"
        EXIT_CODE=1
    fi
else
    echo "   ‚ö†Ô∏è  lsof not available, skipping port check"
fi

# Run generated tests
echo "3Ô∏è‚É£ Running generated tests..."
cd "$(dirname "$0")/.."
if cargo test --manifest-path world/Cargo.toml; then
    echo "   ‚úÖ All tests passed"
else
    echo "   ‚ùå Some tests failed"
    EXIT_CODE=1
fi

# Summary
echo ""
if [ $EXIT_CODE -eq 0 ]; then
    echo "‚úÖ World verification PASSED"
else
    echo "‚ùå World verification FAILED"
fi

exit $EXIT_CODE
