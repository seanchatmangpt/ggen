# Generated GCP Monitoring Configuration - DO NOT EDIT
#
# This file is automatically generated by ggen from ontology/infra.ttl
# To make changes, edit the ontology and run: ggen sync

{% for row in sparql_results -%}
{%- set service_name = row["?serviceName"] | default(value="attribution-service") -%}

# Enable required APIs
resource "google_project_service" "monitoring_api" {
  service            = "monitoring.googleapis.com"
  disable_on_destroy = false
}

resource "google_project_service" "cloudtrace_api" {
  service            = "cloudtrace.googleapis.com"
  disable_on_destroy = false
}

resource "google_project_service" "logging_api" {
  service            = "logging.googleapis.com"
  disable_on_destroy = false
}

# Uptime check for Cloud Run service
resource "google_monitoring_uptime_check_config" "{{ service_name | replace(from="-", to="_") }}_uptime" {
  display_name = "{{ service_name }}-uptime-check"
  timeout      = "10s"
  period       = "60s"

  http_check {
    path           = "/health/ready"
    port           = 443
    use_ssl        = true
    validate_ssl   = true
    request_method = "GET"

    accepted_response_status_codes {
      status_class = "STATUS_CLASS_2XX"
    }
  }

  monitored_resource {
    type = "uptime_url"
    labels = {
      project_id = var.project_id
      host       = google_cloud_run_v2_service.{{ service_name | replace(from="-", to="_") }}.uri
    }
  }

  content_matchers {
    content = "healthy"
    matcher = "CONTAINS_STRING"
  }

  checker_type = "STATIC_IP_CHECKERS"

  selected_regions = [
    "USA",
    "EUROPE",
    "ASIA_PACIFIC"
  ]
}

# Alert policy for service availability
resource "google_monitoring_alert_policy" "{{ service_name | replace(from="-", to="_") }}_availability" {
  display_name = "{{ service_name }} - Service Availability"
  combiner     = "OR"

  conditions {
    display_name = "Uptime check failed"

    condition_threshold {
      filter          = "resource.type = \"uptime_url\" AND metric.type = \"monitoring.googleapis.com/uptime_check/check_passed\" AND resource.labels.check_id = \"${google_monitoring_uptime_check_config.{{ service_name | replace(from="-", to="_") }}_uptime.uptime_check_id}\""
      duration        = "60s"
      comparison      = "COMPARISON_LT"
      threshold_value = 1

      aggregations {
        alignment_period   = "60s"
        per_series_aligner = "ALIGN_NEXT_OLDER"
      }
    }
  }

  notification_channels = [
    google_monitoring_notification_channel.email.id,
    google_monitoring_notification_channel.slack.id,
  ]

  alert_strategy {
    auto_close = "1800s"

    notification_rate_limit {
      period = "300s"
    }
  }

  user_labels = {
    severity    = "critical"
    environment = var.environment
  }
}

# Alert policy for high error rate
resource "google_monitoring_alert_policy" "{{ service_name | replace(from="-", to="_") }}_error_rate" {
  display_name = "{{ service_name }} - High Error Rate"
  combiner     = "OR"

  conditions {
    display_name = "5xx error rate > 5%"

    condition_threshold {
      filter = <<-EOT
        resource.type = "cloud_run_revision"
        AND resource.labels.service_name = "{{ service_name }}"
        AND metric.type = "run.googleapis.com/request_count"
        AND metric.labels.response_code_class = "5xx"
      EOT

      duration        = "300s"
      comparison      = "COMPARISON_GT"
      threshold_value = 0.05

      aggregations {
        alignment_period     = "60s"
        per_series_aligner   = "ALIGN_RATE"
        cross_series_reducer = "REDUCE_SUM"
        group_by_fields      = ["resource.service_name"]
      }
    }
  }

  notification_channels = [
    google_monitoring_notification_channel.email.id,
    google_monitoring_notification_channel.slack.id,
  ]

  user_labels = {
    severity    = "high"
    environment = var.environment
  }
}

# Alert policy for high latency
resource "google_monitoring_alert_policy" "{{ service_name | replace(from="-", to="_") }}_latency" {
  display_name = "{{ service_name }} - High Latency"
  combiner     = "OR"

  conditions {
    display_name = "P95 latency > 1000ms"

    condition_threshold {
      filter = <<-EOT
        resource.type = "cloud_run_revision"
        AND resource.labels.service_name = "{{ service_name }}"
        AND metric.type = "run.googleapis.com/request_latencies"
      EOT

      duration        = "300s"
      comparison      = "COMPARISON_GT"
      threshold_value = 1000

      aggregations {
        alignment_period     = "60s"
        per_series_aligner   = "ALIGN_DELTA"
        cross_series_reducer = "REDUCE_PERCENTILE_95"
        group_by_fields      = ["resource.service_name"]
      }
    }
  }

  notification_channels = [
    google_monitoring_notification_channel.email.id,
  ]

  user_labels = {
    severity    = "warning"
    environment = var.environment
  }
}

# Alert policy for Cloud SQL high connection count
resource "google_monitoring_alert_policy" "{{ service_name | replace(from="-", to="_") }}_db_connections" {
  display_name = "{{ service_name }} - High Database Connection Count"
  combiner     = "OR"

  conditions {
    display_name = "Connection count > 150"

    condition_threshold {
      filter = <<-EOT
        resource.type = "cloudsql_database"
        AND metric.type = "cloudsql.googleapis.com/database/postgresql/num_backends"
      EOT

      duration        = "180s"
      comparison      = "COMPARISON_GT"
      threshold_value = 150

      aggregations {
        alignment_period   = "60s"
        per_series_aligner = "ALIGN_MEAN"
      }
    }
  }

  notification_channels = [
    google_monitoring_notification_channel.email.id,
  ]

  user_labels = {
    severity    = "warning"
    environment = var.environment
  }
}

# Alert policy for Cloud SQL disk utilization
resource "google_monitoring_alert_policy" "{{ service_name | replace(from="-", to="_") }}_db_disk" {
  display_name = "{{ service_name }} - Database Disk Usage High"
  combiner     = "OR"

  conditions {
    display_name = "Disk utilization > 80%"

    condition_threshold {
      filter = <<-EOT
        resource.type = "cloudsql_database"
        AND metric.type = "cloudsql.googleapis.com/database/disk/utilization"
      EOT

      duration        = "300s"
      comparison      = "COMPARISON_GT"
      threshold_value = 0.80

      aggregations {
        alignment_period   = "60s"
        per_series_aligner = "ALIGN_MEAN"
      }
    }
  }

  notification_channels = [
    google_monitoring_notification_channel.email.id,
    google_monitoring_notification_channel.slack.id,
  ]

  user_labels = {
    severity    = "high"
    environment = var.environment
  }
}

# Custom dashboard for service monitoring
resource "google_monitoring_dashboard" "{{ service_name | replace(from="-", to="_") }}_dashboard" {
  dashboard_json = jsonencode({
    displayName = "{{ service_name }} - Production Dashboard"

    mosaicLayout = {
      columns = 12

      tiles = [
        {
          width  = 6
          height = 4
          widget = {
            title = "Request Rate"
            xyChart = {
              dataSets = [{
                timeSeriesQuery = {
                  timeSeriesFilter = {
                    filter = "resource.type = \"cloud_run_revision\" AND resource.labels.service_name = \"{{ service_name }}\" AND metric.type = \"run.googleapis.com/request_count\""
                    aggregation = {
                      alignmentPeriod    = "60s"
                      perSeriesAligner   = "ALIGN_RATE"
                      crossSeriesReducer = "REDUCE_SUM"
                    }
                  }
                }
              }]
              yAxis = {
                label = "Requests/sec"
                scale = "LINEAR"
              }
            }
          }
        },
        {
          xPos   = 6
          width  = 6
          height = 4
          widget = {
            title = "Response Latency (P50, P95, P99)"
            xyChart = {
              dataSets = [
                {
                  timeSeriesQuery = {
                    timeSeriesFilter = {
                      filter = "resource.type = \"cloud_run_revision\" AND resource.labels.service_name = \"{{ service_name }}\" AND metric.type = \"run.googleapis.com/request_latencies\""
                      aggregation = {
                        alignmentPeriod    = "60s"
                        perSeriesAligner   = "ALIGN_DELTA"
                        crossSeriesReducer = "REDUCE_PERCENTILE_50"
                      }
                    }
                  }
                  plotType = "LINE"
                  targetAxis = "Y1"
                },
                {
                  timeSeriesQuery = {
                    timeSeriesFilter = {
                      filter = "resource.type = \"cloud_run_revision\" AND resource.labels.service_name = \"{{ service_name }}\" AND metric.type = \"run.googleapis.com/request_latencies\""
                      aggregation = {
                        alignmentPeriod    = "60s"
                        perSeriesAligner   = "ALIGN_DELTA"
                        crossSeriesReducer = "REDUCE_PERCENTILE_95"
                      }
                    }
                  }
                  plotType = "LINE"
                  targetAxis = "Y1"
                },
                {
                  timeSeriesQuery = {
                    timeSeriesFilter = {
                      filter = "resource.type = \"cloud_run_revision\" AND resource.labels.service_name = \"{{ service_name }}\" AND metric.type = \"run.googleapis.com/request_latencies\""
                      aggregation = {
                        alignmentPeriod    = "60s"
                        perSeriesAligner   = "ALIGN_DELTA"
                        crossSeriesReducer = "REDUCE_PERCENTILE_99"
                      }
                    }
                  }
                  plotType = "LINE"
                  targetAxis = "Y1"
                }
              ]
              yAxis = {
                label = "Latency (ms)"
                scale = "LINEAR"
              }
            }
          }
        },
        {
          yPos   = 4
          width  = 6
          height = 4
          widget = {
            title = "Error Rate by Code"
            xyChart = {
              dataSets = [{
                timeSeriesQuery = {
                  timeSeriesFilter = {
                    filter = "resource.type = \"cloud_run_revision\" AND resource.labels.service_name = \"{{ service_name }}\" AND metric.type = \"run.googleapis.com/request_count\""
                    aggregation = {
                      alignmentPeriod    = "60s"
                      perSeriesAligner   = "ALIGN_RATE"
                      crossSeriesReducer = "REDUCE_SUM"
                      groupByFields      = ["metric.response_code_class"]
                    }
                  }
                }
              }]
            }
          }
        },
        {
          xPos   = 6
          yPos   = 4
          width  = 6
          height = 4
          widget = {
            title = "Database Connections"
            xyChart = {
              dataSets = [{
                timeSeriesQuery = {
                  timeSeriesFilter = {
                    filter = "resource.type = \"cloudsql_database\" AND metric.type = \"cloudsql.googleapis.com/database/postgresql/num_backends\""
                    aggregation = {
                      alignmentPeriod  = "60s"
                      perSeriesAligner = "ALIGN_MEAN"
                    }
                  }
                }
              }]
            }
          }
        }
      ]
    }
  })
}

{% endfor %}

# Notification channels
resource "google_monitoring_notification_channel" "email" {
  display_name = "Email Notifications"
  type         = "email"

  labels = {
    email_address = var.alert_email
  }
}

resource "google_monitoring_notification_channel" "slack" {
  display_name = "Slack Notifications"
  type         = "slack"

  labels = {
    channel_name = var.slack_channel
  }

  sensitive_labels {
    auth_token = var.slack_webhook_url
  }
}

# Log-based metrics for custom application metrics
resource "google_logging_metric" "attribution_events_processed" {
  name   = "attribution_events_processed"
  filter = "resource.type=\"cloud_run_revision\" AND jsonPayload.event_type=\"attribution_computed\""

  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
    unit        = "1"

    labels {
      key         = "campaign_id"
      value_type  = "STRING"
      description = "Campaign ID"
    }
  }

  label_extractors = {
    "campaign_id" = "EXTRACT(jsonPayload.campaign_id)"
  }
}

# Log sink for long-term storage
resource "google_logging_project_sink" "attribution_logs" {
  name        = "attribution-logs-sink"
  destination = "storage.googleapis.com/${google_storage_bucket.log_archive.name}"

  filter = <<-EOT
    resource.type = "cloud_run_revision"
    AND resource.labels.service_name = "attribution-service"
    AND severity >= "INFO"
  EOT

  unique_writer_identity = true
}

# Log archive bucket
resource "google_storage_bucket" "log_archive" {
  name          = "${var.project_id}-attribution-logs"
  location      = var.region
  storage_class = "STANDARD"

  uniform_bucket_level_access = true

  lifecycle_rule {
    condition {
      age = 30
    }
    action {
      type          = "SetStorageClass"
      storage_class = "NEARLINE"
    }
  }

  lifecycle_rule {
    condition {
      age = 365
    }
    action {
      type = "Delete"
    }
  }
}

# Grant log sink permission to write to bucket
resource "google_storage_bucket_iam_member" "log_sink_writer" {
  bucket = google_storage_bucket.log_archive.name
  role   = "roles/storage.objectCreator"
  member = google_logging_project_sink.attribution_logs.writer_identity
}
