#!/usr/bin/env node

/**
 * @fileoverview YAWL Workflow Platform Entry Point
 * DO NOT EDIT - auto-generated by ggen sync
 * @module main
 */

import { createWorkflowEngine } from './engine/WorkflowEngine.mjs';
import { taskRegistry } from './definitions/tasks.mjs';
import { flowRegistry } from './definitions/flows.mjs';
import { WORKFLOW_INDEX } from './definitions/index.mjs';
import { workletRegistry } from './worklets/index.mjs';
import { ROUTES, configureRouter } from './api/routes.mjs';
import { receiptChain } from './types/receipts.mjs';

// =============================================================================
// Configuration
// =============================================================================

const config = {
  port: parseInt(process.env.PORT || '3000', 10),
  host: process.env.HOST || '0.0.0.0',
  nodeEnv: process.env.NODE_ENV || 'development',
  enableReceipts: process.env.ENABLE_RECEIPTS !== 'false',
  logLevel: process.env.LOG_LEVEL || 'info',
};

// =============================================================================
// Platform Initialization
// =============================================================================

/**
 * Initialize the YAWL workflow platform
 * @returns {Promise<object>} Platform instance
 */
export async function initializePlatform() {
  console.log('Initializing YAWL Workflow Platform...');

  // Create workflow engine
  const engine = createWorkflowEngine(taskRegistry, flowRegistry);

  // Register worklet handlers
  const exceptionHandlers = workletRegistry.getAllExceptionHandlers();
  console.log(`Registered ${exceptionHandlers.length} exception handlers`);

  // Log available workflows
  console.log(`Available workflows: ${WORKFLOW_INDEX.length}`);
  for (const workflow of WORKFLOW_INDEX) {
    console.log(`  - ${workflow.specId}: ${workflow.taskCount} tasks, ${workflow.flowCount} flows`);
  }

  return {
    engine,
    taskRegistry,
    flowRegistry,
    workletRegistry,
    receiptChain: config.enableReceipts ? receiptChain : null,
    config,
  };
}

// =============================================================================
// Express Application Factory
// =============================================================================

/**
 * Create Express application with YAWL routes
 * @param {object} platform - Platform instance from initializePlatform
 * @returns {object} Express app
 */
export async function createApp(platform) {
  // Dynamic import for Express (optional dependency)
  const { default: express } = await import('express');

  const app = express();

  // Middleware
  app.use(express.json());

  // Health check
  app.get('/health', (req, res) => {
    res.json({
      status: 'healthy',
      workflows: WORKFLOW_INDEX.length,
      routes: ROUTES.length,
      receipts: platform.receiptChain?.length || 0,
    });
  });

  // Create API router with handlers
  const router = express.Router();
  const handlers = createHandlers(platform);
  configureRouter(router, handlers);
  app.use(router);

  // Error handler
  app.use((err, req, res, next) => {
    console.error('Error:', err.message);
    res.status(500).json({ error: err.message });
  });

  return app;
}

// =============================================================================
// Route Handlers
// =============================================================================

/**
 * Create route handlers for all servlets
 * @param {object} platform - Platform instance
 * @returns {object} Handler map
 */
function createHandlers(platform) {
  const { engine, taskRegistry, flowRegistry, workletRegistry, receiptChain } = platform;

  return {
    // Workflow handlers
    'workflow-create': async (req, res) => {
      const { specId, name, version } = req.body;
      res.json({ workflowId: crypto.randomUUID(), specId, status: 'created' });
    },

    'workflow-list': async (req, res) => {
      res.json(WORKFLOW_INDEX);
    },

    'workflow-get': async (req, res) => {
      const workflow = WORKFLOW_INDEX.find(w => w.specId === req.params.id);
      if (!workflow) return res.status(404).json({ error: 'Workflow not found' });
      res.json(workflow);
    },

    // Case handlers
    'case-create': async (req, res) => {
      const { workflowId, initialData } = req.body;
      const result = engine.createCase(workflowId, initialData || {});

      if (receiptChain) {
        receiptChain.addReceipt({
          eventType: 'case_created',
          caseId: result.caseId,
          eventData: { workflowId, initialData },
        });
      }

      res.json(result);
    },

    'case-list': async (req, res) => {
      // In production, query RDF store
      res.json([]);
    },

    'case-get': async (req, res) => {
      const caseInstance = engine.getCase(req.params.id);
      if (!caseInstance) return res.status(404).json({ error: 'Case not found' });
      res.json(caseInstance);
    },

    'case-cancel': async (req, res) => {
      const caseInstance = engine.getCase(req.params.id);
      if (!caseInstance) return res.status(404).json({ error: 'Case not found' });

      caseInstance.status = 'cancelled';

      if (receiptChain) {
        receiptChain.addReceipt({
          eventType: 'case_cancelled',
          caseId: req.params.id,
        });
      }

      res.json({ caseId: req.params.id, status: 'cancelled' });
    },

    // Task handlers
    'task-enable': async (req, res) => {
      res.json({ taskId: req.params.taskId, status: 'enabled' });
    },

    'task-start': async (req, res) => {
      if (receiptChain) {
        receiptChain.addReceipt({
          eventType: 'workitem_started',
          taskId: req.params.taskId,
        });
      }
      res.json({ taskId: req.params.taskId, status: 'started' });
    },

    'task-complete': async (req, res) => {
      const { outputData } = req.body;

      if (receiptChain) {
        receiptChain.addReceipt({
          eventType: 'workitem_completed',
          taskId: req.params.taskId,
          eventData: { outputData },
        });
      }

      res.json({ taskId: req.params.taskId, status: 'completed' });
    },

    'workitem-list': async (req, res) => {
      res.json([]);
    },

    // Admin handlers
    'admin-metrics': async (req, res) => {
      res.json({
        activeCases: 0,
        completedCases: 0,
        totalWorkItems: 0,
        receipts: receiptChain?.length || 0,
        workflowCount: WORKFLOW_INDEX.length,
        uptime: process.uptime(),
      });
    },

    'admin-replay': async (req, res) => {
      const { toTimestamp } = req.body;
      // In production, implement time-travel replay
      res.json({ caseId: req.params.id, status: 'replayed', toTimestamp });
    },
  };
}

// =============================================================================
// Server Startup
// =============================================================================

/**
 * Start the YAWL platform server
 */
export async function startServer() {
  try {
    const platform = await initializePlatform();
    const app = await createApp(platform);

    app.listen(config.port, config.host, () => {
      console.log(`\nYAWL Workflow Platform running at http://${config.host}:${config.port}`);
      console.log(`Environment: ${config.nodeEnv}`);
      console.log(`Receipts: ${config.enableReceipts ? 'enabled' : 'disabled'}`);
      console.log('\nEndpoints:');
      console.log('  GET  /health              - Health check');
      console.log('  GET  /api/workflows       - List workflows');
      console.log('  POST /api/workflows       - Create workflow');
      console.log('  POST /api/cases           - Create case');
      console.log('  GET  /api/admin/metrics   - Platform metrics');
    });
  } catch (error) {
    console.error('Failed to start server:', error);
    process.exit(1);
  }
}

// =============================================================================
// CLI Entry Point
// =============================================================================

// Run if executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
  startServer();
}
