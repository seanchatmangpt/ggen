version: '3.8'

services:
  # Message Queue (Kanban)
  nats:
    image: nats:2.10-alpine
    container_name: tai-nats
    ports:
      - "4222:4222"     # NATS client port
      - "8222:8222"     # NATS HTTP monitoring
    environment:
      - NATS_CONFIG_FILE=/etc/nats/nats.conf
    volumes:
      - ./config/nats.conf:/etc/nats/nats.conf
    networks:
      - tai-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8222/varz"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on: []

  # Cache Layer
  redis:
    image: redis:7-alpine
    container_name: tai-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - tai-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on: []

  # State Store (Firestore equivalent - using Redis for simplicity)
  state-store:
    image: redis:7-alpine
    container_name: tai-state-store
    ports:
      - "6380:6379"
    volumes:
      - state-data:/data
    networks:
      - tai-network
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on: []

  # Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: tai-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - tai-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      - nats
      - redis

  # Tracing (Jaeger)
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: tai-jaeger
    ports:
      - "5775:5775/udp"   # Zipkin compact thrift
      - "6831:6831/udp"   # Jaeger compact thrift
      - "6832:6832/udp"   # Jaeger binary thrift
      - "5778:5778"       # HTTP
      - "16686:16686"     # UI
      - "14268:14268"     # Collector
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
    networks:
      - tai-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:14268/api/traces"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on: []

  # Visualization & Dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: tai-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - ./config/grafana/provisioning:/etc/grafana/provisioning
      - grafana-data:/var/lib/grafana
    networks:
      - tai-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      - prometheus
      - jaeger

  # Secrets Management
  vault:
    image: vault:latest
    container_name: tai-vault
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=dev-token
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    networks:
      - tai-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8200/v1/sys/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on: []

  # TAI Payment System
  payment-system:
    build:
      context: ./payment-system
      dockerfile: Dockerfile
    container_name: tai-payment-system
    ports:
      - "3001:3000"  # Payment service
    environment:
      - RUST_LOG=debug
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis://redis:6379
      - STATE_STORE_URL=redis://state-store:6379
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - PROMETHEUS_PUSHGATEWAY_URL=http://prometheus:9090
    networks:
      - tai-network
    depends_on:
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
      jaeger:
        condition: service_healthy
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # TAI Deployment System
  deployment-system:
    build:
      context: ./deployment-system
      dockerfile: Dockerfile
    container_name: tai-deployment-system
    ports:
      - "3002:3000"  # Deployment service
    environment:
      - RUST_LOG=debug
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis://redis:6379
      - STATE_STORE_URL=redis://state-store:6379
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - PROMETHEUS_PUSHGATEWAY_URL=http://prometheus:9090
    networks:
      - tai-network
    depends_on:
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
      jaeger:
        condition: service_healthy
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Log Aggregation (optional)
  loki:
    image: grafana/loki:latest
    container_name: tai-loki
    ports:
      - "3100:3100"
    volumes:
      - ./config/loki-config.yml:/etc/loki/local-config.yml
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yml
    networks:
      - tai-network
    depends_on: []

networks:
  tai-network:
    driver: bridge

volumes:
  redis-data:
  state-data:
  prometheus-data:
  grafana-data:
  loki-data:
