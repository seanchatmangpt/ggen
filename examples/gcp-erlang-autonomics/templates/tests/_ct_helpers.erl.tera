{% include "_header.erl.tera" %}

%%% -------------------------------------------------------------------
%%% AUTOGENERATED TEST HELPERS — PRODUCTION BLACK-BOX
%%% Real HTTP client (hackney) — no backdoors, no mocks
%%% -------------------------------------------------------------------
-module({{ module_prefix }}_ct_helpers).
-export([
  service_url/1,
  tenant_id/1,
  timeout_ms/1,
  post_json/4,
  get/3,
  pubsub_envelope/4,
  marketplace_event/2,
  b64/1,
  json/1
]).

-define(DEFAULT_TIMEOUT, 6000).
-define(DEFAULT_TENANT, <<"tenant_adversarial_ct">>).

%% service_url/1: Extract service URL from config
service_url(Config) ->
  case proplists:get_value(autonomics, Config) of
    L when is_list(L) ->
      case proplists:get_value(service_url, L, "") of
        "" ->
          error({missing_service_url, set_SERVICE_URL_env_var});
        U ->
          U
      end;
    _ ->
      error({missing_ct_config, autonomics})
  end.

%% tenant_id/1: Extract test tenant from config
tenant_id(Config) ->
  proplists:get_value(
    tenant_id,
    proplists:get_value(autonomics, Config, []),
    ?DEFAULT_TENANT
  ).

%% timeout_ms/1: Extract timeout from config
timeout_ms(Config) ->
  proplists:get_value(
    timeout_ms,
    proplists:get_value(autonomics, Config, []),
    ?DEFAULT_TIMEOUT
  ).

%% json/1: Encode map to JSON
json(Map) ->
  jiffy:encode(Map).

%% b64/1: Base64 encode binary or string
b64(Bin) when is_binary(Bin) ->
  base64:encode(Bin);
b64(List) when is_list(List) ->
  base64:encode(list_to_binary(List)).

%% get/3: HTTP GET with timeout
%% Returns: {ok, Status, Headers, Body} | {error, Reason}
get(Url, Headers, TimeoutMs) ->
  Opts = [
    {connect_timeout, TimeoutMs},
    {recv_timeout, TimeoutMs}
  ],
  case hackney:request(get, Url, Headers, <<>>, Opts) of
    {ok, Status, RespHeaders, Ref} ->
      {ok, Body} = hackney:body(Ref),
      {ok, Status, RespHeaders, Body};
    {error, Why} ->
      {error, Why}
  end.

%% post_json/4: HTTP POST with JSON body
%% Returns: {ok, Status, Headers, Body} | {error, Reason}
post_json(Url, Headers, Map, TimeoutMs) ->
  Body = jiffy:encode(Map),
  H2 = Headers ++ [{<<"content-type">>, <<"application/json">>}],
  Opts = [
    {connect_timeout, TimeoutMs},
    {recv_timeout, TimeoutMs}
  ],
  case hackney:request(post, Url, H2, Body, Opts) of
    {ok, Status, RespHeaders, Ref} ->
      {ok, RespBody} = hackney:body(Ref),
      {ok, Status, RespHeaders, RespBody};
    {error, Why} ->
      {error, Why}
  end.

%% pubsub_envelope/4: Create GCP Pub/Sub push envelope
%% {
%%   "message": {
%%     "attributes": {
%%       "tenant_id": "...",
%%       "source": "...",
%%       "name": "..."
%%     },
%%     "data": "base64-encoded-payload"
%%   }
%% }
pubsub_envelope(TenantIdBin, SourceBin, NameBin, PayloadMap) ->
  PayloadBin = jiffy:encode(PayloadMap),
  #{
    <<"message">> => #{
      <<"attributes">> => #{
        <<"tenant_id">> => TenantIdBin,
        <<"source">> => SourceBin,
        <<"name">> => NameBin
      },
      <<"data">> => base64:encode(PayloadBin)
    }
  }.

%% marketplace_event/2: Create Marketplace entitlement event
marketplace_event(TenantIdBin, ActionBin) ->
  #{
    <<"tenant_id">> => TenantIdBin,
    <<"action">> => ActionBin
  }.
