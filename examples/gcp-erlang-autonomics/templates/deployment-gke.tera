{% comment %}
Kubernetes Deployment Template
Generates Kubernetes manifests for Governor autonomic services on GKE.
Input: ggen.toml configuration + SPARQL infrastructure query results
Output: YAML manifests (Deployment, Service, ConfigMap, HPA, RBAC)

Manifest sections:
  1. Namespace
  2. ServiceAccount + RBAC (Workload Identity)
  3. ConfigMap (Policy packs, scaling rules)
  4. Deployment (Governor controller)
  5. Service (Internal networking)
  6. HorizontalPodAutoscaler (Auto-scaling policies)
  7. NetworkPolicy (Isolation)
  8. PodDisruptionBudget (High availability)

Variables:
  - kubernetes.namespace: Target namespace
  - kubernetes.image_registry: Container image registry
  - gcp.project_id: GCP project ID
  - gcp.region: Primary region
{% endcomment %}

---
# Kubernetes Manifests for Governor Autonomic Services
# Generated by ggen (Specification-Driven Code Generation)
# Date: {{ now() | date(format="%Y-%m-%d %H:%M:%S UTC") }}
# Version: 1.0.0

# 1. NAMESPACE
# Define the Kubernetes namespace for all Governor resources
---
apiVersion: v1
kind: Namespace
metadata:
  name: {{ kubernetes.namespace | default(value="autonomic-system") }}
  labels:
    name: {{ kubernetes.namespace | default(value="autonomic-system") }}
    managed-by: ggen
    version: "1.0.0"
  annotations:
    description: "Autonomic Governor system namespace"
    gcp-project: "{{ gcp.project_id }}"

# 2. SERVICE ACCOUNT & WORKLOAD IDENTITY
# Enable Workload Identity for secure GCP API access
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: governor-sa
  namespace: {{ kubernetes.namespace | default(value="autonomic-system") }}
  labels:
    app: governor
    tier: control-plane
  annotations:
    iam.gke.io/gcp-service-account: "governor@{{ gcp.project_id }}.iam.gserviceaccount.com"

# 3. ROLE-BASED ACCESS CONTROL (RBAC)
# Grant Governor permissions to manage cluster resources
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: governor-controller
  labels:
    app: governor
rules:
  # Read pod metrics and status
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
  # Scale deployments
  - apiGroups: ["apps"]
    resources: ["deployments", "deployments/scale"]
    verbs: ["get", "list", "watch", "patch", "update"]
  # Manage replica sets
  - apiGroups: ["apps"]
    resources: ["replicasets", "replicasets/scale"]
    verbs: ["get", "list", "watch", "patch", "update"]
  # Monitor services
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list", "watch"]
  # Access ConfigMaps (policy packs)
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]
  # Create/read events
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch", "list", "watch"]
  # Read metrics from custom metrics API
  - apiGroups: ["custom.metrics.k8s.io"]
    resources: ["*"]
    verbs: ["*"]
  # Read HPA status
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: governor-controller-binding
  labels:
    app: governor
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: governor-controller
subjects:
  - kind: ServiceAccount
    name: governor-sa
    namespace: {{ kubernetes.namespace | default(value="autonomic-system") }}

# 4. CONFIGMAP: POLICY PACKS
# Define autonomic decision policies for Governor
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: governor-policy
  namespace: {{ kubernetes.namespace | default(value="autonomic-system") }}
  labels:
    app: governor
    component: policy
data:
  policy.yaml: |
    # Governor Policy Pack Configuration
    # Defines signals, thresholds, and corrective actions

    version: "1.0.0"
    policies:
      - name: "cpu-autoscale-policy"
        type: "reactive"
        enabled: true
        signals:
          - type: "cpu-utilization"
            metric: "container_cpu_usage_seconds_total"
            threshold: 0.75
            window: "2m"
            comparison: "greater-than"
        actions:
          - type: "scale-up"
            target: "deployment"
            increment: 1
            max-replicas: 10
            cooldown: "2m"

      - name: "memory-pressure-policy"
        type: "reactive"
        enabled: true
        signals:
          - type: "memory-utilization"
            metric: "container_memory_usage_bytes"
            threshold: 0.8
            window: "2m"
            comparison: "greater-than"
        actions:
          - type: "evict-and-reschedule"
            target: "pod"
            grace-period: "30s"
          - type: "scale-up"
            target: "deployment"
            increment: 1
            max-replicas: 10

      - name: "latency-slo-policy"
        type: "predictive"
        enabled: true
        signals:
          - type: "request-latency-p99"
            metric: "http_request_duration_seconds"
            threshold: 0.5
            window: "1m"
            comparison: "greater-than"
        actions:
          - type: "scale-up"
            target: "deployment"
            increment: 2
            max-replicas: 10
            cooldown: "1m"

      - name: "error-rate-policy"
        type: "reactive"
        enabled: true
        signals:
          - type: "error-rate"
            metric: "http_requests_total"
            threshold: 0.01
            window: "1m"
            comparison: "greater-than"
        actions:
          - type: "circuit-break"
            duration: "1m"
            failure-threshold: 5
          - type: "restart-pod"
            target: "pod"
            strategy: "rolling"
            grace-period: "30s"

# 5. CONFIGMAP: SCALING RULES
# Granular auto-scaling thresholds and parameters
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: governor-scaling-rules
  namespace: {{ kubernetes.namespace | default(value="autonomic-system") }}
  labels:
    app: governor
    component: scaling
data:
  scaling-rules.yaml: |
    scaling_policies:
      conservative:
        cpu_threshold: 0.80
        memory_threshold: 0.85
        scale_up_cooldown: 5m
        scale_down_cooldown: 10m
        min_replicas: 2
        max_replicas: 5
      standard:
        cpu_threshold: 0.75
        memory_threshold: 0.80
        scale_up_cooldown: 2m
        scale_down_cooldown: 5m
        min_replicas: 2
        max_replicas: 10
      aggressive:
        cpu_threshold: 0.70
        memory_threshold: 0.75
        scale_up_cooldown: 1m
        scale_down_cooldown: 3m
        min_replicas: 3
        max_replicas: 20

# 6. DEPLOYMENT: GOVERNOR CONTROLLER
# Main autonomic governor service
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: governor
  namespace: {{ kubernetes.namespace | default(value="autonomic-system") }}
  labels:
    app: governor
    component: controller
    version: "1.0.0"
  annotations:
    description: "Erlang-based autonomic governor for GCP workloads"
spec:
  replicas: {{ kubernetes.replicas | default(value=2) }}

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  selector:
    matchLabels:
      app: governor
      component: controller

  template:
    metadata:
      labels:
        app: governor
        component: controller
        version: "1.0.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"

    spec:
      serviceAccountName: governor-sa

      # Security context for the pod
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
        seccompProfile:
          type: RuntimeDefault

      # Init container: Verify Workload Identity setup
      initContainers:
        - name: workload-identity-check
          image: "{{ kubernetes.image_registry }}/google-cloud-cli:latest"
          command:
            - /bin/sh
            - -c
            - |
              echo "Checking Workload Identity binding..."
              curl -H "Metadata-Flavor: Google" \
                http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity \
                > /dev/null || exit 1
              echo "Workload Identity verified"
          resources:
            requests:
              cpu: 100m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi

      containers:
        - name: governor
          image: "{{ kubernetes.image_registry }}/governor:1.0.0"
          imagePullPolicy: {{ kubernetes.image_pull_policy | default(value="IfNotPresent") }}

          # Container ports
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: metrics
              containerPort: 8081
              protocol: TCP
            - name: health
              containerPort: 8082
              protocol: TCP

          # Environment variables
          env:
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: CLUSTER_NAME
              value: "{{ gcp.cluster_name | default(value='gken-primary') }}"
            - name: GCP_PROJECT_ID
              value: "{{ gcp.project_id }}"
            - name: GCP_REGION
              value: "{{ gcp.region }}"
            - name: POLICY_CONFIG
              value: "/etc/governor/policy.yaml"
            - name: SCALING_RULES_CONFIG
              value: "/etc/governor/scaling-rules.yaml"
            - name: LOG_LEVEL
              value: "{{ observability.log_level | default(value='info') }}"
            - name: JSON_LOGGING
              value: "{{ observability.json_logging | default(value='true') }}"

          # Mount policy config
          volumeMounts:
            - name: policy-volume
              mountPath: /etc/governor
              readOnly: true
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /var/cache/governor

          # Resource requests and limits
          resources:
            requests:
              cpu: "{{ kubernetes.cpu_request | default(value='250m') }}"
              memory: "{{ kubernetes.memory_request | default(value='256Mi') }}"
            limits:
              cpu: "{{ kubernetes.cpu_limit | default(value='500m') }}"
              memory: "{{ kubernetes.memory_limit | default(value='512Mi') }}"

          # Security context for container
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL

          # Liveness probe: Check if Governor is running
          livenessProbe:
            httpGet:
              path: /health/live
              port: health
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          # Readiness probe: Check if Governor is ready for traffic
          readinessProbe:
            httpGet:
              path: /health/ready
              port: health
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 2

          # Startup probe: Give container time to initialize
          startupProbe:
            httpGet:
              path: /health/startup
              port: health
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 30

      # Volumes
      volumes:
        - name: policy-volume
          configMap:
            name: governor-policy
        - name: tmp
          emptyDir:
            sizeLimit: 1Gi
        - name: cache
          emptyDir:
            sizeLimit: 2Gi

      # Pod placement and affinity
      affinity:
        # Pod anti-affinity: Spread replicas across nodes
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - governor
                topologyKey: kubernetes.io/hostname

        # Node affinity: Prefer specific node pools
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 50
              preference:
                matchExpressions:
                  - key: cloud.google.com/gke-nodepool
                    operator: In
                    values:
                      - "control-plane"

      # Tolerations for specific node taints
      tolerations:
        - key: "control-plane"
          operator: "Equal"
          value: "true"
          effect: "NoSchedule"

      # Termination grace period
      terminationGracePeriodSeconds: 60

# 7. SERVICE: INTERNAL SERVICE DISCOVERY
# Expose Governor within the cluster
---
apiVersion: v1
kind: Service
metadata:
  name: governor
  namespace: {{ kubernetes.namespace | default(value="autonomic-system") }}
  labels:
    app: governor
    component: controller
  annotations:
    cloud.google.com/neg: '{"ingress": true}'
spec:
  type: ClusterIP
  selector:
    app: governor
    component: controller
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
    - name: metrics
      port: 8081
      targetPort: 8081
      protocol: TCP
    - name: health
      port: 8082
      targetPort: 8082
      protocol: TCP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800

# 8. HORIZONTAL POD AUTOSCALER (HPA)
# Auto-scale Governor based on metrics
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: governor-hpa
  namespace: {{ kubernetes.namespace | default(value="autonomic-system") }}
  labels:
    app: governor
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: governor

  minReplicas: {{ kubernetes.min_replicas | default(value=2) }}
  maxReplicas: {{ kubernetes.max_replicas | default(value=10) }}

  metrics:
    # CPU-based scaling
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70

    # Memory-based scaling
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 75

  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 2
          periodSeconds: 30
      selectPolicy: Max

    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
      selectPolicy: Min

# 9. NETWORK POLICY: EGRESS RESTRICTIONS
# Isolate Governor traffic for security
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: governor-network-policy
  namespace: {{ kubernetes.namespace | default(value="autonomic-system") }}
  labels:
    app: governor
spec:
  podSelector:
    matchLabels:
      app: governor
  policyTypes:
    - Ingress
    - Egress

  ingress:
    # Allow traffic from within the namespace
    - from:
        - podSelector:
            matchLabels: {}
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8081
        - protocol: TCP
          port: 8082

  egress:
    # Allow DNS queries
    - to:
        - podSelector: {}
      ports:
        - protocol: UDP
          port: 53

    # Allow Kubernetes API communication
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              component: kube-apiserver
      ports:
        - protocol: TCP
          port: 443

    # Allow Google Cloud APIs (metadata service)
    - to:
        - ipBlock:
            cidr: 169.254.169.254/32
      ports:
        - protocol: TCP
          port: 80

# 10. POD DISRUPTION BUDGET (PDB)
# Ensure high availability during cluster maintenance
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: governor-pdb
  namespace: {{ kubernetes.namespace | default(value="autonomic-system") }}
  labels:
    app: governor
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: governor
      component: controller

# END OF MANIFESTS
