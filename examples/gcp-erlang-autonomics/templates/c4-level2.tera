{% comment %}
C4 Level 2: Container Diagram
Renders microservices, databases, caches, message queues, and data flows.
Input: SPARQL query results from containers query
Output: Mermaid flowchart with subgraph clustering

Container types:
  - Service: Erlang/HTTP service
  - Database: PostgreSQL, Cloud Firestore
  - Cache: Redis, Memcached
  - Queue: Pub/Sub, RabbitMQ
  - Storage: Cloud Storage, S3

Variables:
  - containers: List of containers with system, type, and dataflows
  - system_label: System name
{% endcomment %}

graph {{ mermaid_direction | default(value="LR") }}
    classDef service fill:#438dd5,stroke:#3c7fc0,color:#fff,font-size:13px
    classDef database fill:#c25c2c,stroke:#b73e1a,color:#fff,font-size:12px
    classDef cache fill:#ff9900,stroke:#ff6600,color:#fff,font-size:12px
    classDef queue fill:#9370db,stroke:#6a4c93,color:#fff,font-size:12px
    classDef storage fill:#4a90e2,stroke:#2e5c8a,color:#fff,font-size:12px

    %% Title
    T["<b>Container Diagram</b><br/>{{ system_label | default(value='GCP Erlang Autonomics') }}"]
    style T fill:#f0f0f0,stroke:#000,stroke-width:2px,font-size:15px,color:#000

    {% comment %}Organize containers by system{% endcomment %}
    {% set systems_seen = [] %}
    {% for row in containers %}
        {% if row.system_label and row.system_label not in systems_seen %}
            {% set _ = systems_seen | push(value=row.system_label) %}

    subgraph system_{{ loop.index }}["<b>{{ row.system_label }}</b>"]
        {% for container_row in containers %}
            {% if container_row.system_label == row.system_label %}
                {% if container_row.container_type == "Service" or "Service" in container_row.container_type %}
        {{ container_row.container_label | slugify }}_{{ loop.index }}["<b>{{ container_row.container_label }}</b><br/><i>Erlang Service</i>"]:::service
                {% elif container_row.container_type == "Database" or "Database" in container_row.container_type %}
        {{ container_row.container_label | slugify }}_{{ loop.index }}["<b>{{ container_row.container_label }}</b><br/><i>Relational DB</i>"]:::database
                {% elif container_row.container_type == "Cache" or "Cache" in container_row.container_type %}
        {{ container_row.container_label | slugify }}_{{ loop.index }}["<b>{{ container_row.container_label }}</b><br/><i>In-Memory Cache</i>"]:::cache
                {% elif container_row.container_type == "Queue" or "Queue" in container_row.container_type %}
        {{ container_row.container_label | slugify }}_{{ loop.index }}["<b>{{ container_row.container_label }}</b><br/><i>Message Queue</i>"]:::queue
                {% elif container_row.container_type == "Storage" or "Storage" in container_row.container_type %}
        {{ container_row.container_label | slugify }}_{{ loop.index }}["<b>{{ container_row.container_label }}</b><br/><i>Object Storage</i>"]:::storage
                {% else %}
        {{ container_row.container_label | slugify }}_{{ loop.index }}["<b>{{ container_row.container_label }}</b><br/><i>{{ container_row.container_type }}</i>"]:::service
                {% endif %}
            {% endif %}
        {% endfor %}
    end
        {% endif %}
    {% endfor %}

    {% comment %}Data flows between containers{% endcomment %}
    {% for row in containers %}
        {% if row.dataflow_label and row.target_container %}
    {{ row.container_label | slugify }} -->|{{ row.dataflow_label }}| {{ row.target_container | slugify }}
        {% endif %}
    {% endfor %}

    {% comment %}Legend{% endcomment %}
    subgraph legend["<b>Legend</b>"]
        L1["üîµ Service: Microservice (Erlang/HTTP)"]:::service
        L2["üóÑÔ∏è Database: Persistent data store"]:::database
        L3["‚ö° Cache: In-memory data layer"]:::cache
        L4["üì¨ Queue: Asynchronous messaging"]:::queue
        L5["üíæ Storage: Object/file storage"]:::storage
    end
    style legend fill:#f9f9f9,stroke:#999,stroke-width:1px
