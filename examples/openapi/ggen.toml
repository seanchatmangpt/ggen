# =============================================================================
# ggen v5 OpenAPI/JavaScript/Zod Code Generation Manifest
# Generates synchronized API contracts from RDF ontology
# Single source of truth â†’ OpenAPI + JavaScript (ES modules) + Zod
# =============================================================================

[project]
name = "openapi-codegen-example"
version = "1.0.0"
description = "Ontology-driven API contract generation with ggen sync"

[ontology]
source = "ontology/blog-api.ttl"
base_iri = "https://ggen.io/examples/blog/"
schema = "ontology/api-schema.ttl"

[ontology.prefixes]
blog = "https://ggen.io/examples/blog#"
api = "https://ggen.io/ontology/api#"
rdf = "http://www.w3.org/1999/02/22-rdf-syntax-ns#"
rdfs = "http://www.w3.org/2000/01/rdf-schema#"
xsd = "http://www.w3.org/2001/XMLSchema#"

[inference]
rules = []

[generation]
# Output directory: lib/ follows Node.js best practices for generated code
output_dir = "lib"
require_audit_trail = true

# =============================================================================
# RULE 1: OpenAPI Specification Header
# Purpose: Generates the OpenAPI info section (title, version, description) and server configuration
# Output: lib/openapi/api-info.yaml
# Query: Extracts specification metadata from the ontology
# =============================================================================
[[generation.rules]]
name = "openapi-info"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?title ?description ?version ?serverUrl ?serverDescription
WHERE {
  ?spec a api:Specification ;
        api:title ?title ;
        api:version ?version .
  OPTIONAL { ?spec api:description ?description }
  OPTIONAL {
    ?spec api:server ?server .
    ?server api:url ?serverUrl .
    OPTIONAL { ?server api:description ?serverDescription }
  }
}
LIMIT 1
""" }
template = { file = "templates/openapi-info.tera" }
output_file = "openapi/api-info.yaml"
mode = "Overwrite"

# =============================================================================
# RULE 2: OpenAPI Schemas (Components)
# Purpose: Generates all entity schemas as OpenAPI component definitions
# Output: lib/openapi/schemas.yaml
# Query: Extracts all entities and their properties with validation constraints
# =============================================================================
[[generation.rules]]
name = "openapi-schemas"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

SELECT ?entityName ?entityDescription ?propertyName ?propertyType
       ?required ?format ?minLength ?maxLength ?pattern ?example ?refEntity
WHERE {
  ?entity a api:Entity ;
          api:name ?entityName .
  OPTIONAL { ?entity rdfs:comment ?entityDescription }

  ?entity api:hasProperty ?property .
  ?property api:name ?propertyName ;
            api:type ?propertyType .
  OPTIONAL { ?property api:required ?required }
  OPTIONAL { ?property api:format ?format }
  OPTIONAL { ?property api:minLength ?minLength }
  OPTIONAL { ?property api:maxLength ?maxLength }
  OPTIONAL { ?property api:pattern ?pattern }
  OPTIONAL { ?property api:example ?example }
  OPTIONAL { ?property api:refEntity ?refEntity }
}
ORDER BY ?entityName ?propertyName
""" }
template = { file = "templates/openapi-schemas.tera" }
output_file = "openapi/schemas.yaml"
mode = "Overwrite"

# =============================================================================
# RULE 3: OpenAPI Paths (Endpoints)
# Purpose: Generates REST API endpoints (paths) for each entity
# Output: lib/openapi/paths.yaml
# Query: Extracts endpoint definitions (path, method, operationId, request/response schemas)
# =============================================================================
[[generation.rules]]
name = "openapi-paths"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?entityName ?path ?method ?operationId ?summary ?description
       ?requestSchema ?responseSchema ?statusCode
WHERE {
  ?entity a api:Entity ;
          api:name ?entityName ;
          api:hasEndpoint ?endpoint .
  ?endpoint api:path ?path ;
            api:method ?method ;
            api:operationId ?operationId .
  OPTIONAL { ?endpoint api:summary ?summary }
  OPTIONAL { ?endpoint api:description ?description }
  OPTIONAL { ?endpoint api:requestSchema ?requestSchema }
  OPTIONAL { ?endpoint api:responseSchema ?responseSchema }
  OPTIONAL { ?endpoint api:statusCode ?statusCode }
}
ORDER BY ?entityName ?path ?method
""" }
template = { file = "templates/openapi-paths.tera" }
output_file = "openapi/paths.yaml"
mode = "Overwrite"

# =============================================================================
# RULE 4: Combined OpenAPI Specification
# Purpose: Merges info, schemas, and paths into a complete OpenAPI 3.0 specification
# Output: lib/openapi/openapi.yaml
# Query: Extracts basic spec metadata for the combined file header
# =============================================================================
[[generation.rules]]
name = "openapi-combined"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>

SELECT ?title ?version
WHERE {
  ?spec a api:Specification ;
        api:title ?title ;
        api:version ?version .
}
LIMIT 1
""" }
template = { file = "templates/openapi-combined.tera" }
output_file = "openapi/openapi.yaml"
mode = "Overwrite"

# =============================================================================
# RULE 5: JavaScript Type Definitions (JSDoc)
# Purpose: Generates JSDoc type definitions for entities (replaces TypeScript interfaces)
# Output: lib/types/entities.mjs
# Query: Extracts entity properties to generate @typedef JSDoc comments
# Note: Uses .mjs extension for ES modules, JSDoc instead of TypeScript
# =============================================================================
[[generation.rules]]
name = "typescript-interfaces"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?entityName ?entityDescription ?propertyName ?propertyType
       ?required ?isArray ?refEntity
WHERE {
  ?entity a api:Entity ;
          api:name ?entityName .
  OPTIONAL { ?entity rdfs:comment ?entityDescription }

  ?entity api:hasProperty ?property .
  ?property api:name ?propertyName ;
            api:type ?propertyType .
  OPTIONAL { ?property api:required ?required }
  OPTIONAL { ?property api:isArray ?isArray }
  OPTIONAL { ?property api:refEntity ?refEntity }
}
ORDER BY ?entityName ?propertyName
""" }
template = { file = "templates/typescript-interfaces.tera" }
output_file = "types/entities.mjs"
mode = "Overwrite"

# =============================================================================
# RULE 6: JavaScript API Request/Response Types (JSDoc)
# Purpose: Generates JSDoc type definitions for API request/response types
# Output: lib/types/requests.mjs
# Query: Extracts request type properties for create/update operations
# Note: Uses .mjs extension and JSDoc instead of TypeScript interfaces
# =============================================================================
[[generation.rules]]
name = "typescript-api-types"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>

SELECT ?entityName ?operationType ?propertyName ?propertyType ?required
WHERE {
  ?entity a api:Entity ;
          api:name ?entityName ;
          api:hasRequestType ?reqType .
  ?reqType api:operationType ?operationType ;
           api:hasProperty ?property .
  ?property api:name ?propertyName ;
            api:type ?propertyType .
  OPTIONAL { ?property api:required ?required }
}
ORDER BY ?entityName ?operationType ?propertyName
""" }
template = { file = "templates/typescript-api-types.tera" }
output_file = "types/requests.mjs"
mode = "Overwrite"

# =============================================================================
# RULE 7: Zod Validation Schemas (Entities)
# Purpose: Generates Zod runtime validation schemas for all entities
# Output: lib/schemas/entities.mjs
# Query: Extracts entity properties with validation constraints (minLength, maxLength, format, etc.)
# Note: Uses .mjs extension for ES modules, includes JSDoc @typedef for type inference
# =============================================================================
[[generation.rules]]
name = "zod-schemas"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?entityName ?entityDescription ?propertyName ?propertyType
       ?required ?minLength ?maxLength ?pattern ?min ?max ?format ?refEntity
WHERE {
  ?entity a api:Entity ;
          api:name ?entityName .
  OPTIONAL { ?entity rdfs:comment ?entityDescription }

  ?entity api:hasProperty ?property .
  ?property api:name ?propertyName ;
            api:type ?propertyType .
  OPTIONAL { ?property api:required ?required }
  OPTIONAL { ?property api:minLength ?minLength }
  OPTIONAL { ?property api:maxLength ?maxLength }
  OPTIONAL { ?property api:pattern ?pattern }
  OPTIONAL { ?property api:min ?min }
  OPTIONAL { ?property api:max ?max }
  OPTIONAL { ?property api:format ?format }
  OPTIONAL { ?property api:refEntity ?refEntity }
}
ORDER BY ?entityName ?propertyName
""" }
template = { file = "templates/zod-schemas.tera" }
output_file = "schemas/entities.mjs"
mode = "Overwrite"

# =============================================================================
# RULE 8: Zod Request Validation Schemas
# Purpose: Generates Zod validation schemas specifically for API request bodies
# Output: lib/schemas/requests.mjs
# Query: Extracts request type properties for create/update operations with validation
# Note: Separate from entity schemas to handle request-specific validation rules
# =============================================================================
[[generation.rules]]
name = "zod-request-schemas"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>

SELECT ?entityName ?operationType ?propertyName ?propertyType
       ?required ?minLength ?maxLength ?pattern
WHERE {
  ?entity a api:Entity ;
          api:name ?entityName ;
          api:hasRequestType ?reqType .
  ?reqType api:operationType ?operationType ;
           api:hasProperty ?property .
  ?property api:name ?propertyName ;
            api:type ?propertyType .
  OPTIONAL { ?property api:required ?required }
  OPTIONAL { ?property api:minLength ?minLength }
  OPTIONAL { ?property api:maxLength ?maxLength }
  OPTIONAL { ?property api:pattern ?pattern }
}
ORDER BY ?entityName ?operationType ?propertyName
""" }
template = { file = "templates/zod-request-schemas.tera" }
output_file = "schemas/requests.mjs"
mode = "Overwrite"

# =============================================================================
# RULE 9: Type Guards
# Purpose: Generates JavaScript type guard functions for runtime type checking
# Output: lib/guards/entities.mjs
# Query: Extracts entity properties to generate runtime validation functions
# Note: Uses .mjs extension, returns boolean (not TypeScript type predicate syntax)
# =============================================================================
[[generation.rules]]
name = "type-guards"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>

SELECT ?entityName ?propertyName ?propertyType ?required ?isArray
WHERE {
  ?entity a api:Entity ;
          api:name ?entityName ;
          api:hasProperty ?property .
  ?property api:name ?propertyName ;
            api:type ?propertyType .
  OPTIONAL { ?property api:required ?required }
  OPTIONAL { ?property api:isArray ?isArray }
}
ORDER BY ?entityName ?propertyName
""" }
template = { file = "templates/type-guards.tera" }
output_file = "guards/entities.mjs"
mode = "Overwrite"

# =============================================================================
# RULE 10: Index file (Barrel Export)
# Purpose: Generates main index.mjs with barrel exports for all generated modules
# Output: lib/index.mjs
# Query: Extracts entity names to document what's exported
# Note: Provides clean import interface: import { userSchema } from './lib/index.mjs'
# =============================================================================
[[generation.rules]]
name = "index-file"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>

SELECT ?entityName
WHERE {
  ?entity a api:Entity ;
          api:name ?entityName .
}
ORDER BY ?entityName
""" }
template = { file = "templates/index.tera" }
output_file = "index.mjs"
mode = "Overwrite"

# =============================================================================
# RULE 11: Schemas Index (Barrel Export)
# Purpose: Generates index.mjs for schemas subdirectory
# Output: lib/schemas/index.mjs
# =============================================================================
[[generation.rules]]
name = "schemas-index"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>
SELECT ?entityName WHERE { ?entity a api:Entity ; api:name ?entityName . } LIMIT 1
""" }
template = { file = "templates/schemas-index.tera" }
output_file = "schemas/index.mjs"
mode = "Overwrite"

# =============================================================================
# RULE 12: Types Index (Barrel Export)
# Purpose: Generates index.mjs for types subdirectory
# Output: lib/types/index.mjs
# =============================================================================
[[generation.rules]]
name = "types-index"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>
SELECT ?entityName WHERE { ?entity a api:Entity ; api:name ?entityName . } LIMIT 1
""" }
template = { file = "templates/types-index.tera" }
output_file = "types/index.mjs"
mode = "Overwrite"

# =============================================================================
# RULE 13: Guards Index (Barrel Export)
# Purpose: Generates index.mjs for guards subdirectory
# Output: lib/guards/index.mjs
# =============================================================================
[[generation.rules]]
name = "guards-index"
query = { inline = """
PREFIX api: <https://ggen.io/ontology/api#>
SELECT ?entityName WHERE { ?entity a api:Entity ; api:name ?entityName . } LIMIT 1
""" }
template = { file = "templates/guards-index.tera" }
output_file = "guards/index.mjs"
mode = "Overwrite"
