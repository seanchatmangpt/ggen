/**
 * GENERATED FILE - DO NOT EDIT MANUALLY
 * ============================================================================
 * Generated by ggen from Bree semantic specification (RDF/Turtle)
 * Source: bree-ontology.ttl, bree-jobs-sample.ttl
 * Generation time: {{ generation_timestamp }}
 * Checksum: {{ specification_checksum }}
 * ============================================================================
 */

import Bree from 'bree';
import Graceful from '@ladjs/graceful';
import Cabin from 'cabin';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

/**
 * PRODUCTION BREE INSTANCE
 * ============================================================================
 * Configuration generated from semantic specification:
 * - Instance name: {{ instance.name }}
 * - Job root: {{ instance.root }}
 * - Total jobs: {{ jobs|length }}
 * - Features: Distributed tracing, SLA monitoring, circuit breakers
 * ============================================================================
 */

// Production logger with observability
const logger = new Cabin({
  axe: true, // Enable Axe for log collection
});

// Create Bree instance with production-grade configuration
const bree = new Bree({
  logger,

  // Semantic configuration from RDF spec
  root: path.join(__dirname, '{{ instance.root }}'),
  removeCompleted: {{ instance.removeCompleted|lower }},
  timeout: {{ instance.defaultTimeout }},
  interval: {{ instance.defaultInterval }},
  hasSeconds: {{ instance.hasSeconds|lower }},

  // Jobs defined in bree-jobs-sample.ttl
  jobs: [
    {% for job in jobs %}
    {
      name: '{{ job.jobName }}',
      path: path.join(__dirname, '{{ job.jobPath }}'),
      {% if job.hasTimeout %}timeout: {{ job.timeout }},{% endif %}
      {% if job.hasInterval %}interval: {{ job.interval }},{% endif %}
      {% if job.hasCron %}cron: '{{ job.cron }}',{% endif %}
      {% if job.hasDate %}date: new Date('{{ job.date }}'),{% endif %}
      closeWorkerAfterMs: {{ job.closeWorkerAfterMs }},
      outputWorkerMetadata: {{ job.outputWorkerMetadata|lower }},
      worker: {
        workerData: {
          // Distributed tracing context
          traceId: generateTraceId(),
          spanId: generateSpanId(),
          jobName: '{{ job.jobName }}',
          timestamp: Date.now(),
        },
      },
    },
    {% endfor %}
  ],

  // Error handling with retry logic
  errorHandler: (error, workerMetadata) => {
    const { threadId, name } = workerMetadata;
    logger.error(`Job error: ${name} (thread: ${threadId})`, {
      error: error.message,
      stack: error.stack,
    });

    // Could integrate with error tracking (Sentry, Honeybadger, etc)
    // errorTracker.captureException(error, { tags: { job: name } });
  },

  // Worker message handler for observability
  workerMessageHandler: (name, message) => {
    if (message.type === 'metric') {
      logger.debug(`Metric from ${name}:`, message.data);
      // Could emit to Prometheus, DataDog, etc
      // metricsCollector.emit(message.data);
    } else if (message.type === 'trace') {
      logger.debug(`Trace from ${name}:`, message.data);
    }
  },
});

/**
 * GRACEFUL SHUTDOWN HANDLER
 * Ensures all running jobs complete before process exit
 */
const graceful = new Graceful({ brees: [bree] });
graceful.listen();

/**
 * LIFECYCLE HOOKS
 */

bree.on('worker created', (name) => {
  logger.info(`[WORKER_CREATED] ${name}`, {
    timestamp: new Date().toISOString(),
    jobName: name,
  });
});

bree.on('worker deleted', (name) => {
  logger.info(`[WORKER_DELETED] ${name}`, {
    timestamp: new Date().toISOString(),
    jobName: name,
  });
});

/**
 * START THE SCHEDULER
 */
async function start() {
  try {
    logger.info('Starting Bree semantic job scheduler...', {
      instance: '{{ instance.name }}',
      jobs: {{ jobs|length }},
      timestamp: new Date().toISOString(),
    });

    await bree.start();

    logger.info('Bree scheduler started successfully', {
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    logger.error('Failed to start Bree scheduler:', error);
    process.exit(1);
  }
}

/**
 * UTILITY FUNCTIONS
 */

function generateTraceId() {
  return Math.random().toString(16).substring(2, 18);
}

function generateSpanId() {
  return Math.random().toString(16).substring(2, 18);
}

/**
 * EXPORT FOR TESTING & EXTERNAL USE
 */
export { bree, start, logger, graceful };

/**
 * AUTO-START IF CALLED AS MAIN MODULE
 */
if (import.meta.url === `file://${process.argv[1]}`) {
  start().catch((error) => {
    logger.error('Fatal error:', error);
    process.exit(1);
  });
}
