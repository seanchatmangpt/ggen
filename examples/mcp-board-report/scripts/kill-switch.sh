#!/usr/bin/env bash
# =============================================================================
# MCP+ Kill Switch Control Script
#
# Board-authorized emergency control for sealed operating contracts.
# Provides global, family, capability, and epoch disable functions.
#
# Core axiom: A = μ(O), μ ∘ μ = μ, hash(A) = hash(μ(O)), O ⊨ Σ
#
# Generated by ggen - DO NOT EDIT MANUALLY
# =============================================================================

set -euo pipefail

# Configuration
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly STATE_DIR="${SCRIPT_DIR}/../state"
readonly LOG_DIR="${SCRIPT_DIR}/../logs"
readonly EVIDENCE_DIR="${SCRIPT_DIR}/../evidence"

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Ensure directories exist
mkdir -p "${STATE_DIR}" "${LOG_DIR}" "${EVIDENCE_DIR}"

# Logging
log() {
    local level="$1"
    shift
    local timestamp
    timestamp=$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
    echo -e "${timestamp} [${level}] $*" | tee -a "${LOG_DIR}/kill-switch.log"
}

# Generate receipt for kill switch action
generate_receipt() {
    local action="$1"
    local target="$2"
    local receipt_id
    receipt_id="rcpt-$(date +%s)-$$"

    local receipt_file="${EVIDENCE_DIR}/${receipt_id}.json"

    cat > "${receipt_file}" << EOF
{
    "receipt_id": "${receipt_id}",
    "action": "${action}",
    "target": "${target}",
    "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
    "operator": "${USER:-unknown}",
    "hostname": "$(hostname)",
    "receipt_hash": "$(echo -n "${receipt_id}|${action}|${target}|$(date -u +"%Y-%m-%dT%H:%M:%SZ")" | sha256sum | cut -d' ' -f1)"
}
EOF

    echo "${receipt_file}"
}

# Global disable
cmd_disable_global() {
    log "CRITICAL" "GLOBAL KILL SWITCH ACTIVATED"

    echo "true" > "${STATE_DIR}/global_disabled"

    local receipt
    receipt=$(generate_receipt "disable_global" "all")

    echo -e "${RED}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║              GLOBAL KILL SWITCH ACTIVATED                    ║${NC}"
    echo -e "${RED}║                                                              ║${NC}"
    echo -e "${RED}║  All MCP+ operations are now DISABLED                        ║${NC}"
    echo -e "${RED}║  Receipt: ${receipt}${NC}"
    echo -e "${RED}╚══════════════════════════════════════════════════════════════╝${NC}"

    log "INFO" "Receipt generated: ${receipt}"
}

# Family disable
cmd_disable_family() {
    local family_id="$1"

    log "WARNING" "Family kill switch activated: ${family_id}"

    mkdir -p "${STATE_DIR}/families"
    echo "true" > "${STATE_DIR}/families/${family_id}_disabled"

    local receipt
    receipt=$(generate_receipt "disable_family" "${family_id}")

    echo -e "${YELLOW}Family '${family_id}' has been DISABLED${NC}"
    echo -e "Receipt: ${receipt}"

    log "INFO" "Receipt generated: ${receipt}"
}

# Capability disable
cmd_disable_capability() {
    local capability_id="$1"

    log "WARNING" "Capability kill switch activated: ${capability_id}"

    mkdir -p "${STATE_DIR}/capabilities"
    echo "true" > "${STATE_DIR}/capabilities/${capability_id}_disabled"

    local receipt
    receipt=$(generate_receipt "disable_capability" "${capability_id}")

    echo -e "${YELLOW}Capability '${capability_id}' has been DISABLED${NC}"
    echo -e "Receipt: ${receipt}"

    log "INFO" "Receipt generated: ${receipt}"
}

# Epoch revocation
cmd_revoke_epoch() {
    local epoch_id="$1"

    log "WARNING" "Epoch revocation activated: ${epoch_id}"

    mkdir -p "${STATE_DIR}/epochs"
    echo "revoked" > "${STATE_DIR}/epochs/${epoch_id}_status"

    local receipt
    receipt=$(generate_receipt "revoke_epoch" "${epoch_id}")

    echo -e "${YELLOW}Epoch '${epoch_id}' has been REVOKED${NC}"
    echo -e "Receipt: ${receipt}"

    log "INFO" "Receipt generated: ${receipt}"
}

# Status check
cmd_status() {
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║              MCP+ Kill Switch Status                         ║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    # Global status
    if [[ -f "${STATE_DIR}/global_disabled" ]]; then
        echo -e "  Global:       ${RED}DISABLED${NC}"
    else
        echo -e "  Global:       ${GREEN}ENABLED${NC}"
    fi

    # Families
    echo -e "\n  Disabled Families:"
    local found_families=false
    if [[ -d "${STATE_DIR}/families" ]]; then
        shopt -s nullglob
        for f in "${STATE_DIR}/families"/*_disabled; do
            if [[ -f "$f" ]]; then
                local family
                family=$(basename "$f" _disabled)
                echo -e "    - ${RED}${family}${NC}"
                found_families=true
            fi
        done
        shopt -u nullglob
    fi
    if [[ "${found_families}" == "false" ]]; then
        echo -e "    ${GREEN}(none)${NC}"
    fi

    # Capabilities
    echo -e "\n  Disabled Capabilities:"
    local found_caps=false
    if [[ -d "${STATE_DIR}/capabilities" ]]; then
        shopt -s nullglob
        for f in "${STATE_DIR}/capabilities"/*_disabled; do
            if [[ -f "$f" ]]; then
                local cap
                cap=$(basename "$f" _disabled)
                echo -e "    - ${RED}${cap}${NC}"
                found_caps=true
            fi
        done
        shopt -u nullglob
    fi
    if [[ "${found_caps}" == "false" ]]; then
        echo -e "    ${GREEN}(none)${NC}"
    fi

    # Epochs
    echo -e "\n  Revoked Epochs:"
    local found_epochs=false
    if [[ -d "${STATE_DIR}/epochs" ]]; then
        shopt -s nullglob
        for f in "${STATE_DIR}/epochs"/*_status; do
            if [[ -f "$f" ]] && [[ "$(cat "$f")" == "revoked" ]]; then
                local epoch
                epoch=$(basename "$f" _status)
                echo -e "    - ${RED}${epoch}${NC}"
                found_epochs=true
            fi
        done
        shopt -u nullglob
    fi
    if [[ "${found_epochs}" == "false" ]]; then
        echo -e "    ${GREEN}(none)${NC}"
    fi

    echo ""
}

# Drill mode - test kill switch without affecting production
cmd_drill() {
    local drill_type="${1:-all}"

    echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║              MCP+ Kill Switch DRILL MODE                     ║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    log "INFO" "Starting kill switch drill: ${drill_type}"

    local drill_state_dir="${STATE_DIR}/drill-$$"
    mkdir -p "${drill_state_dir}"

    case "${drill_type}" in
        global)
            echo -e "  Testing global kill switch..."
            echo "true" > "${drill_state_dir}/global_disabled"
            echo -e "  ${GREEN}✓ Global kill switch test PASSED${NC}"
            ;;
        family)
            echo -e "  Testing family kill switch..."
            mkdir -p "${drill_state_dir}/families"
            echo "true" > "${drill_state_dir}/families/test-family_disabled"
            echo -e "  ${GREEN}✓ Family kill switch test PASSED${NC}"
            ;;
        capability)
            echo -e "  Testing capability kill switch..."
            mkdir -p "${drill_state_dir}/capabilities"
            echo "true" > "${drill_state_dir}/capabilities/test-capability_disabled"
            echo -e "  ${GREEN}✓ Capability kill switch test PASSED${NC}"
            ;;
        epoch)
            echo -e "  Testing epoch revocation..."
            mkdir -p "${drill_state_dir}/epochs"
            echo "revoked" > "${drill_state_dir}/epochs/test-epoch_status"
            echo -e "  ${GREEN}✓ Epoch revocation test PASSED${NC}"
            ;;
        all)
            echo -e "  Testing all kill switch types..."
            echo ""
            cmd_drill global
            cmd_drill family
            cmd_drill capability
            cmd_drill epoch
            echo ""
            echo -e "  ${GREEN}All kill switch drill tests PASSED${NC}"
            ;;
        *)
            echo -e "${RED}Unknown drill type: ${drill_type}${NC}"
            exit 1
            ;;
    esac

    # Cleanup drill state
    rm -rf "${drill_state_dir}"

    # Generate drill receipt
    local receipt
    receipt=$(generate_receipt "drill" "${drill_type}")

    echo ""
    echo -e "  Drill Receipt: ${receipt}"

    log "INFO" "Kill switch drill completed: ${drill_type}"
}

# Reset all kill switches (requires confirmation)
cmd_reset() {
    echo -e "${YELLOW}WARNING: This will reset ALL kill switches${NC}"
    echo -n "Type 'CONFIRM' to proceed: "
    read -r confirmation

    if [[ "${confirmation}" != "CONFIRM" ]]; then
        echo -e "${RED}Reset cancelled${NC}"
        exit 1
    fi

    log "WARNING" "Resetting all kill switches"

    rm -f "${STATE_DIR}/global_disabled"
    rm -rf "${STATE_DIR}/families"
    rm -rf "${STATE_DIR}/capabilities"
    rm -rf "${STATE_DIR}/epochs"

    local receipt
    receipt=$(generate_receipt "reset_all" "all")

    echo -e "${GREEN}All kill switches have been RESET${NC}"
    echo -e "Receipt: ${receipt}"

    log "INFO" "All kill switches reset. Receipt: ${receipt}"
}

# Help
cmd_help() {
    cat << EOF
MCP+ Kill Switch Control

USAGE:
    $(basename "$0") <command> [arguments]

COMMANDS:
    disable-global              Disable all MCP+ operations globally
    disable-family <id>         Disable a specific contract family
    disable-capability <id>     Disable a specific capability
    revoke-epoch <id>           Revoke a signing key epoch
    status                      Show current kill switch status
    drill [type]                Run kill switch drill (global|family|capability|epoch|all)
    reset                       Reset all kill switches (requires confirmation)
    help                        Show this help message

EXAMPLES:
    $(basename "$0") disable-global
    $(basename "$0") disable-family payment-processing
    $(basename "$0") drill all
    $(basename "$0") status
EOF
}

# Main
main() {
    if [[ $# -lt 1 ]]; then
        cmd_help
        exit 1
    fi

    local command="$1"
    shift

    case "${command}" in
        disable-global)
            cmd_disable_global
            ;;
        disable-family)
            [[ $# -lt 1 ]] && { echo "Error: family ID required"; exit 1; }
            cmd_disable_family "$1"
            ;;
        disable-capability)
            [[ $# -lt 1 ]] && { echo "Error: capability ID required"; exit 1; }
            cmd_disable_capability "$1"
            ;;
        revoke-epoch)
            [[ $# -lt 1 ]] && { echo "Error: epoch ID required"; exit 1; }
            cmd_revoke_epoch "$1"
            ;;
        status)
            cmd_status
            ;;
        drill)
            cmd_drill "${1:-all}"
            ;;
        reset)
            cmd_reset
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            echo -e "${RED}Unknown command: ${command}${NC}"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
