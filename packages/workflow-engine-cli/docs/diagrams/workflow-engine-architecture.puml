@startuml workflow-engine-architecture
!define RECTANGLE class

skinparam componentStyle rectangle
skinparam backgroundColor #FEFEFE
skinparam component {
    BackgroundColor<<core>> #E3F2FD
    BackgroundColor<<storage>> #FFF9C4
    BackgroundColor<<interface>> #C8E6C9
    BorderColor #424242
    ArrowColor #424242
}

title Workflow Engine Architecture

package "CLI Interface" <<interface>> {
    [workflow-engine CLI] as CLI

    component "Nouns" {
        [Workflow] as WF
        [Process] as PROC
        [Task] as TASK
        [Instance] as INST
    }

    component "Verbs" {
        [create/deploy/list] as WF_VERBS
        [start/pause/resume] as PROC_VERBS
        [assign/complete/delegate] as TASK_VERBS
        [show/trace/metrics] as INST_VERBS
    }
}

package "BPMN Engine Core" <<core>> {
    [Process Parser] as PARSER
    [State Machine] as STATE
    [Event Bus] as EVENTS
    [Gateway Logic] as GATEWAY
    [Task Executor] as EXECUTOR
    [Variable Manager] as VARS
}

package "Storage Layer" <<storage>> {
    database "State Store\n(PostgreSQL)" as DB {
        [Workflow Definitions]
        [Process Instances]
        [Task States]
        [Variables]
    }

    queue "Event Queue\n(Redis/Kafka)" as QUEUE {
        [Process Events]
        [Task Events]
        [Gateway Events]
    }

    [Metrics Store\n(Prometheus)] as METRICS
}

package "External Systems" {
    [REST APIs] as API
    [Message Queues] as MQ
    [Business Rules] as RULES
    [User Interface] as UI
}

' CLI connections
CLI --> WF
CLI --> PROC
CLI --> TASK
CLI --> INST

WF --> WF_VERBS
PROC --> PROC_VERBS
TASK --> TASK_VERBS
INST --> INST_VERBS

' Core engine connections
WF_VERBS --> PARSER
PROC_VERBS --> STATE
TASK_VERBS --> EXECUTOR
INST_VERBS --> METRICS

PARSER --> DB
STATE --> DB
STATE --> EVENTS
GATEWAY --> STATE
EXECUTOR --> EVENTS
EXECUTOR --> VARS
EVENTS --> QUEUE
VARS --> DB

' External system connections
EXECUTOR --> API : Service Tasks
EXECUTOR --> MQ : Send Tasks
EXECUTOR --> RULES : Business Rule Tasks
STATE --> UI : User Tasks

' Metrics flow
STATE --> METRICS
EXECUTOR --> METRICS
GATEWAY --> METRICS

note right of PARSER
  Parses BPMN 2.0 XML
  Validates workflow definitions
  Builds process graph
end note

note right of STATE
  Manages process lifecycle
  Handles state transitions
  Persists checkpoints
  Supports recovery
end note

note right of EVENTS
  Publishes process events
  Handles boundary events
  Timer event scheduling
  Message correlation
end note

note right of GATEWAY
  Exclusive (XOR)
  Parallel (AND)
  Inclusive (OR)
  Event-based
end note

note right of EXECUTOR
  Executes tasks
  Manages task lifecycle
  Handles retries
  Delegates to external systems
end note

@enduml
