%% -*- mode: erlang -*-
%% TPS Heijunka - Load Leveling System
%% Rebar3 configuration for building Erlang components

{erl_opts, [
    debug_info,
    warnings_as_errors,
    {parse_transform, ct_expand}
]}.

{deps, [
    {poolboy, {git, "https://github.com/devinus/poolboy.git", {tag, "1.5.2"}}},
    {jobs, {git, "https://github.com/uwiger/jobs.git", {tag, "0.10.0"}}}
]}.

{dialyzer, [
    {warnings, [
        error_handling,
        race_conditions,
        underspecs
    ]},
    {get_warnings, true}
]}.

{xref_checks, [
    undefined_function_calls,
    undefined_functions,
    locals_not_used,
    exports_not_used,
    deprecated_function_calls,
    deprecated_functions
]}.

{cover_enabled, true}.

{cover_excl_apps, [poolboy, jobs]}.

{cover_opts, [
    {min_coverage, 80}
]}.

{ct_opts, [
    {sys_config, "config/test.config"},
    {logdir, "logs"}
]}.

{profiles, [
    {dev, [
        {erl_opts, [nowarn_missing_spec]}
    ]},
    {test, [
        {erl_opts, [
            debug_info,
            {src_dirs, ["src", "test"]}
        ]},
        {deps, [
            {proper, "1.3.0"},
            {meck, "0.9.2"}
        ]}
    ]},
    {prod, [
        {erl_opts, [
            {d, 'PRODUCTION'},
            native,
            {hipe, [o3]}
        ]},
        {deps, []},
        {relx, [
            {release, {tps_heijunka, "1.0.0"}, [
                kernel,
                stdlib,
                sasl,
                poolboy,
                jobs,
                heijunka
            ]},
            {sys_config_src, "config/prod.config.src"},
            {vm_args_src, "config/vm.args.src"},
            {mode, prod},
            {include_erts, true},
            {extended_start_script, true}
        ]}
    ]}
]}.
