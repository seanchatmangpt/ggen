@startuml bpmn-execution-flow
!theme plain

title BPMN Workflow Execution Flow

participant "CLI User" as USER
participant "Workflow Manager" as WM
participant "Process Executor" as PE
participant "Task Executor" as TE
participant "Event Bus" as EB
participant "State Store" as DB

== Workflow Creation ==
USER -> WM: workflow create --file process.bpmn
activate WM
WM -> WM: Parse BPMN XML
WM -> WM: Validate BPMN 2.0
WM -> DB: Store workflow definition
WM --> USER: Workflow ID: wf-001
deactivate WM

== Workflow Deployment ==
USER -> WM: workflow deploy --workflow-id wf-001
activate WM
WM -> DB: Load workflow definition
WM -> WM: Validate references
WM -> WM: Build process graph
WM -> DB: Mark as deployed
WM --> USER: Deployed successfully
deactivate WM

== Process Start ==
USER -> PE: process start --workflow-id wf-001\n--variables {...}
activate PE
PE -> DB: Load workflow definition
PE -> PE: Create process instance
PE -> DB: Save initial state
PE -> EB: Publish StartEvent
activate EB
EB --> PE: Event published
deactivate EB

== Task Execution ==
PE -> TE: Execute start task
activate TE
TE -> DB: Load task definition
TE -> TE: Evaluate task type

alt Service Task
    TE -> TE: Call external service
    TE --> PE: Task completed
else User Task
    TE -> DB: Assign to user
    TE --> PE: Task assigned
    note right
      User completes task
      via CLI or UI
    end note
    USER -> TE: task complete --task-id task-001
    TE --> PE: Task completed
else Script Task
    TE -> TE: Execute script
    TE --> PE: Task completed
end

deactivate TE

== Gateway Processing ==
PE -> PE: Evaluate gateway condition

alt Exclusive Gateway (XOR)
    PE -> PE: Evaluate conditions
    PE -> PE: Choose single path
    PE -> TE: Execute next task
else Parallel Gateway (AND)
    PE -> PE: Fork execution
    PE -> TE: Execute task A
    PE -> TE: Execute task B
    note right
      Tasks execute concurrently
      Join waits for all branches
    end note
else Inclusive Gateway (OR)
    PE -> PE: Evaluate all conditions
    PE -> PE: Activate matching paths
    PE -> TE: Execute selected tasks
end

== Event Handling ==
EB -> PE: Timer event triggered
activate PE
PE -> DB: Update process state
PE -> TE: Execute event handler
deactivate PE

EB -> PE: Message event received
activate PE
PE -> PE: Correlate message
PE -> DB: Update variables
PE -> TE: Resume process
deactivate PE

== Process Completion ==
TE -> PE: All tasks completed
PE -> PE: Evaluate end condition
PE -> DB: Mark process as completed
PE -> EB: Publish EndEvent
activate EB
EB -> EB: Trigger post-processing
EB --> PE: Event published
deactivate EB
PE --> USER: Process completed\nInstance ID: inst-123
deactivate PE

== Instance Tracking ==
USER -> PE: instance trace --instance-id inst-123
activate PE
PE -> DB: Load execution history
PE -> PE: Build execution tree
PE --> USER: Execution trace
deactivate PE

USER -> PE: instance metrics --instance-id inst-123
activate PE
PE -> DB: Load timing data
PE -> PE: Calculate metrics
PE --> USER: Performance metrics
deactivate PE

@enduml
