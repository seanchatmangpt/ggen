@startuml consistency-checking
!theme blueprint
title Consistency Checking and Explanation Generation

actor User
participant "Reasoner CLI" as CLI
participant "Ontology Manager" as OM
participant "Reasoner Engine" as RE
participant "Consistency Checker" as CC
participant "Justification Generator" as JG
database "Axiom Store" as AS

User -> CLI: consistency check\n--input ontology.owl\n--explain
activate CLI

CLI -> OM: Load ontology
activate OM
OM -> AS: Parse axioms
AS --> OM: Axiom set
OM --> CLI: Ontology loaded
deactivate OM

CLI -> RE: Initialize reasoner
activate RE

RE -> RE: Preprocess axioms
RE -> RE: Normalize class expressions

CLI -> CC: Check consistency
activate CC

CC -> RE: Is ontology consistent?

alt Consistency Check Algorithm
  RE -> RE: Build initial tableau
  RE -> RE: Apply expansion rules

  loop For each class
    RE -> RE: Check satisfiability
    alt Class is satisfiable
      RE -> RE: Mark as satisfiable
    else Class is unsatisfiable
      RE -> RE: Mark as unsatisfiable
      RE -> RE: Record clash
    end
  end

  alt No clashes found
    RE --> CC: **CONSISTENT**
  else Clashes detected
    RE --> CC: **INCONSISTENT**\n+ Unsatisfiable classes
  end
end

alt Ontology is CONSISTENT
  CC --> CLI: ✓ Consistent\n(no unsatisfiable classes)
  CLI --> User: Success: Ontology is consistent

else Ontology is INCONSISTENT
  CC -> JG: Generate explanations\nfor unsatisfiable classes
  activate JG

  loop For each unsatisfiable class C
    JG -> AS: Find axioms involving C
    AS --> JG: Relevant axioms

    JG -> JG: Compute minimal\nunsatisfiability-preserving sets

    alt Single justification
      JG -> JG: Glass-box approach\n(trace reasoning)
    else Multiple justifications
      JG -> JG: Black-box approach\n(hitting set tree)
    end

    JG -> JG: Extract minimal axiom sets

    note right
      **Justification Example**

      Class: Person ⊓ Robot
      Axioms:
      1. Person ⊑ Biological
      2. Robot ⊑ ¬Biological
      3. Biological ⊓ ¬Biological ⊑ ⊥

      Conclusion: Unsatisfiable
    end note
  end

  JG --> CC: Justification sets
  deactivate JG

  CC -> CC: Format explanations

  CC --> CLI: ✗ Inconsistent\n+ Unsatisfiable classes\n+ Justifications
  deactivate CC

  CLI -> CLI: Format output (JSON/Table)

  CLI --> User: Report:\n- Unsatisfiable classes\n- Explanations\n- Repair suggestions
end

deactivate RE
deactivate CLI

note over User, AS
  **Repair Strategies**

  1. **Remove Minimal Axioms**
     - Delete smallest set of axioms
     - Restore consistency

  2. **Weaken Axioms**
     - Replace ⊑ with ⊓
     - Add disjunctions

  3. **Modularize**
     - Separate conflicting modules
     - Resolve independently
end note

@enduml
