@startuml sparql-optimization
!theme blueprint
title SPARQL Query Optimization Process

actor User
participant "CLI Parser" as CLI
participant "Query Parser" as Parser
participant "Optimizer" as Opt
participant "Statistics\nCollector" as Stats
participant "Cost Model" as Cost
participant "Rewriter" as Rewriter
participant "Index Manager" as Index
database "Statistics DB" as StatsDB
database "Index Store" as IndexStore

User -> CLI: optimization rewrite\n--query complex.sparql\n--level 3\n--aggressive
activate CLI

CLI -> Parser: Parse query
activate Parser
Parser --> CLI: Abstract Syntax Tree (AST)
deactivate Parser

CLI -> Opt: Optimize query
activate Opt

Opt -> Stats: Get statistics
activate Stats
Stats -> StatsDB: Query stats:\n- Triple count\n- Predicate frequency\n- Cardinality
StatsDB --> Stats: Statistics data
Stats --> Opt: Stats available
deactivate Stats

Opt -> Opt: Optimization Level 1:\nBasic optimizations

opt Level 1: Basic
    Opt -> Rewriter: Filter pushdown
    activate Rewriter
    Rewriter -> Rewriter: Move FILTER\ncloser to data
    Rewriter --> Opt: Rewritten AST
    deactivate Rewriter

    Opt -> Rewriter: Constant folding
    activate Rewriter
    Rewriter -> Rewriter: Evaluate constants
    Rewriter --> Opt: Rewritten AST
    deactivate Rewriter

    Opt -> Rewriter: Dead code elimination
    activate Rewriter
    Rewriter -> Rewriter: Remove unused\nvariables
    Rewriter --> Opt: Rewritten AST
    deactivate Rewriter
end

alt Level >= 2: Standard
    Opt -> Opt: Optimization Level 2:\nStandard optimizations

    Opt -> Cost: Estimate join costs
    activate Cost
    Cost -> Cost: Calculate:\n- Cardinality\n- Selectivity\n- Join selectivity
    Cost --> Opt: Cost estimates
    deactivate Cost

    Opt -> Rewriter: Join reordering
    activate Rewriter
    Rewriter -> Rewriter: Reorder joins\nby selectivity
    Rewriter --> Opt: Rewritten AST
    deactivate Rewriter

    Opt -> Rewriter: Subquery merging
    activate Rewriter
    Rewriter -> Rewriter: Merge nested\nSELECT queries
    Rewriter --> Opt: Rewritten AST
    deactivate Rewriter

    Opt -> Rewriter: Common subexpression\nelimination
    activate Rewriter
    Rewriter -> Rewriter: Identify & reuse\ncommon patterns
    Rewriter --> Opt: Rewritten AST
    deactivate Rewriter

    Opt -> Rewriter: Projection pushdown
    activate Rewriter
    Rewriter -> Rewriter: Limit projection\nearly
    Rewriter --> Opt: Rewritten AST
    deactivate Rewriter
end

alt Level == 3: Aggressive
    Opt -> Opt: Optimization Level 3:\nAggressive optimizations

    Opt -> Index: Check available indexes
    activate Index
    Index -> IndexStore: Query indexes
    IndexStore --> Index: Index metadata
    Index --> Opt: Available indexes
    deactivate Index

    Opt -> Rewriter: Index hints
    activate Rewriter
    Rewriter -> Rewriter: Add index hints\nfor predicates
    Rewriter --> Opt: Rewritten AST
    deactivate Rewriter

    Opt -> Rewriter: Materialization
    activate Rewriter
    Rewriter -> Rewriter: Materialize\nintermediate results
    Rewriter --> Opt: Rewritten AST
    deactivate Rewriter

    Opt -> Rewriter: OPTIONAL optimization
    activate Rewriter
    Rewriter -> Rewriter: Convert OPTIONAL\nto LEFT JOIN
    Rewriter --> Opt: Rewritten AST
    deactivate Rewriter

    Opt -> Rewriter: UNION optimization
    activate Rewriter
    Rewriter -> Rewriter: Merge UNION\nbranches
    Rewriter --> Opt: Rewritten AST
    deactivate Rewriter
end

Opt -> Cost: Estimate final cost
activate Cost
Cost -> Cost: Calculate total cost:\n- I/O cost\n- CPU cost\n- Network cost
Cost --> Opt: Final cost estimate
deactivate Cost

Opt -> Opt: Generate execution plan

Opt --> CLI: Optimized query +\nexecution plan
deactivate Opt

CLI --> User: Rewritten query +\noptimization report:\n- Original cost: 1250\n- Optimized cost: 180\n- Speedup: 6.9x
deactivate CLI

note over Opt
Optimization techniques by level:

Level 1 (Basic):
- Filter pushdown
- Constant folding
- Dead code elimination
- Simple pattern matching

Level 2 (Standard):
- Join reordering
- Subquery merging
- Projection pushdown
- Common subexpression elimination
- BIND optimization

Level 3 (Aggressive):
- Index hints
- Materialization
- Query parallelization
- Advanced join algorithms
- Result caching
end note

note over Cost
Cost model factors:

1. I/O Cost:
   - Triple store access
   - Index scans
   - Sequential scans

2. CPU Cost:
   - Join operations
   - Filter evaluation
   - Sorting

3. Network Cost:
   - Endpoint latency
   - Data transfer
   - Federation overhead

4. Cardinality:
   - Result set size
   - Intermediate results
   - Selectivity
end note

note over Rewriter
Rewrite rules:

1. Filter pushdown:
   FILTER(?x > 10) . ?x :p ?y
   → ?x :p ?y . FILTER(?x > 10)

2. Join reordering:
   High selectivity patterns first

3. Subquery elimination:
   SELECT * WHERE {
     { SELECT ?x WHERE {...} }
     ?x :p ?y
   }
   → SELECT ?x ?y WHERE {...; ?x :p ?y}

4. OPTIONAL to LEFT JOIN:
   Better execution plan
end note

@enduml
