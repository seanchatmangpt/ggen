# ggen: Sync & Configuration Reference

**Machine-parseable reference for agents. Human documentation: [docs/](docs/)**

---

## ggen sync

### Command Signature

```
ggen sync [OPTIONS] [--from <SOURCE>] [--to <TARGET>]
```

### Behavior

Synchronizes RDF ontologies, generated code, and configuration across workspace members. Ensures consistency between:
- Source ontology definitions
- Generated code artifacts
- Project configurations (`ggen.toml`)
- Package configurations (`gpack.toml`)

### Options

| Flag | Type | Description | Required |
|------|------|-------------|----------|
| `--from` | STRING | Source path or workspace member | Optional |
| `--to` | STRING | Target path or workspace member | Optional |
| `--mode` | STRING | Sync mode: `full`, `incremental`, `verify` | Default: `full` |
| `--verbose` | BOOL | Output detailed sync operations | Default: false |
| `--dry-run` | BOOL | Preview changes without applying | Default: false |
| `--force` | BOOL | Override conflicts (use with caution) | Default: false |

### Sync Modes

#### Full Sync
```
ggen sync --mode full --from schema.ttl --to generated/
```
- Regenerates all artifacts from source
- Overwrites existing generated code
- Validates all configurations
- Recommended: Initial setup, major version updates

#### Incremental Sync
```
ggen sync --mode incremental --from schema.ttl
```
- Updates only changed ontology elements
- Preserves manual modifications (marked with `// MANUAL`)
- Faster for large codebases
- Recommended: Development iteration

#### Verify Mode
```
ggen sync --mode verify --from schema.ttl --to generated/
```
- Checks consistency without modifying files
- Reports conflicts and mismatches
- No file writes
- Recommended: CI/CD validation

### Exit Codes

| Code | Meaning | Action |
|------|---------|--------|
| 0 | Success | Sync complete |
| 1 | Sync conflicts | Resolve conflicts, retry with `--force` |
| 2 | Configuration error | Fix `ggen.toml` or `gpack.toml` |
| 3 | Invalid ontology | Validate source RDF file |
| 4 | Permission denied | Check file permissions |

### Examples

#### Sync single workspace member
```bash
ggen sync --from crates/ggen-domain/ontology.ttl --to crates/ggen-domain/src/generated.rs
```

#### Sync entire workspace
```bash
ggen sync --from . --mode full --verbose
```

#### Dry-run to preview changes
```bash
ggen sync --mode incremental --dry-run
```

#### Verify consistency in CI
```bash
ggen sync --mode verify || exit 1
```

### Sync Operations (Ordered)

1. **Load Configuration** → Read `ggen.toml` and `gpack.toml` files
2. **Load Ontologies** → Parse RDF files (Turtle, RDF/XML, N-Triples)
3. **Execute SPARQL Queries** → Extract code patterns from ontology
4. **Render Templates** → Generate code using Tera engine
5. **Check Conflicts** → Compare generated code with existing files
6. **Apply Changes** → Write files or report conflicts
7. **Update Manifest** → Record sync metadata (timestamps, hashes)
8. **Validate Output** → Compile/lint generated code

### Sync Metadata

Generated files include metadata header:

```rust
// ⚡ GENERATED BY ggen sync
// Source: schema.ttl
// Generated: 2025-12-15T10:30:00Z
// Hash: sha256:abc123...
// Mode: READONLY (delete and regenerate, don't edit)
```

Manual modifications:

```rust
// MANUAL: Custom implementation - preserved during sync
fn custom_validation(data: &Data) -> Result<(), Error> {
    // This section survives incremental sync
}
```

---

## ggen.toml

### File Location

```
<workspace-root>/ggen.toml
```

Located at repository root (same level as `Cargo.toml` for Rust projects).

### Schema

```toml
[project]
name = STRING              # Project identifier
version = STRING           # Semantic version (required for publishing)
description = STRING       # Project purpose
authors = [STRING, ...]    # Author list
license = STRING           # SPDX license (MIT, Apache-2.0, etc.)

[generation]
ontology_dir = STRING      # Ontology file directory (default: schema/)
templates_dir = STRING     # Template file directory (default: templates/)
output_dir = STRING        # Generated code output directory (default: generated/)
incremental = BOOL         # Enable incremental generation (default: true)
overwrite = BOOL           # Overwrite existing generated files (default: false)

[sync]
enabled = BOOL             # Enable sync on save (default: true)
on_change = STRING         # Trigger: "save" | "commit" | "manual" (default: "save")
validate_after = BOOL      # Run validation after sync (default: true)
conflict_mode = STRING     # Handle conflicts: "fail" | "warn" | "ignore" (default: "fail")

[rdf]
formats = [STRING, ...]    # Supported formats: "turtle" | "rdf-xml" | "n-triples" (default: ["turtle"])
default_format = STRING    # Default RDF format (default: "turtle")
base_uri = STRING          # Base URI for ontology (optional)
strict_validation = BOOL   # Strict RDF validation (default: false)

[templates]
enable_caching = BOOL      # Cache compiled templates (default: true)
auto_reload = BOOL         # Reload on file change (default: true)
functions = [STRING, ...]  # Custom template functions to load

[marketplace]
registry_url = STRING      # Package registry URL
cache_dir = STRING         # Downloaded packages cache (default: .ggen/cache/)
verify_signatures = BOOL   # Verify package signatures (default: true)

[output]
formatting = STRING        # Code formatter: "default" | "rustfmt" | "prettier" (default: "default")
line_length = INTEGER      # Max line length (default: 100)
indent = INTEGER           # Indentation spaces (default: 2)
```

### Minimal Example

```toml
[project]
name = "my-project"
version = "1.0.0"
description = "Code generation from RDF ontologies"

[generation]
ontology_dir = "schema/"
output_dir = "generated/"
```

### Complete Example

```toml
[project]
name = "commerce-api"
version = "2.1.0"
description = "E-commerce domain model and code generation"
authors = ["Alice Dev <alice@example.com>", "Bob Smith <bob@example.com>"]
license = "MIT"

[generation]
ontology_dir = "ontologies/"
templates_dir = "templates/"
output_dir = "src/generated/"
incremental = true
overwrite = false

[sync]
enabled = true
on_change = "save"
validate_after = true
conflict_mode = "warn"

[rdf]
formats = ["turtle", "rdf-xml"]
default_format = "turtle"
base_uri = "https://example.com/ontology/"
strict_validation = true

[templates]
enable_caching = true
auto_reload = true
functions = ["custom_validators", "domain_extensions"]

[marketplace]
registry_url = "https://marketplace.ggen.io"
cache_dir = ".ggen/cache"
verify_signatures = true

[output]
formatting = "rustfmt"
line_length = 100
indent = 4
```

### Configuration Sections

#### [project]

**Purpose**: Define project metadata and identity

| Key | Type | Description |
|-----|------|-------------|
| `name` | String | Unique project identifier (alphanumeric, hyphens) |
| `version` | String | Semantic version (X.Y.Z format) |
| `description` | String | One-line project description |
| `authors` | Array | Author list with email |
| `license` | String | SPDX license identifier |

#### [generation]

**Purpose**: Control code generation behavior

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `ontology_dir` | String | `schema/` | Where RDF ontologies live |
| `templates_dir` | String | `templates/` | Where Tera templates live |
| `output_dir` | String | `generated/` | Generated code output location |
| `incremental` | Boolean | `true` | Only regenerate changed parts |
| `overwrite` | Boolean | `false` | Overwrite existing files (destructive) |

#### [sync]

**Purpose**: Configure `ggen sync` behavior

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `enabled` | Boolean | `true` | Enable sync operations |
| `on_change` | String | `"save"` | Trigger event for sync |
| `validate_after` | Boolean | `true` | Run validation after sync |
| `conflict_mode` | String | `"fail"` | Behavior on sync conflicts |

**on_change Values**:
- `"save"`: Trigger on file save (editor integration)
- `"commit"`: Trigger on git commit (pre-commit hook)
- `"manual"`: Require explicit `ggen sync` invocation

**conflict_mode Values**:
- `"fail"`: Stop sync, report conflicts (safe)
- `"warn"`: Report conflicts, continue (log-only)
- `"ignore"`: Silently skip conflicting files

#### [rdf]

**Purpose**: Configure RDF processing

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `formats` | Array | `["turtle"]` | Supported RDF formats |
| `default_format` | String | `"turtle"` | Default format for new files |
| `base_uri` | String | None | Base URI for ontology (optional) |
| `strict_validation` | Boolean | `false` | Enforce strict RDF validation |

**Supported Formats**:
- `"turtle"` - Turtle format (.ttl)
- `"rdf-xml"` - RDF/XML format (.rdf, .xml)
- `"n-triples"` - N-Triples format (.nt)

#### [templates]

**Purpose**: Configure template engine (Tera)

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `enable_caching` | Boolean | `true` | Cache compiled templates |
| `auto_reload` | Boolean | `true` | Reload on file change (dev) |
| `functions` | Array | `[]` | Custom template functions |

#### [marketplace]

**Purpose**: Configure package registry integration

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `registry_url` | String | Official registry | Package registry endpoint |
| `cache_dir` | String | `.ggen/cache/` | Downloaded packages cache |
| `verify_signatures` | Boolean | `true` | Verify package signatures |

#### [output]

**Purpose**: Configure generated code formatting

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `formatting` | String | `"default"` | Code formatter to use |
| `line_length` | Integer | `100` | Maximum line length |
| `indent` | Integer | `2` | Indentation width (spaces) |

**Formatting Options**:
- `"default"` - No formatting
- `"rustfmt"` - Rust code formatter
- `"prettier"` - JavaScript/TypeScript formatter
- `"black"` - Python formatter

### Validation

#### File Validation

```bash
ggen config validate ggen.toml
```

Returns exit code 0 if valid, non-zero if invalid.

#### Required Fields

| Field | When Required |
|-------|---------------|
| `[project].name` | Always |
| `[project].version` | If publishing to marketplace |
| `[generation].ontology_dir` | If using sync |
| `[generation].output_dir` | If using generation |

#### Common Errors

| Error | Cause | Fix |
|-------|-------|-----|
| `Invalid version "1.0"` | Not semantic version | Use `X.Y.Z` format |
| `Unknown RDF format "rdfx"` | Typo in format name | Use `"rdf-xml"` |
| `Directory not found: schema/` | `ontology_dir` doesn't exist | Create directory or fix path |
| `Invalid line_length: -1` | Negative integer | Use positive integer |

### Environment Variables

Expand values using `${VAR_NAME}`:

```toml
[generation]
ontology_dir = "${SCHEMA_DIR:/schema}"  # Use SCHEMA_DIR or default to /schema
output_dir = "${OUT_DIR:generated/}"    # Use OUT_DIR or default to generated/
```

### Override from CLI

```bash
ggen sync --config-override generation.output_dir=custom_output/
```

### Include External Config

```toml
[include]
files = ["ggen.shared.toml", "ggen.${ENVIRONMENT}.toml"]
```

---

## ggen.toml vs gpack.toml

| Aspect | ggen.toml | gpack.toml |
|--------|-----------|-----------|
| **Purpose** | Project-wide configuration | Package distribution metadata |
| **Location** | Repository root | Package root |
| **Scope** | One workspace | Distributable package |
| **Audience** | Developers (local) | Package users (published) |
| **Publishing** | Not published | Published to marketplace |

### gpack.toml Schema

```toml
[package]
name = STRING              # Package identifier
version = STRING           # Semantic version
author = STRING            # Package author
email = STRING             # Contact email
description = STRING       # Package description
license = STRING           # SPDX license
repository = STRING        # Git repository URL
documentation = STRING     # Documentation URL
keywords = [STRING, ...]   # Search keywords

[templates]
templates = [STRING, ...]  # Template files to include

[dependencies]
requires = [STRING, ...]   # Version requirements (e.g., "ggen >= 4.0.0")
```

---

## Integration: ggen sync + ggen.toml

### Workflow

1. **Configure** → Define `ggen.toml`
2. **Sync** → Run `ggen sync` to synchronize artifacts
3. **Validate** → Check output consistency
4. **Commit** → Git commit generated code (if desired)
5. **Update** → Modify ontology → Re-sync

### Example Project Structure

```
my-project/
├── ggen.toml                    # Project configuration
├── schema/
│   ├── domain.ttl               # RDF ontology
│   └── validations.ttl          # OWL constraints
├── templates/
│   ├── rust-struct.tmpl         # Tera template
│   └── ts-interface.tmpl        # Tera template
├── src/
│   ├── generated/               # Output of ggen sync
│   │   ├── domain.rs
│   │   ├── types.ts
│   │   └── .manifest            # Sync metadata
│   └── main.rs
└── Cargo.toml                   # Rust workspace
```

### CI/CD Integration

```bash
# Verify consistency
ggen sync --mode verify || exit 1

# Generate artifacts
ggen sync --mode full

# Commit if changed
git add -A && git commit -m "chore: sync generated code" || true
```

---

## Machine-Parseable Schemas

### ggen sync JSON Schema

```json
{
  "command": "sync",
  "options": {
    "from": "string|null",
    "to": "string|null",
    "mode": "full|incremental|verify",
    "verbose": "boolean",
    "dry-run": "boolean",
    "force": "boolean"
  },
  "exit_codes": {
    "0": "success",
    "1": "sync_conflicts",
    "2": "config_error",
    "3": "invalid_ontology",
    "4": "permission_denied"
  }
}
```

### ggen.toml TOML Schema

```toml
[schema]
version = "1.0"

[schema.sections]
project = "required"
generation = "required"
sync = "optional"
rdf = "optional"
templates = "optional"
marketplace = "optional"
output = "optional"

[schema.types]
STRING = "text"
BOOL = "boolean"
INTEGER = "integer"
ARRAY = "array of strings"
```

---

## See Also

- **Full Documentation**: [docs/](docs/)
- **Contributing**: [CONTRIBUTING.md](CONTRIBUTING.md)
- **Examples**: [examples/](examples/)
- **API Reference**: [docs/reference/](docs/reference/)
