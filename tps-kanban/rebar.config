%% Rebar3 configuration for TPS Kanban - Pull-based work queue system
%% NATS (primary) + RabbitMQ (fallback) for production Kanban patterns

{erl_opts, [
    debug_info,
    warnings_as_errors,
    {parse_transform, lager_transform}
]}.

{deps, [
    %% Logging
    {lager, "3.9.2"},

    %% NATS client - lightweight, fast messaging
    {gnat, "1.5.0"},

    %% RabbitMQ fallback - persistence and backup
    {amqp_client, "3.13.2"},

    %% Metrics and observability
    {prometheus, "4.10.0"},
    {prometheus_process_collector, "1.4.0"},

    %% JSON support
    {jiffy, "1.1.1"},

    %% Time utilities
    {erlang_localtime, "1.0.0"},

    %% Testing
    {eunit, "2.3.7"},
    {common_test, "1.18.0"},
    {testcontainers, "1.4.0"}
]}.

%% Build profiles
{profiles, [
    {dev, [
        {erl_opts, [
            debug_info,
            {parse_transform, lager_transform}
        ]},
        {relx, [
            {dev_mode, true},
            {include_erts, false}
        ]}
    ]},

    {prod, [
        {erl_opts, [
            {parse_transform, lager_transform},
            warn_missing_spec,
            warn_missing_spec_all
        ]},
        {relx, [
            {dev_mode, false},
            {include_erts, true}
        ]}
    ]},

    {test, [
        {erl_opts, [
            debug_info,
            {parse_transform, lager_transform}
        ]}
    ]}
]}.

%% Common test options
{ct_opts, [
    {sys_config, ["test/sys.config"]},
    {config, ["test/test.config"]}
]}.

%% Relx configuration
{relx, [
    {release, {tps_kanban, "1.0.0"}, [
        kernel,
        stdlib,
        sasl,
        lager,
        gnat,
        amqp_client,
        prometheus,
        tps_kanban
    ]},
    {sys_config, "config/sys.config"},
    {vm_args, "config/vm.args"},
    {overlay, [
        {mkdir, "log"}
    ]}
]}.

%% Plugins
{plugins, [
    rebar3_lint,
    rebar3_format
]}.

%% Format options
{format, [
    {formatter, rebar3_format},
    {formatter_config, [{space_around_nested_parentheses, false}]}
]}.
