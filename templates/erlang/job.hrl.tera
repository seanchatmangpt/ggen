{% set author = author | default(value="Generated by ggen") -%}
%%%-------------------------------------------------------------------
%%% @author {{ author }}
%%% @copyright (C) {% raw %}{{{% endraw %} current_year {% raw %}}}{% endraw %}, {{ author }}
%%% @doc
%%% Job record definitions and type specifications.
%%%
%%% This header file defines the core data structures for the job
%%% processing system.
%%%
%%% SPARQL Integration:
%%% Record fields can be populated from RDF ontologies defining:
%%% - Job properties and metadata
%%% - Status enumerations
%%% - Priority levels
%%% - Custom field definitions
%%%
%%% @end
%%% Created : {% raw %}{{{% endraw %} timestamp {% raw %}}}{% endraw %}
%%%-------------------------------------------------------------------

-ifndef(JOB_HRL).
-define(JOB_HRL, true).

%%%===================================================================
%%% Job Status Enumeration
%%%===================================================================

-type job_status() :: pending |
                     queued |
                     running |
                     completed |
                     failed |
                     retrying |
                     cancelled.

%%%===================================================================
%%% Job Priority Levels
%%%===================================================================

-type job_priority() :: integer(). %% Higher number = higher priority

-define(PRIORITY_LOW, {{ priority_low | default(value=0) }}).
-define(PRIORITY_NORMAL, {{ priority_normal | default(value=5) }}).
-define(PRIORITY_HIGH, {{ priority_high | default(value=10) }}).
-define(PRIORITY_CRITICAL, {{ priority_critical | default(value=20) }}).

%%%===================================================================
%%% Job Record Definition
%%%===================================================================

-record(job, {
    %% Unique job identifier
    id :: binary() | undefined,

    %% Job type/category
    type :: atom() | binary() | undefined,

    %% Job payload data
    data :: map() | term() | undefined,

    %% Job priority (higher = more important)
    priority = ?PRIORITY_NORMAL :: job_priority(),

    %% Current job status
    status = pending :: job_status(),

    %% Number of retry attempts
    retries = 0 :: non_neg_integer(),

    %% Maximum allowed retries
    max_retries = {{ max_retries | default(value=3) }} :: non_neg_integer(),

    %% Job timeout in milliseconds
    timeout = {{ timeout | default(value=5000) }} :: pos_integer(),

    %% Creation timestamp
    created_at :: erlang:timestamp() | undefined,

    %% Start processing timestamp
    started_at :: erlang:timestamp() | undefined,

    %% Completion timestamp
    completed_at :: erlang:timestamp() | undefined,

    %% Error information (if failed)
    error :: term() | undefined,

    %% Job result (if completed)
    result :: term() | undefined,

    %% Custom metadata
    metadata = #{} :: map(),

    %% Tags for categorization/filtering
    tags = [] :: [atom() | binary()]

    {% if custom_fields %}
    %% Custom fields from ontology
    {% for field in custom_fields %}
    ,{{ field.name }} = {{ field.default | default(value="undefined") }} :: {{ field.type | default(value="term()") }}
    {% endfor %}
    {% endif %}
}).

-type job() :: #job{}.

%%%===================================================================
%%% Job Queue Statistics Record
%%%===================================================================

-record(queue_stats, {
    %% Total jobs enqueued
    total_enqueued = 0 :: non_neg_integer(),

    %% Total jobs processed
    total_processed = 0 :: non_neg_integer(),

    %% Total jobs failed
    total_failed = 0 :: non_neg_integer(),

    %% Current queue size
    current_size = 0 :: non_neg_integer(),

    %% Average processing time (milliseconds)
    avg_processing_time = 0 :: non_neg_integer(),

    %% Peak queue size
    peak_size = 0 :: non_neg_integer(),

    %% Queue creation timestamp
    created_at :: erlang:timestamp() | undefined,

    %% Last update timestamp
    updated_at :: erlang:timestamp() | undefined
}).

-type queue_stats() :: #queue_stats{}.

%%%===================================================================
%%% Worker State Record
%%%===================================================================

-record(worker_state, {
    %% Worker ID
    id :: term() | undefined,

    %% Current job being processed
    current_job :: job() | undefined,

    %% Worker status
    status = idle :: idle | busy | stopped,

    %% Jobs processed by this worker
    jobs_processed = 0 :: non_neg_integer(),

    %% Jobs failed by this worker
    jobs_failed = 0 :: non_neg_integer(),

    %% Worker start timestamp
    started_at :: erlang:timestamp() | undefined,

    %% Last job completion timestamp
    last_activity :: erlang:timestamp() | undefined
}).

-type worker_state() :: #worker_state{}.

%%%===================================================================
%%% Utility Macros
%%%===================================================================

%% Create a new job with minimal fields
-define(NEW_JOB(Id, Type, Data),
    #job{
        id = Id,
        type = Type,
        data = Data,
        created_at = erlang:timestamp()
    }
).

%% Create a high priority job
-define(HIGH_PRIORITY_JOB(Id, Type, Data),
    #job{
        id = Id,
        type = Type,
        data = Data,
        priority = ?PRIORITY_HIGH,
        created_at = erlang:timestamp()
    }
).

%% Check if job is in terminal state
-define(IS_TERMINAL_STATUS(Status),
    (Status =:= completed orelse
     Status =:= failed orelse
     Status =:= cancelled)
).

%% Check if job can be retried
-define(CAN_RETRY(Job),
    (Job#job.retries < Job#job.max_retries andalso
     not ?IS_TERMINAL_STATUS(Job#job.status))
).

%%%===================================================================
%%% Type Exports
%%%===================================================================

-export_type([
    job/0,
    job_status/0,
    job_priority/0,
    queue_stats/0,
    worker_state/0
]).

-endif. %% JOB_HRL
