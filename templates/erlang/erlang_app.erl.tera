{% set app_name = app_name | default(value="myapp") -%}
{% set description = description | default(value="OTP Application") -%}
{% set author = author | default(value="Generated by ggen") -%}
%%%-------------------------------------------------------------------
%%% @author {{ author }}
%%% @copyright (C) {% raw %}{{{% endraw %} current_year {% raw %}}}{% endraw %}, {{ author }}
%%% @doc
%%% {{ description }}
%%%
%%% This module implements the application behavior for {{ app_name }}.
%%% It handles application lifecycle (start/stop) and manages the
%%% top-level supervision tree.
%%%
%%% SPARQL Context:
%%% This template can query RDF ontologies for:
%%% - Application configuration (modules, dependencies)
%%% - Environment variables and settings
%%% - Application metadata (version, description, authors)
%%%
%%% Multi-pass rendering:
%%% Pass 1: Extract application metadata from ontology
%%% Pass 2: Populate configuration and dependencies
%%% Pass 3: Generate final code with all context
%%%
%%% @end
%%% Created : {% raw %}{{{% endraw %} timestamp {% raw %}}}{% endraw %}
%%%-------------------------------------------------------------------
-module({{ app_name }}_app).

-behaviour(application).

%% Application callbacks
-export([start/2, stop/1]).

%% API exports
-export([
    config/1,
    config/2
]).

-define(APP, {{ app_name }}).

%%%===================================================================
%%% Application callbacks
%%%===================================================================

%%--------------------------------------------------------------------
%% @doc
%% This function is called whenever an application is started using
%% application:start/[1,2], and should start the processes of the
%% application. If the application is structured according to the OTP
%% design principles as a supervision tree, this means starting the
%% top supervisor of the tree.
%%
%% @end
%%--------------------------------------------------------------------
-spec start(StartType :: normal | {takeover, node()} | {failover, node()},
            StartArgs :: term()) ->
    {ok, pid()} |
    {ok, pid(), State :: term()} |
    {error, Reason :: term()}.
start(_StartType, _StartArgs) ->
    %% Initialize application environment
    ok = init_environment(),

    %% Log application startup
    logger:info("Starting {{ app_name }} application", []),

    %% Start top-level supervisor
    case {{ app_name }}_sup:start_link() of
        {ok, Pid} ->
            logger:info("{{ app_name }} application started successfully", []),
            {ok, Pid};
        {error, Reason} = Error ->
            logger:error("Failed to start {{ app_name }} application: ~p", [Reason]),
            Error
    end.

%%--------------------------------------------------------------------
%% @doc
%% This function is called whenever an application has stopped. It
%% is intended to be the opposite of Module:start/2 and should do
%% any necessary cleaning up. The return value is ignored.
%%
%% @end
%%--------------------------------------------------------------------
-spec stop(State :: term()) -> ok.
stop(_State) ->
    logger:info("Stopping {{ app_name }} application", []),
    %% Perform cleanup
    ok = cleanup_environment(),
    logger:info("{{ app_name }} application stopped", []),
    ok.

%%%===================================================================
%%% API functions
%%%===================================================================

%%--------------------------------------------------------------------
%% @doc
%% Get application configuration value.
%%
%% @end
%%--------------------------------------------------------------------
-spec config(Key :: atom()) -> term() | undefined.
config(Key) ->
    config(Key, undefined).

%%--------------------------------------------------------------------
%% @doc
%% Get application configuration value with default.
%%
%% @end
%%--------------------------------------------------------------------
-spec config(Key :: atom(), Default :: term()) -> term().
config(Key, Default) ->
    application:get_env(?APP, Key, Default).

%%%===================================================================
%%% Internal functions
%%%===================================================================

%%--------------------------------------------------------------------
%% @private
%% @doc
%% Initialize application environment and settings.
%%
%% @end
%%--------------------------------------------------------------------
-spec init_environment() -> ok.
init_environment() ->
    %% Set default configuration if not present
    DefaultConfig = [
        {workers, {{ workers | default(value=4) }}},
        {max_queue_size, {{ max_queue_size | default(value=1000) }}},
        {timeout, {{ timeout | default(value=5000) }}}
        {% if extra_config %}
        ,{% for key, value in extra_config %}
        { {{key}}, {{value}} }{% if not loop.last %},{% endif %}
        {% endfor %}
        {% endif %}
    ],

    lists:foreach(
        fun({Key, Value}) ->
            case application:get_env(?APP, Key) of
                undefined -> application:set_env(?APP, Key, Value);
                _ -> ok
            end
        end,
        DefaultConfig
    ),
    ok.

%%--------------------------------------------------------------------
%% @private
%% @doc
%% Cleanup application environment and resources.
%%
%% @end
%%--------------------------------------------------------------------
-spec cleanup_environment() -> ok.
cleanup_environment() ->
    %% Perform any necessary cleanup
    %% This is a placeholder for custom cleanup logic
    ok.

%%%===================================================================
%%% Unit Tests
%%%===================================================================

-ifdef(TEST).
-include_lib("eunit/include/eunit.hrl").

config_test_() ->
    {setup,
     fun() ->
         %% Setup
         application:set_env(?APP, test_key, test_value)
     end,
     fun(_) ->
         %% Cleanup
         application:unset_env(?APP, test_key)
     end,
     [
      ?_assertEqual(test_value, config(test_key)),
      ?_assertEqual(undefined, config(non_existent_key)),
      ?_assertEqual(default, config(non_existent_key, default))
     ]
    }.

init_environment_test() ->
    ?assertEqual(ok, init_environment()),
    ?assertMatch(Value when is_integer(Value), config(workers)).

-endif.
