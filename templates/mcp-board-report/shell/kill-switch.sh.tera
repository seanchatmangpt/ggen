#!/usr/bin/env bash
# =============================================================================
# MCP+ Kill Switch Control Script
#
# Emergency control for halting all automated operations.
# Board-grade authority with cryptographic receipt generation.
#
# Core axiom: A = μ(O), μ ∘ μ = μ, hash(A) = hash(μ(O)), O ⊨ Σ
#
# Generated by ggen - DO NOT EDIT MANUALLY
# Regenerate with: ggen sync --audit true
# =============================================================================

set -euo pipefail

# Configuration
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly CONFIG_DIR="${SCRIPT_DIR}/../config"
readonly LOG_DIR="${SCRIPT_DIR}/../logs"
readonly RECEIPT_DIR="${SCRIPT_DIR}/../receipts"
readonly MCP_NODE="${MCP_NODE:-mcp@localhost}"

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m' # No Color

# Ensure directories exist
mkdir -p "${LOG_DIR}" "${RECEIPT_DIR}"

# Logging
log() {
    local level="$1"
    shift
    local message="$*"
    local timestamp
    timestamp=$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
    echo -e "${timestamp} [${level}] ${message}" | tee -a "${LOG_DIR}/kill-switch.log"
}

log_critical() { log "CRITICAL" "${RED}$*${NC}"; }
log_warning() { log "WARNING" "${YELLOW}$*${NC}"; }
log_info() { log "INFO" "${GREEN}$*${NC}"; }

# Generate receipt for kill switch action
generate_receipt() {
    local action="$1"
    local target="${2:-global}"
    local timestamp
    local receipt_id
    local receipt_file

    timestamp=$(date -u +"%Y-%m-%dT%H:%M:%S.%6NZ")
    receipt_id="kill-$(date +%s%N | sha256sum | head -c 16)"
    receipt_file="${RECEIPT_DIR}/${receipt_id}.json"

    cat > "${receipt_file}" << EOF
{
    "type": "kill_switch",
    "receipt_id": "${receipt_id}",
    "timestamp": "${timestamp}",
    "action": "${action}",
    "target": "${target}",
    "executor": "${USER}",
    "hostname": "$(hostname)",
    "pid": "$$"
}
EOF

    echo "${receipt_file}"
}

# Invoke Erlang RPC
erl_rpc() {
    local module="$1"
    local function="$2"
    shift 2
    local args="$*"

    erl -noshell -name "kill_switch_$$@localhost" \
        -setcookie mcp_cookie \
        -eval "rpc:call('${MCP_NODE}', ${module}, ${function}, [${args}]), halt()."
}

# Command: disable_global
cmd_disable_global() {
    log_critical "GLOBAL KILL SWITCH ACTIVATED"
    log_critical "All contract execution will be halted immediately"

    local receipt_file
    receipt_file=$(generate_receipt "disable_global")

    # Invoke Erlang
    if erl_rpc mcp_kill_switch disable_global; then
        log_critical "Global kill switch ACTIVE - all operations halted"
        log_info "Receipt: ${receipt_file}"
        return 0
    else
        log_critical "Failed to activate global kill switch!"
        return 1
    fi
}

# Command: enable_global
cmd_enable_global() {
    log_warning "Attempting to re-enable global operations"
    log_warning "This requires explicit authorization"

    read -rp "Type 'ENABLE GLOBAL' to confirm: " confirmation
    if [[ "${confirmation}" != "ENABLE GLOBAL" ]]; then
        log_info "Operation cancelled"
        return 1
    fi

    local receipt_file
    receipt_file=$(generate_receipt "enable_global")

    if erl_rpc mcp_kill_switch enable_global; then
        log_warning "Global kill switch DISABLED - operations resumed"
        log_info "Receipt: ${receipt_file}"
        return 0
    else
        log_critical "Failed to disable global kill switch!"
        return 1
    fi
}

# Command: disable_family
cmd_disable_family() {
    local family_id="$1"

    if [[ -z "${family_id}" ]]; then
        log_critical "Family ID required"
        return 1
    fi

    log_critical "Disabling contract family: ${family_id}"

    local receipt_file
    receipt_file=$(generate_receipt "disable_family" "${family_id}")

    if erl_rpc mcp_kill_switch disable_family "<<\"${family_id}\">>"; then
        log_critical "Family ${family_id} DISABLED"
        log_info "Receipt: ${receipt_file}"
        return 0
    else
        log_critical "Failed to disable family ${family_id}"
        return 1
    fi
}

# Command: revoke_epoch
cmd_revoke_epoch() {
    local epoch_id="$1"

    if [[ -z "${epoch_id}" ]]; then
        log_critical "Epoch ID required"
        return 1
    fi

    log_critical "Revoking signing key epoch: ${epoch_id}"
    log_critical "Contracts signed with this epoch will be REFUSED"

    local receipt_file
    receipt_file=$(generate_receipt "revoke_epoch" "${epoch_id}")

    if erl_rpc mcp_kill_switch revoke_epoch "<<\"${epoch_id}\">>"; then
        log_critical "Epoch ${epoch_id} REVOKED"
        log_info "Receipt: ${receipt_file}"
        return 0
    else
        log_critical "Failed to revoke epoch ${epoch_id}"
        return 1
    fi
}

# Command: status
cmd_status() {
    log_info "Querying kill switch status..."

    erl_rpc mcp_kill_switch status 2>/dev/null || {
        echo "Unable to connect to MCP node"
        return 1
    }
}

# Command: drill
cmd_drill() {
    local drill_type="${1:-global}"

    log_warning "Initiating kill switch DRILL: ${drill_type}"
    log_warning "This is a simulated test - no actual operations will be affected"

    local receipt_file
    receipt_file=$(generate_receipt "drill" "${drill_type}")

    if erl_rpc mcp_kill_switch drill "${drill_type}"; then
        log_info "Drill completed successfully"
        log_info "Receipt: ${receipt_file}"
        return 0
    else
        log_critical "Drill FAILED - investigate immediately"
        return 1
    fi
}

# Print usage
usage() {
    cat << EOF
MCP+ Kill Switch Control

Usage: $(basename "$0") <command> [options]

Commands:
    disable-global      Halt ALL contract execution globally
    enable-global       Re-enable global contract execution (requires confirmation)
    disable-family      Disable a specific contract family
    enable-family       Re-enable a specific contract family
    disable-capability  Disable a specific capability
    revoke-epoch       Revoke a signing key epoch
    status             Show current kill switch status
    drill              Execute a kill switch drill

Options:
    -h, --help         Show this help message

Examples:
    $(basename "$0") disable-global
    $(basename "$0") disable-family vendor-onboarding
    $(basename "$0") revoke-epoch epoch-2026-q1
    $(basename "$0") drill global
    $(basename "$0") status

Environment:
    MCP_NODE           Erlang node name (default: mcp@localhost)

EOF
}

# Main entry point
main() {
    local command="${1:-}"

    case "${command}" in
        disable-global)
            cmd_disable_global
            ;;
        enable-global)
            cmd_enable_global
            ;;
        disable-family)
            cmd_disable_family "${2:-}"
            ;;
        enable-family)
            cmd_enable_family "${2:-}"
            ;;
        revoke-epoch)
            cmd_revoke_epoch "${2:-}"
            ;;
        status)
            cmd_status
            ;;
        drill)
            cmd_drill "${2:-global}"
            ;;
        -h|--help)
            usage
            ;;
        *)
            usage
            exit 1
            ;;
    esac
}

main "$@"
