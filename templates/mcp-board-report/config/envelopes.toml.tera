# =============================================================================
# MCP+ Envelope Policy Configuration
#
# Defines default envelope bounds and policies for contract execution.
# All operations must execute within defined envelopes.
# FAIL-CLOSED: Violations produce deterministic refusals.
#
# Core axiom: A = μ(O), μ ∘ μ = μ, hash(A) = hash(μ(O)), O ⊨ Σ
#
# Generated by ggen - DO NOT EDIT MANUALLY
# Regenerate with: ggen sync --audit true
# =============================================================================

[envelope.policy]
version = "1.0.0"
fail_closed = true
uncertainty_action = "refuse"

# -----------------------------------------------------------------------------
# Default Envelope Bounds
# -----------------------------------------------------------------------------

[envelope.defaults]
# Time bounds
max_duration_ms = 30000           # 30 seconds
warning_threshold_ms = 25000      # Warn at 25 seconds

# Resource bounds
max_memory_bytes = 104857600      # 100 MB
max_cpu_percent = 80              # 80% of allocated CPU
max_io_bytes = 10485760           # 10 MB I/O

# Operation bounds
max_operations = 1000             # Max operations per envelope
max_depth = 10                    # Max call depth

# -----------------------------------------------------------------------------
# Tier-Specific Envelope Policies
# -----------------------------------------------------------------------------

[envelope.tiers.tier_a]
name = "Tier A - Automate"
description = "High-confidence automation workflows"

[envelope.tiers.tier_a.time]
max_duration_ms = 60000           # 60 seconds
extension_allowed = false

[envelope.tiers.tier_a.resources]
max_memory_bytes = 209715200      # 200 MB
max_cpu_percent = 90

[envelope.tiers.tier_a.capabilities]
allowed = [
    "read",
    "write",
    "query",
    "validate",
    "transform",
    "notify"
]
denied = [
    "delete_permanent",
    "admin",
    "key_management"
]

# -----------------------------------------------------------------------------

[envelope.tiers.tier_b]
name = "Tier B - Assist"
description = "Human-supervised operations"

[envelope.tiers.tier_b.time]
max_duration_ms = 120000          # 120 seconds
extension_allowed = true
max_extensions = 2

[envelope.tiers.tier_b.resources]
max_memory_bytes = 104857600      # 100 MB
max_cpu_percent = 50

[envelope.tiers.tier_b.capabilities]
allowed = [
    "read",
    "query",
    "suggest",
    "draft",
    "prepare"
]
denied = [
    "write",
    "delete",
    "approve",
    "admin"
]
requires_human_approval = [
    "submit",
    "finalize"
]

# -----------------------------------------------------------------------------
# Scope Policies
# -----------------------------------------------------------------------------

[envelope.scopes]

[envelope.scopes.customer_data]
allowed_operations = ["read", "query", "validate"]
denied_operations = ["export", "bulk_read"]
requires_audit_log = true
pii_handling = "masked"

[envelope.scopes.financial_data]
allowed_operations = ["read", "query", "reconcile"]
denied_operations = ["modify", "delete"]
requires_audit_log = true
dual_approval = true

[envelope.scopes.system_config]
allowed_operations = ["read"]
denied_operations = ["write", "delete", "modify"]
admin_only = true

[envelope.scopes.audit_trail]
allowed_operations = ["read", "append"]
denied_operations = ["modify", "delete"]
immutable = true

# -----------------------------------------------------------------------------
# Refusal Policies
# -----------------------------------------------------------------------------

[envelope.refusals]

[envelope.refusals.time_exceeded]
code = "ENV-001"
category = "envelope_violation"
severity = "high"
action = "terminate_immediately"
retry_allowed = false

[envelope.refusals.memory_exceeded]
code = "ENV-002"
category = "envelope_violation"
severity = "high"
action = "terminate_immediately"
retry_allowed = false

[envelope.refusals.scope_violation]
code = "ENV-003"
category = "envelope_violation"
severity = "medium"
action = "refuse_operation"
retry_allowed = true

[envelope.refusals.capability_denied]
code = "ENV-004"
category = "envelope_violation"
severity = "medium"
action = "refuse_operation"
retry_allowed = false

# -----------------------------------------------------------------------------
# Extension Policies
# -----------------------------------------------------------------------------

[envelope.extensions]
enabled = true
max_extensions_per_envelope = 3
max_extension_duration_ms = 30000
requires_justification = true
audit_all_extensions = true

[envelope.extensions.approval]
auto_approve_threshold_ms = 10000
human_approval_required_above_ms = 30000
escalation_after_extensions = 2

# -----------------------------------------------------------------------------
# Monitoring and Alerting
# -----------------------------------------------------------------------------

[envelope.monitoring]
enabled = true
sample_rate = 1.0                 # 100% of envelopes
metrics_interval_ms = 1000

[envelope.monitoring.alerts]
time_warning_threshold_percent = 80
memory_warning_threshold_percent = 75
operations_warning_threshold_percent = 90

[envelope.monitoring.alert_channels]
slack_webhook = "{{ slack_webhook | default(value='') }}"
pagerduty_key = "{{ pagerduty_key | default(value='') }}"
email = "{{ alert_email | default(value='ops@example.com') }}"

# -----------------------------------------------------------------------------
# Validation Rules
# -----------------------------------------------------------------------------

[envelope.validation]

# Pre-execution validation
[envelope.validation.pre_execution]
verify_signature = true
check_expiration = true
validate_bounds = true
check_kill_switch = true

# Runtime validation
[envelope.validation.runtime]
continuous_bound_check = true
check_interval_ms = 100
fail_fast = true

# Post-execution validation
[envelope.validation.post_execution]
generate_receipt = true
verify_completion = true
record_metrics = true
