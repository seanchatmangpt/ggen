# GitHub Actions workflow for {{ app_name }}
# Runs comprehensive test suite with testcontainers
#
# Test stages:
# 1. Unit tests (no containers, fast feedback)
# 2. Integration tests (with testcontainers)
# 3. Chaos engineering tests (container failures)
# 4. Performance benchmarks (multi-backend comparison)
# 5. Security audit (dependency scanning)

name: Test with Testcontainers

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

env:
  OTP_VERSION: '26.0'
  REBAR3_VERSION: '3.22.0'
  ERLANG_COOKIE: 'test-cookie-do-not-use-in-production'

jobs:
  # ===================================================================
  # Job 1: Fast feedback with unit tests (no Docker)
  # ===================================================================
  unit-tests:
    name: Unit Tests (No Containers)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            _build
            rebar3
          key: {% raw %}${{ runner.os }}{% endraw %}-otp-{% raw %}${{ env.OTP_VERSION }}{% endraw %}-{% raw %}${{ hashFiles('rebar.lock') }}{% endraw %}
          restore-keys: |
            {% raw %}${{ runner.os }}{% endraw %}-otp-{% raw %}${{ env.OTP_VERSION }}{% endraw %}-

      - name: Compile application
        run: rebar3 compile

      - name: Run EUnit tests
        run: rebar3 eunit --verbose
        timeout-minutes: 5

      - name: Upload EUnit results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: eunit-results
          path: _build/test/logs/

  # ===================================================================
  # Job 2: Integration tests with testcontainers
  # ===================================================================
  integration-tests:
    name: Integration Tests (Testcontainers)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests

    services:
      # Use Docker-in-Docker for testcontainers
      docker:
        image: docker:dind
        options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            _build
            rebar3
          key: {% raw %}${{ runner.os }}{% endraw %}-otp-{% raw %}${{ env.OTP_VERSION }}{% endraw %}-{% raw %}${{ hashFiles('rebar.lock') }}{% endraw %}

      - name: Pre-pull Docker images (optimization)
        run: |
          docker pull redis:7.0-alpine
          docker pull postgres:16-alpine

      - name: Compile application
        run: rebar3 compile

      - name: Run Common Test suites
        run: |
          rebar3 ct \
            --suite redis_backend_SUITE \
            --suite postgres_backend_SUITE \
            --suite testcontainers_SUITE \
            --verbose
        timeout-minutes: 15

      - name: Upload CT results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ct-results
          path: |
            _build/test/logs/
            _build/test/cover/

      - name: Generate coverage report
        if: always()
        run: rebar3 cover --verbose

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: _build/test/cover/cobertura.xml
          flags: integration
          name: integration-coverage

  # ===================================================================
  # Job 3: Chaos engineering tests
  # ===================================================================
  chaos-tests:
    name: Chaos Engineering Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: integration-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            _build
            rebar3
          key: {% raw %}${{ runner.os }}{% endraw %}-otp-{% raw %}${{ env.OTP_VERSION }}{% endraw %}-{% raw %}${{ hashFiles('rebar.lock') }}{% endraw %}

      - name: Pre-pull Docker images
        run: |
          docker pull redis:7.0-alpine
          docker pull postgres:16-alpine

      - name: Compile application
        run: rebar3 compile

      - name: Run chaos engineering tests
        run: |
          rebar3 ct \
            --suite chaos_engineering_SUITE \
            --verbose
        timeout-minutes: 25

      - name: Upload chaos test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: chaos-test-results
          path: _build/test/logs/

  # ===================================================================
  # Job 4: Performance benchmarks
  # ===================================================================
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: integration-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            _build
            rebar3
          key: {% raw %}${{ runner.os }}{% endraw %}-otp-{% raw %}${{ env.OTP_VERSION }}{% endraw %}-{% raw %}${{ hashFiles('rebar.lock') }}{% endraw %}

      - name: Pre-pull Docker images
        run: |
          docker pull redis:7.0-alpine
          docker pull postgres:16-alpine

      - name: Compile application
        run: rebar3 compile

      - name: Run performance benchmarks
        run: make benchmark
        timeout-minutes: 20

      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: _build/test/benchmarks/

      - name: Comment benchmark results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const results = fs.readFileSync('_build/test/benchmarks/summary.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Performance Benchmark Results\n\n\`\`\`\n${results}\n\`\`\``
            });

  # ===================================================================
  # Job 5: Property-based tests (PropEr)
  # ===================================================================
  property-tests:
    name: Property-Based Tests (PropEr)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            _build
            rebar3
          key: {% raw %}${{ runner.os }}{% endraw %}-otp-{% raw %}${{ env.OTP_VERSION }}{% endraw %}-{% raw %}${{ hashFiles('rebar.lock') }}{% endraw %}

      - name: Compile application
        run: rebar3 compile

      - name: Run PropEr tests
        run: rebar3 proper --numtests 1000 --verbose
        timeout-minutes: 10

      - name: Upload PropEr results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: proper-results
          path: _build/test/logs/proper/

  # ===================================================================
  # Job 6: Security audit
  # ===================================================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Run Dialyzer
        run: rebar3 dialyzer
        timeout-minutes: 5

      - name: Run security audit
        run: rebar3 audit
        timeout-minutes: 3

      - name: Scan Docker images for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'docker-compose.yml'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # ===================================================================
  # Job 7: Docker build (verify Dockerfile)
  # ===================================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: {% raw %}${{ github.repository }}{% endraw %}:{% raw %}${{ github.sha }}{% endraw %}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker run --rm \
            -e ERLANG_COOKIE=${{ env.ERLANG_COOKIE }} \
            {% raw %}${{ github.repository }}{% endraw %}:{% raw %}${{ github.sha }}{% endraw %} \
            erl -eval 'io:format("Docker image works!~n"), halt(0).'

  # ===================================================================
  # Job 8: Aggregate results
  # ===================================================================
  aggregate:
    name: Aggregate Results
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, chaos-tests, benchmarks, property-tests, security-audit, docker-build]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Unit tests: {% raw %}${{ needs.unit-tests.result }}{% endraw %}"
          echo "Integration tests: {% raw %}${{ needs.integration-tests.result }}{% endraw %}"
          echo "Chaos tests: {% raw %}${{ needs.chaos-tests.result }}{% endraw %}"
          echo "Benchmarks: {% raw %}${{ needs.benchmarks.result }}{% endraw %}"
          echo "Property tests: {% raw %}${{ needs.property-tests.result }}{% endraw %}"
          echo "Security audit: {% raw %}${{ needs.security-audit.result }}{% endraw %}"
          echo "Docker build: {% raw %}${{ needs.docker-build.result }}{% endraw %}"

      - name: Fail if any job failed
        if: |
          needs.unit-tests.result == 'failure' ||
          needs.integration-tests.result == 'failure' ||
          needs.chaos-tests.result == 'failure' ||
          needs.benchmarks.result == 'failure' ||
          needs.property-tests.result == 'failure' ||
          needs.security-audit.result == 'failure' ||
          needs.docker-build.result == 'failure'
        run: exit 1
