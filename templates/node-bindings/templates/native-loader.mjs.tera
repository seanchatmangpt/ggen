{# =============================================================================
   NATIVE LOADER TEMPLATE - Handles loading the native addon (ESM)
   Provides error handling and platform detection
   ============================================================================= #}
/**
 * Native module loader with error handling (ESM)
 * @module native-loader
 */

import { existsSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';
import { createRequire } from 'module';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const require = createRequire(import.meta.url);

/**
 * Load the native addon with proper error handling
 * @returns {Object} Native module
 * @throws {Error} If module cannot be loaded
 */
export function loadNative() {
  const possiblePaths = [
    join(__dirname, 'native', 'index.node'),
    join(__dirname, 'build', 'Release', '{{ module_name | default(value="ggen") }}.node'),
    join(__dirname, 'build', 'Debug', '{{ module_name | default(value="ggen") }}.node'),
  ];

  for (const modulePath of possiblePaths) {
    if (existsSync(modulePath)) {
      try {
        return require(modulePath);
      } catch (error) {
        throw new Error(
          `Found native module at ${modulePath} but failed to load it: ${error.message}`
        );
      }
    }
  }

  throw new Error(
    'Native module not found. Run "npm run build" to compile the native addon.\n' +
    `Searched paths:\n${possiblePaths.map(p => `  - ${p}`).join('\n')}`
  );
}
