FROM rust:1.82-bookworm AS build
WORKDIR /src
COPY controller/Cargo.toml controller/Cargo.lock* ./
COPY controller/src ./src
RUN cargo build --release

FROM debian:bookworm-slim

# --- runtime deps ---
RUN apt-get update && apt-get install -y --no-install-recommends \
  ca-certificates curl git unzip gnupg \
  && rm -rf /var/lib/apt/lists/*

# --- install terraform ---
ARG TF_VERSION=1.8.5
RUN curl -fsSL https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip -o /tmp/tf.zip \
  && unzip /tmp/tf.zip -d /usr/local/bin \
  && rm /tmp/tf.zip

# --- install gcloud ---
RUN curl -fsSL https://sdk.cloud.google.com | bash -s -- --disable-prompts
ENV PATH="/root/google-cloud-sdk/bin:${PATH}"

# --- install ggen (production: ggen must be in image) ---
# Option A: copy from build context (recommended for production)
COPY ggen /usr/local/bin/ggen
RUN chmod +x /usr/local/bin/ggen

# --- controller binary ---
COPY --from=build /src/target/release/autonomics-catalog-controller /usr/local/bin/controller
RUN chmod +x /usr/local/bin/controller

ENV RUST_LOG=info
ENTRYPOINT ["/usr/local/bin/controller"]
