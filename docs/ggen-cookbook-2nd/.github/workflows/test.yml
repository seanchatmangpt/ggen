name: Test GGen Cookbook Examples

on:
  push:
    branches: [master, main]
    paths:
      - "docs/ggen-cookbook-2nd/examples/**"
      - "docs/ggen-cookbook-2nd/patterns/**"
  pull_request:
    branches: [master, main]
    paths:
      - "docs/ggen-cookbook-2nd/examples/**"
      - "docs/ggen-cookbook-2nd/patterns/**"

jobs:
  test-examples:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Install GGen
        run: |
          cargo install ggen

      - name: Test Chapter 1 Examples
        run: |
          cd docs/ggen-cookbook-2nd/examples/chapter-1
          ggen template apply pattern-language-example.tmpl --output test_output.rs
          rustc --crate-type lib test_output.rs

      - name: Test Chapter 8 Examples
        run: |
          cd docs/ggen-cookbook-2nd/examples/chapter-8
          ggen graph load ../../patterns/001_knowledge_first.md
          ggen template apply knowledge-first-example.tmpl --output test_output.rs
          rustc --crate-type lib test_output.rs

      - name: Test Pattern Examples
        run: |
          cd docs/ggen-cookbook-2nd/examples/patterns
          ggen template apply deterministic-engine-example.tmpl --output test_output.rs
          rustc --crate-type lib test_output.rs

      - name: Test Recipe Examples
        run: |
          cd docs/ggen-cookbook-2nd/examples/recipes
          ggen template apply quick-start-api.tmpl --output test_output.rs
          rustc --crate-type lib test_output.rs

  test-patterns:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Install GGen
        run: |
          cargo install ggen

      - name: Test Pattern 001
        run: |
          cd docs/ggen-cookbook-2nd/patterns
          ggen graph load 001_knowledge_first.md
          ggen graph query "SELECT ?s ?p ?o WHERE { ?s ?p ?o } LIMIT 5"

      - name: Test Pattern 002
        run: |
          cd docs/ggen-cookbook-2nd/patterns
          ggen template apply 002_deterministic_engine.md --output test_output.rs
          rustc --crate-type lib test_output.rs

      - name: Test Pattern 003
        run: |
          cd docs/ggen-cookbook-2nd/patterns
          ggen graph load 003_graph_template_binding.md
          ggen template apply 003_graph_template_binding.md --output test_output.rs
          rustc --crate-type lib test_output.rs

      - name: Test Pattern 004
        run: |
          cd docs/ggen-cookbook-2nd/patterns
          ggen --help
          ggen graph --help
          ggen template --help
          ggen project --help
          ggen market --help
          ggen audit --help
          ggen ci --help
