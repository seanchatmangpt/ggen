@startuml C4_Marketplace_Security
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

title Rgen Marketplace - Security Model

Person(developer, "Developer", "Uses rgen CLI")
Person(publisher, "Publisher", "Publishes rpacks")
Person(attacker, "Attacker", "Potential security threat")

System_Boundary(trust_boundary, "Trust Boundary") {
    System_Boundary(local_system, "Local System (Trusted)") {
        Component(cli, "CLI", "Rust", "rgen commands")
        Component(cache, "Local Cache", "File System", "~/.rgen/rpacks/")
        Component(lockfile, "Lockfile", "TOML", "rgen.lock")
    }
    
    System_Boundary(registry_system, "Registry System (Semi-Trusted)") {
        Component(registry_index, "Registry Index", "JSON", "index.json")
        Component(ci_validation, "CI Validation", "GitHub Actions", "Automated checks")
        Component(registry_pages, "GitHub Pages", "CDN", "registry.rgen.dev")
    }
    
    System_Boundary(rpack_repos, "Rpack Repositories (Untrusted)") {
        Component(rpack_manifest, "Rpack Manifest", "TOML", "templates/rgen.toml")
        Component(rpack_templates, "Templates", "Tera", "*.tmpl files")
        Component(rpack_rdf, "RDF Data", "Turtle", "Graph data")
    }
}

System_Boundary(security_controls, "Security Controls") {
    Component(sha256_verification, "SHA256 Verification", "Cryptographic", "Integrity checking")
    Component(license_validation, "License Validation", "Allowlist", "License checking")
    Component(path_sanitization, "Path Sanitization", "Input Validation", "Path traversal prevention")
    Component(sandbox_execution, "Sandbox Execution", "Isolation", "Template execution")
    Component(network_controls, "Network Controls", "Firewall", "Registry-only access")
    Component(static_analysis, "Static Analysis", "Security Scanner", "Code analysis")
}

' Security Controls
Rel(sha256_verification, rpack_repos, "Verifies", "Integrity hash")
Rel(license_validation, rpack_manifest, "Validates", "License field")
Rel(path_sanitization, rpack_templates, "Sanitizes", "File paths")
Rel(sandbox_execution, rpack_templates, "Isolates", "Template rendering")
Rel(network_controls, registry_system, "Restricts", "Network access")
Rel(static_analysis, rpack_repos, "Scans", "Security issues")

' Trust Relationships
Rel(developer, cli, "Trusts", "Local execution")
Rel(cli, registry_system, "Semi-trusts", "HTTPS + validation")
Rel(registry_system, rpack_repos, "Validates", "CI/CD checks")
Rel(cli, rpack_repos, "Untrusted", "Sandboxed execution")

' Security Threats
Rel(attacker, rpack_repos, "Could compromise", "Malicious rpacks")
Rel(attacker, registry_system, "Could attack", "Registry infrastructure")
Rel(attacker, network_controls, "Blocked by", "Network restrictions")

' Security Mitigations
note right of sha256_verification
  **Integrity Protection**
  - SHA256 tree hashes
  - Registry index includes hashes
  - Verification on download
  - Prevents tampering
end note

note right of sandbox_execution
  **Execution Safety**
  - Templates are data only
  - No arbitrary code execution
  - Sandboxed file operations
  - Read-only cache access
end note

note right of license_validation
  **License Compliance**
  - Allowlist of approved licenses
  - Automated validation in CI
  - Prevents license violations
  - Clear usage terms
end note

note right of path_sanitization
  **Path Security**
  - Prevents directory traversal
  - Validates all file paths
  - Restricts to rpack boundaries
  - No absolute path access
end note

@enduml
