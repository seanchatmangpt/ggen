@startuml C4_Marketplace_Data_Flow
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

title Rgen Marketplace - Data Flow Diagram

Person(developer, "Developer", "Uses rgen")
Person(publisher, "Publisher", "Publishes rpacks")

System_Boundary(local_system, "Local System") {
    Component(cli, "CLI", "Rust", "rgen commands")
    Component(cache, "Local Cache", "File System", "~/.rgen/rpacks/")
    Component(lockfile, "Lockfile", "TOML", "rgen.lock")
    Component(project_config, "Project Config", "TOML", "rgen.toml")
}

System_Boundary(registry_system, "Registry System") {
    Component(registry_index, "Registry Index", "JSON", "index.json")
    Component(registry_pages, "GitHub Pages", "CDN", "registry.rgen.dev")
}

System_Boundary(rpack_repos, "Rpack Repositories") {
    Component(rpack_manifest, "Rpack Manifest", "TOML", "templates/rgen.toml")
    Component(rpack_templates, "Templates", "Tera", "*.tmpl files")
    Component(rpack_rdf, "RDF Data", "Turtle", "Graph data")
    Component(rpack_queries, "SPARQL Queries", "SPARQL", "Query files")
}

' Data Flow: Search
Rel(developer, cli, "rgen search rust")
Rel(cli, registry_pages, "GET /index.json")
Rel(registry_pages, registry_index, "Returns JSON")
Rel(registry_index, cli, "Search results")

' Data Flow: Add
Rel(developer, cli, "rgen add io.rgen.rust.cli-subcommand")
Rel(cli, registry_index, "Resolves version")
Rel(cli, rpack_repos, "Git clone")
Rel(rpack_repos, cache, "Downloads to cache")
Rel(cache, lockfile, "Updates rgen.lock")

' Data Flow: Generate
Rel(developer, cli, "rgen gen io.rgen.rust.cli-subcommand:main.tmpl")
Rel(cli, lockfile, "Reads installed rpacks")
Rel(cli, cache, "Loads rpack from cache")
Rel(cache, rpack_manifest, "Reads manifest")
Rel(cache, rpack_templates, "Loads template")
Rel(cache, rpack_rdf, "Loads RDF data")
Rel(cache, rpack_queries, "Loads queries")
Rel(cli, project_config, "Merges with project config")

' Data Flow: Publish
Rel(publisher, rpack_repos, "Creates rpack repo")
Rel(rpack_repos, rpack_manifest, "Writes rgen.toml")
Rel(rpack_repos, rpack_templates, "Adds templates")
Rel(publisher, registry_system, "Opens PR to registry")
Rel(registry_system, registry_index, "Updates index.json")

' Data Flow: Update
Rel(developer, cli, "rgen update")
Rel(cli, registry_index, "Checks for updates")
Rel(cli, rpack_repos, "Downloads new versions")
Rel(cli, cache, "Updates cache")
Rel(cli, lockfile, "Updates rgen.lock")

@enduml
