# How to Add a Custom Job Backend

**Goal:** Integrate a custom backend (Redis, Kafka, PostgreSQL) into your job queue.

**Difficulty:** Intermediate

**Time:** ~20 minutes

---

## Problem

You need to use a different backend than NATS or RabbitMQ — perhaps Redis for in-memory speed, Kafka for log-based processing, or PostgreSQL for durable job storage.

---

## Solution

Extend the RDF ontology with a custom backend definition, implement the backend behavior, and regenerate code.

---

## Step 1: Define Redis Backend in RDF

Edit `.specify/specs/001-job-queue/feature.ttl`:

```turtle
@prefix jobs: <http://ggen.dev/ontology/jobs#> .

# Redis Backend
jobs:Redis a jobs:Backend ;
    rdfs:label "Redis Backend" ;
    rdfs:comment "In-memory job queue using Redis lists" ;
    jobs:url "redis://localhost:6379" ;
    jobs:database 0 ;
    jobs:keyPrefix "jobs:" ;
    jobs:implementation jobs:RedisImplementation .

jobs:RedisImplementation a jobs:BackendImplementation ;
    jobs:module "job_backend_redis" ;
    jobs:publishFunction "push_job" ;
    jobs:subscribeFunction "subscribe_to_list" ;
    jobs:pullFunction "pull_jobs" ;
    jobs:ackFunction "remove_job" .
```

---

## Step 2: Create Tera Template for Redis Backend

Create `templates/erlang/backend_redis.erl.tera`:

```erlang
%%%-------------------------------------------------------------------
%%% @doc Redis Backend Implementation
%%% Generated by ggen from RDF ontology.
%%%-------------------------------------------------------------------
-module(job_backend_redis).
-behaviour(job_backend).

-export([
    start_link/1,
    publish/4,
    subscribe/2,
    pull/3,
    ack/2
]).

-record(state, {
    redis_conn :: pid(),
    key_prefix :: string()
}).

%% @doc Start Redis connection
start_link(Config) ->
    Url = maps:get(url, Config, "redis://localhost:6379"),
    Database = maps:get(database, Config, 0),
    KeyPrefix = maps:get(key_prefix, Config, "jobs:"),

    {ok, Conn} = eredis:start_link(parse_url(Url), Database),

    {ok, #state{redis_conn = Conn, key_prefix = KeyPrefix}}.

%% @doc Publish job to Redis list
publish(Priority, Domain, Payload, Deadline) ->
    Key = list_key(Priority, Domain),
    Item = encode_job(Priority, Domain, Payload, Deadline),

    case eredis:q(State#state.redis_conn, ["RPUSH", Key, Item]) of
        {ok, _} -> {ok, generate_job_id()};
        {error, Reason} -> {error, Reason}
    end.

%% @doc Pull jobs from Redis list (blocking)
pull(Priority, Domain, Count) ->
    Key = list_key(Priority, Domain),

    case eredis:q(State#state.redis_conn, ["LPOP", Key, Count]) of
        {ok, Items} when is_list(Items) ->
            Jobs = [decode_job(Item) || Item <- Items],
            {ok, Jobs};
        {error, Reason} ->
            {error, Reason}
    end.

%% @doc Generate list key for priority/domain
list_key(Priority, Domain) ->
    Prefix = State#state.key_prefix,
    lists:flatten(io_lib:format("~s~s:~s", [Prefix, Priority, Domain])).
```

---

## Step 3: Regenerate with ggen sync

```bash
ggen sync --audit true

# Expected output:
# [μ₃] Rendering templates (Tera)... ✓
#      - Generated src/job_backend_redis.erl (new)
#      - Updated src/job_queue.erl (added Redis support)
```

---

## Step 4: Test Redis Backend

```erlang
% Start Redis backend
{ok, _} = job_backend_redis:start_link(#{
    url => "redis://localhost:6379",
    database => 0,
    key_prefix => "jobs:"
}).

% Publish job
{ok, JobId} = job_backend_redis:publish(high, payment, #{amount => 100}, 60000).

% Pull jobs
{ok, Jobs} = job_backend_redis:pull(high, payment, 5).
```

---

## Alternative: Kafka Backend

For Kafka, define in RDF:

```turtle
jobs:Kafka a jobs:Backend ;
    rdfs:label "Kafka Backend" ;
    jobs:url "kafka://localhost:9092" ;
    jobs:topic "jobs-queue" ;
    jobs:partitions 12 ;
    jobs:replicationFactor 3 .
```

Then create `templates/erlang/backend_kafka.erl.tera` with brod client integration.

---

## Summary

You've learned how to:
- Define custom backends in RDF
- Create Tera templates for backend implementation
- Regenerate code with `ggen sync`
- Test custom backends

**See also:**
- [Template Variable Reference](../reference/03-template-variables.md)
- [How to Customize Generated Templates](05-customize-templates.md)

---

**Generated by ggen v6.0.0 | 2026-01-29**
