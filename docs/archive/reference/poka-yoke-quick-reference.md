<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**

- [Poka-Yoke Quick Reference Guide](#poka-yoke-quick-reference-guide)
  - [What is Poka-Yoke?](#what-is-poka-yoke)
  - [Configuration (ggen.toml)](#configuration-ggentoml)
    - [Basic Setup](#basic-setup)
  - [The Pattern: Traits + Implementations](#the-pattern-traits--implementations)
    - [Generated Code (src/generated/user/suspend.rs)](#generated-code-srcgeneratedusersuspendrs)
    - [Domain Code (src/domain/user/suspend.rs)](#domain-code-srcdomainusersuspendrs)
  - [How It Protects You](#how-it-protects-you)
    - [1. **Directory Separation**](#1-directory-separation)
    - [2. **Warning Headers**](#2-warning-headers)
    - [3. **Compiler Enforcement**](#3-compiler-enforcement)
    - [4. **Path Protection**](#4-path-protection)
  - [FMEA Validation](#fmea-validation)
  - [The Only Command: ggen sync](#the-only-command-ggen-sync)
  - [Real-World Example](#real-world-example)
    - [Project Structure](#project-structure)
    - [Workflow](#workflow)
  - [When Regeneration is Safe](#when-regeneration-is-safe)
  - [Benefits](#benefits)
  - [Testing Your Setup](#testing-your-setup)
  - [Troubleshooting](#troubleshooting)
    - [Error: "Cannot overwrite protected path"](#error-cannot-overwrite-protected-path)
    - [Missing domain stubs](#missing-domain-stubs)
    - [Header not appearing](#header-not-appearing)
  - [Next Steps](#next-steps)
  - [Learn More](#learn-more)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# Poka-Yoke Quick Reference Guide

A practical guide to using ggen v5.0.2's mistake-proofing controls for safe code generation.

## What is Poka-Yoke?

Poka-yoke (ポカヨケ) means "mistake-proofing" - designing systems that prevent errors through design rather than detection. In ggen, poka-yoke protects your code from accidental overwrites during code regeneration.

## Configuration (ggen.toml)

### Basic Setup

```toml
[generation]
enabled = true
protected_paths = ["src/domain/**/*"]        # Files NEVER overwritten
regenerate_paths = ["src/generated/**/*"]    # Files safe to regenerate

[generation.poka_yoke]
warning_headers = true                        # "DO NOT EDIT" headers
gitignore_generated = true                    # .gitignore entries
gitattributes_generated = true                # linguist-generated marks
```

## The Pattern: Traits + Implementations

Poka-yoke uses Rust's type system to prevent errors at compile time.

### Generated Code (src/generated/user/suspend.rs)

```rust
// DO NOT EDIT - Generated by ggen. Changes will be overwritten.
// Regenerate with: ggen sync

/// Suspend a user account
pub trait UserSuspend {
    fn suspend(&self, user_id: UserId, reason: String)
        -> Result<SuspendResult, DomainError>;
}
```

### Domain Code (src/domain/user/suspend.rs)

```rust
use crate::generated::user::suspend::UserSuspend;

impl UserSuspend for UserService {
    fn suspend(&self, user_id: UserId, reason: String)
        -> Result<SuspendResult, DomainError> {
        // Your actual implementation
        todo!("Implement suspend logic")
    }
}
```

## How It Protects You

### 1. **Directory Separation**
- Generated code lives in `src/generated/`
- Domain code lives in `src/domain/`
- No mix, no overwrites

### 2. **Warning Headers**
```rust
// ============================================================
// DO NOT EDIT THIS FILE
//
// This file is auto-generated by ggen from RDF ontology.
// Any manual changes will be OVERWRITTEN on regeneration.
//
// To customize behavior, implement the trait in:
//   src/domain/user/suspend.rs
//
// Regenerate with: ggen sync
// ============================================================
```

### 3. **Compiler Enforcement**
```rust
// Generated trait defines the contract
pub trait UserSuspend {
    fn suspend(&self, user_id: UserId, reason: String) -> Result<...>;
}

// Domain code MUST implement it - compiler ensures this
impl UserSuspend for UserService {
    fn suspend(&self, user_id: UserId, reason: String) -> Result<...> {
        // ✓ Compiler checks this matches the trait signature
    }
}
```

### 4. **Path Protection**
```bash
# Try to overwrite domain code:
ggen sync

# ✗ BLOCKED: Error message
Error: Cannot overwrite protected path src/domain/user.rs
Protected pattern: src/domain/**/*
```

## FMEA Validation

Validate packages for completeness before installation:

```toml
[marketplace]
fmea_validation = true           # Enable validation
require_fmea = true              # Require [fmea] section
critical_threshold = 200         # RPN threshold

[codeowners]
enabled = true                   # Generate CODEOWNERS
source_dirs = ["ontology"]
base_dirs = ["src/generated", "src/domain"]
output_path = ".github/CODEOWNERS"
```

## The Only Command: ggen sync

**ggen v5 has ONE command** that reads all configuration from `ggen.toml`:

```bash
# Synchronize code generation with poka-yoke protections enabled
ggen sync

# That's it - everything is configured via ggen.toml
```

The `ggen sync` command:
1. Reads `ggen.toml` configuration
2. Loads ontologies from configured paths
3. Applies SPARQL transformations
4. Renders templates with protections
5. Writes to protected/regenerate directories
6. Validates FMEA if enabled
7. Generates CODEOWNERS if enabled

## Real-World Example

### Project Structure
```
my-project/
├── ggen.toml                    # Configuration
├── ontology/
│   └── user.ttl                 # RDF specification
├── src/
│   ├── generated/               # Protected during regen
│   │   └── user/
│   │       ├── suspend.rs       # trait UserSuspend
│   │       └── activate.rs      # trait UserActivate
│   ├── domain/                  # Never touched by ggen
│   │   └── user/
│   │       ├── suspend.rs       # impl UserSuspend for UserService
│   │       └── activate.rs      # impl UserActivate for UserService
│   └── service.rs
└── tests/
    └── user_tests.rs
```

### Workflow

```bash
# 1. First synchronization creates everything
$ ggen sync
  ✓ Read ggen.toml configuration
  ✓ Created src/generated/user/suspend.rs (trait)
  ✓ Created src/domain/user/suspend.rs (stub with unimplemented!())
  ✓ Generated CODEOWNERS from OWNERS files
  ✓ Validated FMEA thresholds

# 2. Implement in domain code
$ vim src/domain/user/suspend.rs
  impl UserSuspend for UserService {
      fn suspend(...) -> Result<...> {
          // Your implementation
      }
  }

# 3. Synchronize again - domain code is safe
$ ggen sync
  ✓ Read ggen.toml configuration
  ✓ Updated src/generated/user/suspend.rs (new features added)
  ✓ src/domain/user/suspend.rs unchanged (protected!)
  ✓ Updated CODEOWNERS
  ✓ Re-validated FMEA thresholds

# 4. Implement new trait as ontology changes
$ vim ontology/user.ttl
$ ggen sync  # Domain code always safe
```

## When Regeneration is Safe

✅ **Safe to regenerate:**
- Update feature set (add new traits/methods)
- Fix bugs in generated code
- Change comment/doc formatting
- Update dependency versions

✅ **Your domain code is never touched:**
- Implementations in `src/domain/`
- Any file in `protected_paths`
- Files marked with `DO NOT EDIT` header

## Benefits

| Problem | Solution |
|---------|----------|
| Accidental overwrites | ✓ Directory separation + path protection |
| Unclear what's generated | ✓ `DO NOT EDIT` headers visible in IDE |
| Merge conflicts | ✓ One-file-per-verb pattern |
| Lost changes | ✓ Blocked overwrites with explicit error |
| Breaking changes | ✓ Trait signatures enforce compatibility |

## Testing Your Setup

```bash
# 1. Configure ggen.toml with poka-yoke settings
cat > ggen.toml <<'EOF'
[generation]
enabled = true
protected_paths = ["src/domain/**/*"]
regenerate_paths = ["src/generated/**/*"]

[generation.poka_yoke]
warning_headers = true
gitignore_generated = true
gitattributes_generated = true

[codeowners]
enabled = true
source_dirs = ["ontology"]
base_dirs = ["src/generated", "src/domain"]
EOF

# 2. Run the ONE command - everything flows from ggen.toml
ggen sync

# 3. Verify results
[ -f "src/generated/user/suspend.rs" ] && echo "✓ Generated code created"
[ -f "src/domain/user/suspend.rs" ] && echo "✓ Domain stub created"
[ -f ".github/CODEOWNERS" ] && echo "✓ CODEOWNERS generated"
grep -q "DO NOT EDIT" src/generated/user/suspend.rs && echo "✓ Headers injected"

# 4. Run developer tests (verify ggen's poka-yoke implementation)
cargo test -p ggen-domain --test path_protection_tests
cargo test -p ggen-domain --test header_injection_tests
cargo test -p ggen-domain --test codeowners_tests
```

## Troubleshooting

### Error: "Cannot overwrite protected path"
**Problem:** Trying to overwrite code in `protected_paths`
**Solution:** Implement in domain code, not generated code

### Missing domain stubs
**Problem:** Running `ggen generate` twice shows different results
**Solution:** First generation creates stubs, second updates them

### Header not appearing
**Problem:** `DO NOT EDIT` header missing from generated file
**Solution:** Ensure `[generation.poka_yoke].warning_headers = true`

## Next Steps

1. Add `[generation]` section to your `ggen.toml`
2. Create `src/generated/` and `src/domain/` directories
3. Run `ggen sync` to see poka-yoke in action
4. Review generated files for `DO NOT EDIT` headers
5. Implement domain code in `src/domain/`
6. Commit both generated and domain code
7. On next regeneration, verify domain code is unchanged

## Learn More

- [FMEA & Poka-Yoke Specification](../../specs/006-marketplace-fmea-poka-yoke/spec.md)
- [Poka-Yoke Implementation](../../crates/ggen-core/src/lifecycle/poka_yoke.rs)
- [Integration Tests](../../crates/ggen-domain/tests/)

---

**Version:** ggen v5.0.2+
**Status:** Production-ready
**Quality:** Zero-defect, Chicago TDD verified
