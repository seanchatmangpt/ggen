%% -*- mode: erlang -*-
%%
%% TPS Jidoka System Configuration
%% Loaded at application startup
%%

[
    %% Kernel configuration
    {kernel, [
        {logger_level, info},
        {logger, [
            {handler, default, logger_std_h,
                #{formatter => {logger_formatter, #{template => [time, " [", level, "] ", msg, "\n"]}}}
            }
        ]}
    ]},

    %% Lager logging configuration
    {lager, [
        {log_root, "logs"},
        {async_threshold, 500},
        {async_threshold_window, 50},
        {handlers, [
            {lager_console_backend, [
                {level, info},
                {formatter_config, [
                    color,
                    " [", severity, "] ",
                    {date, ""},
                    " [", pid, "] ",
                    message,
                    "\n"
                ]}
            ]},
            {lager_file_backend, [
                {file, "logs/jidoka.log"},
                {level, info},
                {size, 10485760},  %% 10MB
                {date, "$D0"},
                {count, 5},         %% Keep 5 files
                {formatter_config, [
                    {date, "YYYY-MM-DD HH:mm:ss.SSS"},
                    " [", severity, "] ",
                    "[", pid, "] ",
                    message,
                    "\n"
                ]}
            ]},
            {lager_file_backend, [
                {file, "logs/jidoka_error.log"},
                {level, error},
                {size, 10485760},
                {date, "$D0"},
                {count, 10},
                {formatter_config, [
                    {date, "YYYY-MM-DD HH:mm:ss.SSS"},
                    " [", severity, "] ",
                    "[", pid, "] ",
                    "[", module, ":", function, ":", line, "] ",
                    message,
                    "\n"
                ]}
            ]}
        ]},
        {crash_log, "logs/jidoka_crash.log"},
        {crash_log_msg_size, 65536},
        {crash_log_date, "$D0"},
        {error_logger_redirect, true},
        {error_logger_hwm, 200},
        {colored, true}
    ]},

    %% TPS Jidoka configuration
    {tps_jidoka, [
        %% Circuit breaker configuration
        {circuit_breaker, [
            {threshold, 5},         %% Failures before opening circuit
            {window_ms, 10000},     %% Time window for counting failures (10s)
            {recovery_ms, 30000}    %% Time before attempting half_open (30s)
        ]},

        %% Rate limiter configuration
        {rate_limiter, [
            {rate_limit, 1000},     %% Requests per second
            {burst_size, 500}       %% Maximum tokens in bucket (burst capacity)
        ]},

        %% Worker pool configuration
        {worker_pool, [
            {pool_name, jidoka_worker_pool},
            {pool_size, 10},        %% Number of worker processes
            {max_overflow, 0}       %% NO overflow (Jidoka principle: fail-fast, not queue)
        ]}
    ]}
].
