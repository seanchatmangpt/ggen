%% -*- mode: erlang -*-
%%
%% TPS Jidoka - Rebar3 Configuration
%% Build system configuration for the Jidoka Erlang subsystem
%%

%% Project metadata
{project_plugins, [rebar3_format]}.

%% Erlang/OTP version requirements
{require_otp_vsn, "24|25|26|27"}.

%% Dependencies
{deps, [
    %% Worker pool management
    {poolboy, "1.5.2"},

    %% Circuit breaker library (optional - we implement our own)
    %% {breaker, "2.0.0"},

    %% Logging
    {lager, "3.9.2"},

    %% Testing
    {eunit, "2.5.0"}
]}.

%% Development dependencies (test-only)
{profiles, [
    {test, [
        {deps, [
            {proper, "1.4.0"},  %% Property-based testing
            {meck, "0.9.2"}     %% Mocking library for tests
        ]},
        {cover_enabled, true},
        {cover_opts, [verbose]},
        {erl_opts, [
            {define, 'TESTING'},
            {parse_transform, lager_transform}
        ]}
    ]},
    {prod, [
        {erl_opts, [
            {optimize, [aggressive_optimizations]},
            {parse_transform, lager_transform},
            {warnings_as_errors, true}
        ]}
    ]}
]}.

%% Compiler options
{erl_opts, [
    debug_info,
    {parse_transform, lager_transform},
    {src_dirs, ["src"]},
    {i, "include"},
    warnings_as_errors,
    warn_unused_vars,
    warn_shadow_vars,
    warn_unused_function,
    warn_deprecated_function,
    warn_deprecated_type,
    warn_removed_function,
    warn_removed_type,
    warn_obsolete_guard,
    warn_untyped_record
]}.

%% Rebar3 format configuration
{format, [
    {files, ["src/**/*.erl", "tests/**/*.erl"]},
    {ignore_dirs, ["_build", "deps"]},
    {printer, default_printer},
    {margin, 100}
]}.

%% Common Test configuration
{ct_opts, [
    {ct_dir, "tests"},
    {ct_log_dir, "_build/test/logs"},
    {ct_cover_enabled, true},
    {ct_cover_ncover, true}
]}.

%% EUnit configuration
{eunit_opts, [
    verbose,
    {skip_deps, true}
]}.

%% Shell options
{shell, [
    {apps, [kernel, stdlib, lager]},
    {config, "config/shell.config"}
]}.

%% Artifact directories
{artifact_dir, "_build"}.

%% Clean policy
{clean_keep_paths, [
    "_build/default/lib",
    "logs"
]}.

%% Minimum OTP version
{minimum_otp_vsn, "24"}.

%% Application environment defaults (loaded from app.src)
{app_env, []}.

%% Dialyzer configuration
{dialyzer, [
    {plt_apps, [kernel, stdlib, erts, sasl]},
    {plt_extra_apps, [lager, poolboy]},
    {src_dir, ["src"]},
    {output_plt, "_build/default/rebar3.plt"},
    {warnings, [
        error_handling,
        race_conditions,
        unknown,
        unmatched_returns
    ]}
]}.

%% Documentation generation
{edoc_opts, [
    {preprocess, true},
    {source_path, "src"},
    {output, "doc"},
    {doclet, edoc_doclet},
    {subpackages, false},
    {pretty_print, erl_pp}
]}.

%% Provider hooks
{provider_hooks, [
    {pre, [
        {compile, {format, format}},
        {test, {format, format}},
        {eunit, {format, format}},
        {ct, {format, format}}
    ]},
    {post, [
        {compile, {cover, enable}}
    ]}
]}.

%% Hex package configuration (if publishing to hex.pm)
{hex, [
    {doc, #{provider => ex_doc}}
]}.

%% Version - should match tps_jidoka.app.src
{relx, [
    {release, {tps_jidoka, "1.0.0"}, [tps_jidoka]},
    {mode, dev},
    {include_erts, false},
    {extended_start_script, true},
    {vm_args, "config/vm.args"},
    {sys_config, "config/sys.config"}
]}.
