#!/usr/bin/env node
// World Verifier
// Generated by ggen wizard
// Validates all outputs in the world manifest

import { readFileSync, existsSync } from 'fs';
import { createHash } from 'crypto';

const MANIFEST_PATH = 'generated/world.manifest.json';

function sha256(content) {
  return createHash('sha256').update(content).digest('hex');
}

function verifyArtifact(artifact) {
  const { path, hash, format, validator } = artifact;

  if (!existsSync(path)) {
    return { valid: false, error: `File not found: ${path}` };
  }

  const content = readFileSync(path, 'utf8');
  const actualHash = sha256(content);

  if (hash && actualHash !== hash) {
    return { valid: false, error: `Hash mismatch for ${path}` };
  }

  // Format-specific validation
  if (validator === 'json-schema') {
    try {
      JSON.parse(content);
    } catch (e) {
      return { valid: false, error: `Invalid JSON in ${path}: ${e.message}` };
    }
  }

  return { valid: true };
}

function main() {
  if (!existsSync(MANIFEST_PATH)) {
    console.error(`âŒ Manifest not found: ${MANIFEST_PATH}`);
    process.exit(1);
  }

  const manifest = JSON.parse(readFileSync(MANIFEST_PATH, 'utf8'));
  console.log(`ğŸ” Verifying ${manifest.artifacts.length} artifacts...`);

  let failures = 0;
  for (const artifact of manifest.artifacts) {
    const result = verifyArtifact(artifact);
    if (!result.valid) {
      console.error(`âŒ ${artifact.path}: ${result.error}`);
      failures++;
    } else {
      console.log(`âœ“ ${artifact.path}`);
    }
  }

  if (failures > 0) {
    console.error(`\nâŒ ${failures} artifact(s) failed validation`);
    process.exit(1);
  }

  console.log('\nâœ… All artifacts validated successfully');
}

main();
