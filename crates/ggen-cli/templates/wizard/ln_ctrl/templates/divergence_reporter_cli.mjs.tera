{# =============================================================================
   DIVERGENCE REPORTER CLI - Command-line interface for divergence analysis

   Provides easy command-line access to divergence reporter functionality.

   Generated by ggen from ln_ctrl wizard - DO NOT EDIT MANUALLY
   Regenerate with: ggen sync --audit true
   ============================================================================= #}
#!/usr/bin/env node
/**
 * ln_ctrl Divergence Reporter CLI
 *
 * Command-line interface for analyzing execution divergence and
 * generating repair suggestions.
 *
 * @module divergence_reporter_cli
 * @version {{ version | default(value="1.0.0") }}
 */

import { readFile } from 'node:fs/promises';
import { parseArgs } from 'node:util';
import {
  analyzeDivergence,
  generateDivergenceReport,
  printDivergenceReport,
} from './divergence_reporter.mjs';

/**
 * CLI usage information
 */
function printUsage() {
  console.log(`
ln_ctrl Divergence Reporter CLI v{{ version | default(value="1.0.0") }}

Usage: node divergence_reporter_cli.mjs [options]

Options:
  --expected <path>     Path to expected execution JSON file (required)
  --actual <path>       Path to actual execution JSON file (required)
  --output <path>       Path to save divergence report (default: divergence.json)
  --quiet              Suppress console output
  --help               Show this help message

Examples:
  # Analyze divergence and print report
  node divergence_reporter_cli.mjs \\
    --expected expected.json \\
    --actual actual.json

  # Save report to file without printing
  node divergence_reporter_cli.mjs \\
    --expected expected.json \\
    --actual actual.json \\
    --output report.json \\
    --quiet

  # Quick analysis with default output
  node divergence_reporter_cli.mjs \\
    --expected expected.json \\
    --actual actual.json

Exit Codes:
  0 - No divergence detected (verification passed)
  1 - Divergence detected (see report for details)
  2 - Error (invalid input, missing files, etc.)
`);
}

/**
 * Parse command-line arguments
 */
function parseCliArgs() {
  try {
    const { values } = parseArgs({
      options: {
        expected: {
          type: 'string',
        },
        actual: {
          type: 'string',
        },
        output: {
          type: 'string',
          default: './divergence.json',
        },
        quiet: {
          type: 'boolean',
          default: false,
        },
        help: {
          type: 'boolean',
          default: false,
        },
      },
    });

    return values;
  } catch (err) {
    console.error(`Error parsing arguments: ${err.message}`);
    printUsage();
    process.exit(2);
  }
}

/**
 * Load JSON file
 */
async function loadJson(filePath, label) {
  try {
    const content = await readFile(filePath, 'utf-8');
    return JSON.parse(content);
  } catch (err) {
    if (err.code === 'ENOENT') {
      console.error(`‚ùå Error: ${label} file not found: ${filePath}`);
    } else if (err instanceof SyntaxError) {
      console.error(`‚ùå Error: Invalid JSON in ${label} file: ${filePath}`);
      console.error(`   ${err.message}`);
    } else {
      console.error(`‚ùå Error reading ${label} file: ${err.message}`);
    }
    process.exit(2);
  }
}

/**
 * Main CLI entry point
 */
async function main() {
  const args = parseCliArgs();

  // Show help
  if (args.help) {
    printUsage();
    process.exit(0);
  }

  // Validate required arguments
  if (!args.expected || !args.actual) {
    console.error('‚ùå Error: Both --expected and --actual arguments are required\n');
    printUsage();
    process.exit(2);
  }

  // Load execution states
  if (!args.quiet) {
    console.log('Loading execution states...');
  }

  const expected = await loadJson(args.expected, 'Expected');
  const actual = await loadJson(args.actual, 'Actual');

  if (!args.quiet) {
    console.log(`‚úÖ Loaded expected execution (${expected.receipts?.length || 0} receipts)`);
    console.log(`‚úÖ Loaded actual execution (${actual.receipts?.length || 0} receipts)`);
    console.log('\nAnalyzing divergence...\n');
  }

  // Generate report
  const report = await generateDivergenceReport(
    expected,
    actual,
    args.output
  );

  // Print report (unless quiet mode)
  if (!args.quiet) {
    printDivergenceReport(report);
  }

  // Save confirmation
  if (!args.quiet || report.divergence_detected) {
    console.log(`\nüìÑ Report saved to: ${args.output}`);
  }

  // Exit with appropriate code
  if (report.divergence_detected) {
    if (!args.quiet) {
      console.log('\n‚ùå Divergence detected - verification FAILED');
    }
    process.exit(1);
  } else {
    if (!args.quiet) {
      console.log('\n‚úÖ No divergence detected - verification PASSED');
    }
    process.exit(0);
  }
}

// Run CLI
main().catch((err) => {
  console.error(`\n‚ùå Unexpected error: ${err.message}`);
  if (err.stack && !process.env.QUIET) {
    console.error(err.stack);
  }
  process.exit(2);
});
