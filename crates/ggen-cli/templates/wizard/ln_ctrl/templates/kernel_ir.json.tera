{
  "$schema": "https://ggen.io/schemas/ln_ctrl_kernel_ir.json",
  "version": "1.0.0",
  "description": "ln_ctrl Kernel IR - Deterministic control flow intermediate representation",
  "primitives": [
    {%- for row in results %}
    {%- if row.type == "Act" %}
    {
      "type": "Act",
      "id": "{{ row.id }}",
      "label": "{{ row.label | default(value="Atomic Action") }}",
      "description": "{{ row.comment | default(value="Atomic action primitive") }}",
      "properties": {
        "action": "{{ row.action }}",
        {%- if row.parameters %}
        "parameters": {{ row.parameters }},
        {%- else %}
        "parameters": {},
        {%- endif %}
        {%- if row.timeout %}
        "timeout": {{ row.timeout }},
        {%- endif %}
        {%- if row.idempotent %}
        "idempotent": {{ row.idempotent }}
        {%- else %}
        "idempotent": false
        {%- endif %}
      },
      {%- if row.metadata %}
      "metadata": {{ row.metadata }},
      {%- endif %}
      {%- if row.reduction_rule %}
      "reduction_rule": "{{ row.reduction_rule }}",
      {%- endif %}
      "canonical_form": {% if row.canonical_form %}{{ row.canonical_form }}{% else %}true{% endif %},
      "reducible": {% if row.reducible %}{{ row.reducible }}{% else %}false{% endif %}
    }{% if not loop.last %},{% endif %}
    {%- endif %}

    {%- if row.type == "Eff" %}
    {
      "type": "Eff",
      "id": "{{ row.id }}",
      "label": "{{ row.label | default(value="Effect Declaration") }}",
      "description": "{{ row.comment | default(value="Effect declaration primitive") }}",
      "properties": {
        "effect": "{{ row.effect }}",
        "handler": "{{ row.handler }}"
      },
      {%- if row.body %}
      "body": {{ row.body }},
      {%- endif %}
      {%- if row.metadata %}
      "metadata": {{ row.metadata }},
      {%- endif %}
      {%- if row.reduction_rule %}
      "reduction_rule": "{{ row.reduction_rule }}",
      {%- endif %}
      "canonical_form": {% if row.canonical_form %}{{ row.canonical_form }}{% else %}true{% endif %},
      "reducible": {% if row.reducible %}{{ row.reducible }}{% else %}false{% endif %}
    }{% if not loop.last %},{% endif %}
    {%- endif %}

    {%- if row.type == "Seq" %}
    {
      "type": "Seq",
      "id": "{{ row.id }}",
      "label": "{{ row.label | default(value="Sequential Composition") }}",
      "description": "{{ row.comment | default(value="Sequential composition primitive") }}",
      "properties": {
        {%- if row.short_circuit %}
        "short_circuit": {{ row.short_circuit }}
        {%- else %}
        "short_circuit": true
        {%- endif %}
      },
      {%- if row.steps %}
      "children": {{ row.steps }},
      {%- else %}
      "children": [],
      {%- endif %}
      {%- if row.metadata %}
      "metadata": {{ row.metadata }},
      {%- endif %}
      {%- if row.reduction_rule %}
      "reduction_rule": "{{ row.reduction_rule }}",
      {%- endif %}
      "canonical_form": {% if row.canonical_form %}{{ row.canonical_form }}{% else %}true{% endif %},
      "reducible": {% if row.reducible %}{{ row.reducible }}{% else %}true{% endif %}
    }{% if not loop.last %},{% endif %}
    {%- endif %}

    {%- if row.type == "Par" %}
    {
      "type": "Par",
      "id": "{{ row.id }}",
      "label": "{{ row.label | default(value="Parallel Composition") }}",
      "description": "{{ row.comment | default(value="Parallel composition primitive") }}",
      "properties": {
        "strategy": "{{ row.strategy | default(value="all") }}",
        {%- if row.max_concurrency %}
        "max_concurrency": {{ row.max_concurrency }}
        {%- else %}
        "max_concurrency": 0
        {%- endif %}
      },
      {%- if row.branches %}
      "children": {{ row.branches }},
      {%- else %}
      "children": [],
      {%- endif %}
      {%- if row.metadata %}
      "metadata": {{ row.metadata }},
      {%- endif %}
      {%- if row.reduction_rule %}
      "reduction_rule": "{{ row.reduction_rule }}",
      {%- endif %}
      "canonical_form": {% if row.canonical_form %}{{ row.canonical_form }}{% else %}true{% endif %},
      "reducible": {% if row.reducible %}{{ row.reducible }}{% else %}true{% endif %}
    }{% if not loop.last %},{% endif %}
    {%- endif %}

    {%- if row.type == "Join" %}
    {
      "type": "Join",
      "id": "{{ row.id }}",
      "label": "{{ row.label | default(value="Synchronization") }}",
      "description": "{{ row.comment | default(value="Synchronization primitive") }}",
      "properties": {
        "join_mode": "{{ row.join_mode | default(value="all") }}",
        {%- if row.join_count %}
        "join_count": {{ row.join_count }},
        {%- endif %}
        {%- if row.targets %}
        "targets": {{ row.targets }}
        {%- else %}
        "targets": []
        {%- endif %}
      },
      {%- if row.metadata %}
      "metadata": {{ row.metadata }},
      {%- endif %}
      {%- if row.reduction_rule %}
      "reduction_rule": "{{ row.reduction_rule }}",
      {%- endif %}
      "canonical_form": {% if row.canonical_form %}{{ row.canonical_form }}{% else %}true{% endif %},
      "reducible": {% if row.reducible %}{{ row.reducible }}{% else %}false{% endif %}
    }{% if not loop.last %},{% endif %}
    {%- endif %}

    {%- if row.type == "Choice" %}
    {
      "type": "Choice",
      "id": "{{ row.id }}",
      "label": "{{ row.label | default(value="Branching") }}",
      "description": "{{ row.comment | default(value="Branching primitive") }}",
      "properties": {
        {%- if row.condition %}
        "condition": "{{ row.condition }}"
        {%- endif %}
      },
      {%- if row.then_branch and row.else_branch %}
      "children": [{{ row.then_branch }}, {{ row.else_branch }}],
      {%- elif row.cases %}
      "children": {{ row.cases }},
      {%- else %}
      "children": [],
      {%- endif %}
      {%- if row.metadata %}
      "metadata": {{ row.metadata }},
      {%- endif %}
      {%- if row.reduction_rule %}
      "reduction_rule": "{{ row.reduction_rule }}",
      {%- endif %}
      "canonical_form": {% if row.canonical_form %}{{ row.canonical_form }}{% else %}true{% endif %},
      "reducible": {% if row.reducible %}{{ row.reducible }}{% else %}true{% endif %}
    }{% if not loop.last %},{% endif %}
    {%- endif %}

    {%- if row.type == "Loop" %}
    {
      "type": "Loop",
      "id": "{{ row.id }}",
      "label": "{{ row.label | default(value="Iteration") }}",
      "description": "{{ row.comment | default(value="Iteration primitive") }}",
      "properties": {
        "loop_mode": "{{ row.loop_mode | default(value="while") }}",
        "loop_condition": "{{ row.loop_condition }}",
        {%- if row.max_iterations %}
        "max_iterations": {{ row.max_iterations }}
        {%- else %}
        "max_iterations": 0
        {%- endif %}
      },
      {%- if row.loop_body %}
      "children": [{{ row.loop_body }}],
      {%- else %}
      "children": [],
      {%- endif %}
      {%- if row.metadata %}
      "metadata": {{ row.metadata }},
      {%- endif %}
      {%- if row.reduction_rule %}
      "reduction_rule": "{{ row.reduction_rule }}",
      {%- endif %}
      "canonical_form": {% if row.canonical_form %}{{ row.canonical_form }}{% else %}true{% endif %},
      "reducible": {% if row.reducible %}{{ row.reducible }}{% else %}true{% endif %}
    }{% if not loop.last %},{% endif %}
    {%- endif %}

    {%- if row.type == "Wait" %}
    {
      "type": "Wait",
      "id": "{{ row.id }}",
      "label": "{{ row.label | default(value="Temporal Delay") }}",
      "description": "{{ row.comment | default(value="Temporal delay primitive") }}",
      "properties": {
        {%- if row.duration %}
        "duration": {{ row.duration }},
        "unit": "{{ row.unit | default(value="ms") }}"
        {%- elif row.until %}
        "until": "{{ row.until }}"
        {%- endif %}
      },
      {%- if row.metadata %}
      "metadata": {{ row.metadata }},
      {%- endif %}
      {%- if row.reduction_rule %}
      "reduction_rule": "{{ row.reduction_rule }}",
      {%- endif %}
      "canonical_form": {% if row.canonical_form %}{{ row.canonical_form }}{% else %}true{% endif %},
      "reducible": {% if row.reducible %}{{ row.reducible }}{% else %}false{% endif %}
    }{% if not loop.last %},{% endif %}
    {%- endif %}

    {%- if row.type == "Scope" %}
    {
      "type": "Scope",
      "id": "{{ row.id }}",
      "label": "{{ row.label | default(value="Resource Boundary") }}",
      "description": "{{ row.comment | default(value="Resource boundary primitive") }}",
      "properties": {
        "resource": "{{ row.resource }}",
        "acquire": "{{ row.acquire }}",
        "release": "{{ row.release }}"
      },
      {%- if row.scope_body %}
      "children": [{{ row.scope_body }}],
      {%- else %}
      "children": [],
      {%- endif %}
      {%- if row.metadata %}
      "metadata": {{ row.metadata }},
      {%- endif %}
      {%- if row.reduction_rule %}
      "reduction_rule": "{{ row.reduction_rule }}",
      {%- endif %}
      "canonical_form": {% if row.canonical_form %}{{ row.canonical_form }}{% else %}true{% endif %},
      "reducible": {% if row.reducible %}{{ row.reducible }}{% else %}true{% endif %}
    }{% if not loop.last %},{% endif %}
    {%- endif %}

    {%- if row.type == "Cancel" %}
    {
      "type": "Cancel",
      "id": "{{ row.id }}",
      "label": "{{ row.label | default(value="Cancellation") }}",
      "description": "{{ row.comment | default(value="Cancellation primitive") }}",
      "properties": {
        "target": "{{ row.target }}",
        {%- if row.reason %}
        "reason": "{{ row.reason }}",
        {%- endif %}
        {%- if row.graceful %}
        "graceful": {{ row.graceful }}
        {%- else %}
        "graceful": true
        {%- endif %}
      },
      {%- if row.metadata %}
      "metadata": {{ row.metadata }},
      {%- endif %}
      {%- if row.reduction_rule %}
      "reduction_rule": "{{ row.reduction_rule }}",
      {%- endif %}
      "canonical_form": {% if row.canonical_form %}{{ row.canonical_form }}{% else %}true{% endif %},
      "reducible": {% if row.reducible %}{{ row.reducible }}{% else %}false{% endif %}
    }{% if not loop.last %},{% endif %}
    {%- endif %}

    {%- if row.type == "Stop" %}
    {
      "type": "Stop",
      "id": "{{ row.id }}",
      "label": "{{ row.label | default(value="Termination") }}",
      "description": "{{ row.comment | default(value="Termination primitive") }}",
      "properties": {
        {%- if row.exit_code %}
        "exit_code": {{ row.exit_code }},
        {%- else %}
        "exit_code": 0,
        {%- endif %}
        {%- if row.message %}
        "message": "{{ row.message }}"
        {%- endif %}
      },
      {%- if row.metadata %}
      "metadata": {{ row.metadata }},
      {%- endif %}
      {%- if row.reduction_rule %}
      "reduction_rule": "{{ row.reduction_rule }}",
      {%- endif %}
      "canonical_form": {% if row.canonical_form %}{{ row.canonical_form }}{% else %}true{% endif %},
      "reducible": {% if row.reducible %}{{ row.reducible }}{% else %}false{% endif %}
    }{% if not loop.last %},{% endif %}
    {%- endif %}
    {%- endfor %}
  ],
  "tree_structure": {
    "root": {
      {%- for row in results %}
      {%- if not row.parent %}
      "id": "{{ row.id }}",
      "type": "{{ row.type }}",
      "depth": 0
      {%- endif %}
      {%- endfor %}
    },
    "nodes": [
      {%- for row in results %}
      {
        "id": "{{ row.id }}",
        "type": "{{ row.type }}",
        {%- if row.parent %}
        "parent": "{{ row.parent }}",
        {%- else %}
        "parent": null,
        {%- endif %}
        {%- if row.depth %}
        "depth": {{ row.depth }},
        {%- else %}
        "depth": 0,
        {%- endif %}
        {%- if row.position %}
        "position": {{ row.position }}
        {%- else %}
        "position": 0
        {%- endif %}
      }{% if not loop.last %},{% endif %}
      {%- endfor %}
    ]
  },
  "reduction_rules": {
    "enabled": true,
    "rules": [
      {
        "name": "seq_flatten",
        "pattern": "Seq(Seq(a, b), c)",
        "result": "Seq(a, b, c)",
        "description": "Flatten nested sequential compositions"
      },
      {
        "name": "par_flatten",
        "pattern": "Par(Par(a, b), c)",
        "result": "Par(a, b, c)",
        "description": "Flatten nested parallel compositions"
      },
      {
        "name": "seq_identity",
        "pattern": "Seq(a)",
        "result": "a",
        "description": "Remove single-element sequences"
      },
      {
        "name": "par_identity",
        "pattern": "Par(a)",
        "result": "a",
        "description": "Remove single-element parallels"
      },
      {
        "name": "choice_const_true",
        "pattern": "Choice(true, a, b)",
        "result": "a",
        "description": "Eliminate choice with constant true condition"
      },
      {
        "name": "choice_const_false",
        "pattern": "Choice(false, a, b)",
        "result": "b",
        "description": "Eliminate choice with constant false condition"
      },
      {
        "name": "loop_const_false",
        "pattern": "Loop(false, body)",
        "result": "Seq()",
        "description": "Eliminate loop with constant false condition"
      },
      {
        "name": "scope_inline",
        "pattern": "Scope(r, acquire, release, Act(a))",
        "result": "Act(a_with_resource)",
        "description": "Inline scope around single action"
      }
    ]
  },
  "validation": {
    "deterministic": true,
    "canonical": true,
    "schema_version": "1.0.0"
  },
  "metadata": {
    "generated_by": "ggen",
    "generator_version": "6.0.0",
    "timestamp": "{{ now() | date(format='%Y-%m-%dT%H:%M:%SZ') }}"
  }
}
