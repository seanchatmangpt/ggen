{# =============================================================================
   DIVERGENCE REPORTER TESTS - Unit and integration tests

   Tests all major functionality of the divergence reporter.

   Generated by ggen from ln_ctrl wizard - DO NOT EDIT MANUALLY
   Regenerate with: ggen sync --audit true
   ============================================================================= #}
/**
 * Tests for ln_ctrl Divergence Reporter
 *
 * @module test_divergence_reporter
 * @version {{ version | default(value="1.0.0") }}
 */

import { test } from 'node:test';
import assert from 'node:assert';
import {
  analyzeDivergence,
  DivergenceType,
  Severity,
  Priority,
} from './divergence_reporter.mjs';

/**
 * Helper to create a receipt
 */
function createReceipt(stepIndex, hashSuffix = '', frontierTerms = ['42'], frontierHashSuffix = '') {
  return {
    step_index: stepIndex,
    operation: 'reduce',
    hash_chain: 'a'.repeat(63) + hashSuffix,
    redex_executed: {
      redex_type: 'beta',
      redex_expression: `(λx.x) ${stepIndex}`,
    },
    frontier_after: {
      frontier_terms: frontierTerms,
      frontier_size: frontierTerms.length,
      frontier_hash: 'b'.repeat(63) + frontierHashSuffix,
    },
    effects_performed: [],
    budget_remaining: {
      budget_steps: 10000 - stepIndex,
      budget_memory: 100000000,
      budget_time: 30000,
      budget_exceeded: false,
    },
  };
}

/**
 * Test: No divergence when states match
 */
test('No divergence when expected and actual match', () => {
  const expected = {
    workflow_id: 'test-workflow-1',
    receipts: [
      createReceipt(0, '0'),
      createReceipt(1, '1'),
    ],
  };

  const actual = {
    workflow_id: 'test-workflow-1',
    receipts: [
      createReceipt(0, '0'),
      createReceipt(1, '1'),
    ],
  };

  const report = analyzeDivergence(expected, actual);

  assert.strictEqual(report.divergence_detected, false);
  assert.ok(report.diagnosis.includes('No divergence detected'));
  assert.strictEqual(report.workflow_id, 'test-workflow-1');
});

/**
 * Test: Detect frontier divergence
 */
test('Detect frontier divergence', () => {
  const expected = {
    workflow_id: 'test-workflow-2',
    receipts: [
      createReceipt(0, '0', ['42'], '0'),
      createReceipt(1, '1', ['6', '42'], '1'), // Expected: normalized
    ],
  };

  const actual = {
    workflow_id: 'test-workflow-2',
    receipts: [
      createReceipt(0, '0', ['42'], '0'),
      createReceipt(1, '1', ['5+1', '42'], '2'), // Actual: not normalized
    ],
  };

  const report = analyzeDivergence(expected, actual);

  assert.strictEqual(report.divergence_detected, true);
  assert.strictEqual(report.divergence_point.step_index, 1);
  assert.strictEqual(report.divergence_type, DivergenceType.FRONTIER);
  assert.ok(report.diagnosis.includes('Frontier divergence'));
  assert.ok(report.diagnosis.includes("'6'"));
  assert.ok(report.diagnosis.includes("'5+1'"));
  assert.ok(report.repair_suggestions.length > 0);
  assert.strictEqual(report.severity, Severity.MEDIUM);
});

/**
 * Test: Detect hash chain mismatch
 */
test('Detect hash chain mismatch', () => {
  const expected = {
    workflow_id: 'test-workflow-3',
    receipts: [
      createReceipt(0, '0'),
      createReceipt(1, '1'), // Correct hash
    ],
  };

  const actual = {
    workflow_id: 'test-workflow-3',
    receipts: [
      createReceipt(0, '0'),
      createReceipt(1, 'X'), // Wrong hash!
    ],
  };

  const report = analyzeDivergence(expected, actual);

  assert.strictEqual(report.divergence_detected, true);
  assert.strictEqual(report.divergence_point.step_index, 1);
  assert.ok([DivergenceType.RECEIPT_CHAIN, DivergenceType.FRONTIER].includes(report.divergence_type));
  assert.ok(report.diagnosis.includes('divergence'));
  assert.ok(report.repair_suggestions.length > 0);
});

/**
 * Test: Detect receipt count mismatch (early termination)
 */
test('Detect receipt count mismatch - early termination', () => {
  const expected = {
    workflow_id: 'test-workflow-4',
    receipts: [
      createReceipt(0),
      createReceipt(1),
      createReceipt(2),
    ],
  };

  const actual = {
    workflow_id: 'test-workflow-4',
    receipts: [
      createReceipt(0),
      createReceipt(1),
      // Missing step 2 - early termination!
    ],
  };

  const report = analyzeDivergence(expected, actual);

  assert.strictEqual(report.divergence_detected, true);
  assert.strictEqual(report.divergence_point.step_index, 2);
  assert.ok(report.diagnosis.includes('Receipt count mismatch'));
  assert.ok(report.diagnosis.includes('early'));

  // Should have critical priority suggestion
  const criticalSuggestions = report.repair_suggestions.filter(
    s => s.priority === Priority.CRITICAL
  );
  assert.ok(criticalSuggestions.length > 0);
});

/**
 * Test: Detect receipt count mismatch (infinite loop)
 */
test('Detect receipt count mismatch - infinite loop', () => {
  const expected = {
    workflow_id: 'test-workflow-5',
    receipts: [
      createReceipt(0),
      createReceipt(1),
    ],
  };

  const actual = {
    workflow_id: 'test-workflow-5',
    receipts: [
      createReceipt(0),
      createReceipt(1),
      createReceipt(2),
      createReceipt(3),
      // Extra steps - potential infinite loop
    ],
  };

  const report = analyzeDivergence(expected, actual);

  assert.strictEqual(report.divergence_detected, true);
  assert.strictEqual(report.divergence_point.step_index, 2);
  assert.ok(report.diagnosis.includes('Receipt count mismatch'));
  assert.ok(report.diagnosis.includes('beyond expected') || report.diagnosis.includes('infinite'));

  // Should have critical priority suggestion
  const criticalSuggestions = report.repair_suggestions.filter(
    s => s.priority === Priority.CRITICAL
  );
  assert.ok(criticalSuggestions.length > 0);
});

/**
 * Test: Detect budget violation
 */
test('Detect budget violation', () => {
  const expectedReceipt = createReceipt(0);
  expectedReceipt.budget_remaining.budget_exceeded = false;

  const actualReceipt = createReceipt(0);
  actualReceipt.budget_remaining.budget_exceeded = true;

  const expected = {
    workflow_id: 'test-workflow-6',
    receipts: [expectedReceipt],
  };

  const actual = {
    workflow_id: 'test-workflow-6',
    receipts: [actualReceipt],
  };

  const report = analyzeDivergence(expected, actual);

  assert.strictEqual(report.divergence_detected, true);
  assert.strictEqual(report.divergence_type, DivergenceType.BUDGET);
  assert.ok(report.diagnosis.includes('Budget violation'));
  assert.strictEqual(report.severity, Severity.HIGH);
});

/**
 * Test: Detect operation mismatch
 */
test('Detect operation mismatch', () => {
  const expectedReceipt = createReceipt(0);
  expectedReceipt.operation = 'reduce';

  const actualReceipt = createReceipt(0);
  actualReceipt.operation = 'evaluate'; // Different operation!

  const expected = {
    workflow_id: 'test-workflow-7',
    receipts: [expectedReceipt],
  };

  const actual = {
    workflow_id: 'test-workflow-7',
    receipts: [actualReceipt],
  };

  const report = analyzeDivergence(expected, actual);

  assert.strictEqual(report.divergence_detected, true);
  assert.ok(report.diagnosis.includes('Operation mismatch'));
  assert.ok(report.diagnosis.includes('reduce'));
  assert.ok(report.diagnosis.includes('evaluate'));
});

/**
 * Test: Effect mismatch detection
 */
test('Detect effect mismatch', () => {
  const expectedReceipt = createReceipt(0);
  expectedReceipt.effects_performed = [
    { effect_type: 'logging', effect_data: 'log1' },
  ];

  const actualReceipt = createReceipt(0);
  actualReceipt.effects_performed = [
    { effect_type: 'io', effect_data: 'io1' }, // Different effect!
  ];

  const expected = {
    workflow_id: 'test-workflow-8',
    receipts: [expectedReceipt],
  };

  const actual = {
    workflow_id: 'test-workflow-8',
    receipts: [actualReceipt],
  };

  const report = analyzeDivergence(expected, actual);

  // Note: Effect mismatch alone doesn't trigger divergence unless
  // it affects the hash chain or frontier. This test verifies
  // that the comparison logic works correctly.
  assert.strictEqual(report.divergence_detected, false);
});

/**
 * Test: Repair suggestions are prioritized
 */
test('Repair suggestions are prioritized', () => {
  const expected = {
    workflow_id: 'test-workflow-9',
    receipts: [
      createReceipt(0, '0', ['42'], '0'),
      createReceipt(1, '1', ['6'], '1'),
    ],
  };

  const actual = {
    workflow_id: 'test-workflow-9',
    receipts: [
      createReceipt(0, '0', ['42'], '0'),
      createReceipt(1, 'X', ['5+1'], 'X'), // Hash and frontier diverge
    ],
  };

  const report = analyzeDivergence(expected, actual);

  assert.ok(report.repair_suggestions.length > 0);

  // Verify priorities are valid
  for (const suggestion of report.repair_suggestions) {
    assert.ok(Object.values(Priority).includes(suggestion.priority));
    assert.ok(suggestion.action.length > 0);
    assert.ok(suggestion.rationale.length > 0);
  }

  // Verify critical suggestions come first (if any)
  let lastPriorityValue = 0;
  const priorityValues = {
    [Priority.CRITICAL]: 0,
    [Priority.HIGH]: 1,
    [Priority.MEDIUM]: 2,
    [Priority.LOW]: 3,
  };

  for (const suggestion of report.repair_suggestions) {
    const currentValue = priorityValues[suggestion.priority];
    assert.ok(currentValue >= lastPriorityValue, 'Suggestions should be prioritized');
    lastPriorityValue = currentValue;
  }
});

/**
 * Test: Report includes metadata
 */
test('Report includes complete metadata', () => {
  const expected = {
    workflow_id: 'test-workflow-10',
    receipts: [createReceipt(0)],
  };

  const actual = {
    workflow_id: 'test-workflow-10',
    receipts: [createReceipt(0)],
  };

  const report = analyzeDivergence(expected, actual);

  assert.ok(report.report_id);
  assert.ok(report.timestamp);
  assert.strictEqual(report.workflow_id, 'test-workflow-10');
  assert.ok(report.metadata);
  assert.ok(report.metadata.detector_version);
  assert.ok(typeof report.metadata.analysis_duration_ms === 'number');
  assert.ok(report.metadata.analysis_duration_ms >= 0);
});

/**
 * Test: Severity determination
 */
test('Severity is correctly determined', () => {
  // Critical severity test would require causal chain or signature issues
  // High severity for hash chain mismatch
  const highSeverityExpected = {
    workflow_id: 'test-workflow-11',
    receipts: [createReceipt(0, '0'), createReceipt(1, '1')],
  };

  const highSeverityActual = {
    workflow_id: 'test-workflow-11',
    receipts: [createReceipt(0, '0'), createReceipt(1, 'X')],
  };

  const highReport = analyzeDivergence(highSeverityExpected, highSeverityActual);

  if (highReport.divergence_detected) {
    assert.ok([Severity.HIGH, Severity.MEDIUM].includes(highReport.severity));
  }
});

console.log('\n✅ All divergence reporter tests passed!\n');
