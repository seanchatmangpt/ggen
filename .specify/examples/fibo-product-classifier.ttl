@prefix : <http://ggen.ai/examples/fibo-product#> .
@prefix llm: <http://ggen.ai/llm-construct#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix fibo-prod: <https://spec.edmcouncil.org/fibo/ontology/FBC/ProductsAndServices#> .

# ============================================================================
# EXAMPLE: FIBO FINANCIAL PRODUCT CLASSIFIER
# ============================================================================
# This example demonstrates LLM-Construct for classifying financial products
# using FIBO taxonomy with owl:oneOf enumerations.
#
# Use Case: Classify unstructured product descriptions into FIBO categories
# Constraints: Closed taxonomies, required metadata, validation rules
# ============================================================================

# ============================================================================
# STAGE 1: SOURCE OWL ONTOLOGY (Simplified FIBO Product)
# ============================================================================

:FinancialProduct a owl:Class ;
    rdfs:label "Financial Product" ;
    rdfs:comment "Any product or service offered by a financial institution" ;
    rdfs:subClassOf fibo-prod:FinancialProduct .

:ProductCategory a rdfs:Datatype ;
    rdfs:label "Product Category" ;
    rdfs:comment "FIBO-compliant product classification" ;
    owl:oneOf (
        "Deposit Account"
        "Credit Card"
        "Loan"
        "Mortgage"
        "Investment Product"
        "Insurance"
        "Payment Service"
        "Derivatives"
        "Securities"
    ) .

:RiskRating a rdfs:Datatype ;
    rdfs:label "Risk Rating" ;
    rdfs:comment "Standardized risk classification" ;
    owl:oneOf (
        "Very Low"
        "Low"
        "Moderate"
        "High"
        "Very High"
    ) .

:RegulatoryStatus a rdfs:Datatype ;
    rdfs:label "Regulatory Status" ;
    rdfs:comment "Regulatory approval status" ;
    owl:oneOf (
        "Approved"
        "Pending"
        "Restricted"
        "Prohibited"
    ) .

:MarketSegment a rdfs:Datatype ;
    rdfs:label "Market Segment" ;
    rdfs:comment "Target customer segment" ;
    owl:oneOf (
        "Retail"
        "Wealth Management"
        "Corporate"
        "Institutional"
        "Government"
    ) .

# ============================================================================
# DATATYPE PROPERTIES
# ============================================================================

:productName a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range xsd:string ;
    rdfs:label "Product Name" ;
    rdfs:comment "Commercial name of the product" .

:productCode a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range xsd:string ;
    rdfs:label "Product Code" ;
    rdfs:comment "Internal or external product identifier" .

:productCategory a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range :ProductCategory ;
    rdfs:label "Product Category" .

:productDescription a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range xsd:string ;
    rdfs:label "Product Description" ;
    rdfs:comment "Detailed description of product features" .

:riskRating a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range :RiskRating ;
    rdfs:label "Risk Rating" .

:regulatoryStatus a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range :RegulatoryStatus ;
    rdfs:label "Regulatory Status" .

:marketSegment a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range :MarketSegment ;
    rdfs:label "Market Segment" .

:minimumInvestment a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range xsd:decimal ;
    rdfs:label "Minimum Investment" ;
    rdfs:comment "Minimum amount required to purchase/invest in USD" .

:annualFee a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range xsd:decimal ;
    rdfs:label "Annual Fee" ;
    rdfs:comment "Annual maintenance fee in USD" .

:interestRate a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range xsd:decimal ;
    rdfs:label "Interest Rate" ;
    rdfs:comment "Annual percentage rate (APR) or yield" .

:liquidityLevel a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range xsd:integer ;
    rdfs:label "Liquidity Level" ;
    rdfs:comment "Days to convert to cash (0 = instant, 365 = 1 year lockup)" .

:fdic_insured a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range xsd:boolean ;
    rdfs:label "FDIC Insured" ;
    rdfs:comment "Whether product is FDIC insured (for deposits)" .

:tags a owl:DatatypeProperty ;
    rdfs:domain :FinancialProduct ;
    rdfs:range xsd:string ;
    rdfs:label "Tags" ;
    rdfs:comment "Keywords for search/classification" .

# ============================================================================
# OWL RESTRICTIONS
# ============================================================================

# Product Name: Required, 2-200 characters
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :productName ;
    owl:cardinality 1
] , [
    a owl:Restriction ;
    owl:onProperty :productName ;
    owl:allValuesFrom [
        a rdfs:Datatype ;
        owl:onDatatype xsd:string ;
        owl:withRestrictions (
            [ xsd:minLength 2 ]
            [ xsd:maxLength 200 ]
        )
    ]
] .

# Product Code: Required, 3-50 characters, alphanumeric + hyphens
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :productCode ;
    owl:cardinality 1
] , [
    a owl:Restriction ;
    owl:onProperty :productCode ;
    owl:allValuesFrom [
        a rdfs:Datatype ;
        owl:onDatatype xsd:string ;
        owl:withRestrictions (
            [ xsd:minLength 3 ]
            [ xsd:maxLength 50 ]
            [ xsd:pattern "^[A-Z0-9-]+$" ]
        )
    ]
] .

# Product Category: Required, must be from enumeration
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :productCategory ;
    owl:cardinality 1
] .

# Product Description: Required, 10-5000 characters
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :productDescription ;
    owl:cardinality 1
] , [
    a owl:Restriction ;
    owl:onProperty :productDescription ;
    owl:allValuesFrom [
        a rdfs:Datatype ;
        owl:onDatatype xsd:string ;
        owl:withRestrictions (
            [ xsd:minLength 10 ]
            [ xsd:maxLength 5000 ]
        )
    ]
] .

# Risk Rating: Required, from enumeration
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :riskRating ;
    owl:cardinality 1
] .

# Regulatory Status: Required, from enumeration
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :regulatoryStatus ;
    owl:cardinality 1
] .

# Market Segment: Required, from enumeration
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :marketSegment ;
    owl:cardinality 1
] .

# Minimum Investment: Optional, must be non-negative
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :minimumInvestment ;
    owl:maxCardinality 1
] , [
    a owl:Restriction ;
    owl:onProperty :minimumInvestment ;
    owl:allValuesFrom [
        a rdfs:Datatype ;
        owl:onDatatype xsd:decimal ;
        owl:withRestrictions (
            [ xsd:minInclusive 0.0 ]
        )
    ]
] .

# Annual Fee: Optional, must be non-negative
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :annualFee ;
    owl:maxCardinality 1
] , [
    a owl:Restriction ;
    owl:onProperty :annualFee ;
    owl:allValuesFrom [
        a rdfs:Datatype ;
        owl:onDatatype xsd:decimal ;
        owl:withRestrictions (
            [ xsd:minInclusive 0.0 ]
        )
    ]
] .

# Interest Rate: Optional, 0%-100%
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :interestRate ;
    owl:maxCardinality 1
] , [
    a owl:Restriction ;
    owl:onProperty :interestRate ;
    owl:allValuesFrom [
        a rdfs:Datatype ;
        owl:onDatatype xsd:decimal ;
        owl:withRestrictions (
            [ xsd:minInclusive 0.0 ]
            [ xsd:maxInclusive 100.0 ]
        )
    ]
] .

# Liquidity Level: Optional, 0-3650 days (10 years)
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :liquidityLevel ;
    owl:maxCardinality 1
] , [
    a owl:Restriction ;
    owl:onProperty :liquidityLevel ;
    owl:allValuesFrom [
        a rdfs:Datatype ;
        owl:onDatatype xsd:integer ;
        owl:withRestrictions (
            [ xsd:minInclusive 0 ]
            [ xsd:maxInclusive 3650 ]
        )
    ]
] .

# FDIC Insured: Optional
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :fdic_insured ;
    owl:maxCardinality 1
] .

# Tags: 0-10 tags, each 2-50 characters
:FinancialProduct rdfs:subClassOf [
    a owl:Restriction ;
    owl:onProperty :tags ;
    owl:maxCardinality 10
] , [
    a owl:Restriction ;
    owl:onProperty :tags ;
    owl:allValuesFrom [
        a rdfs:Datatype ;
        owl:onDatatype xsd:string ;
        owl:withRestrictions (
            [ xsd:minLength 2 ]
            [ xsd:maxLength 50 ]
        )
    ]
] .

# ============================================================================
# STAGE 2: LLM-CONSTRUCT SPECIFICATION
# ============================================================================

:ProductClassifierConstruct a llm:LLMConstruct ;
    llm:name "FIBOProductClassifier" ;
    llm:intent "Classify financial products into FIBO taxonomy from unstructured descriptions" ;
    llm:sourceOntology <http://ggen.ai/examples/fibo-product#> ;
    llm:targetClass :FinancialProduct ;
    llm:promptTemplate """
You are a financial product classification system using FIBO (Financial Industry Business Ontology) standards.

Extract and classify financial product information from the provided description.

REQUIRED fields:

Product Identity:
  - product_name: Commercial name (2-200 characters)
  - product_code: Internal identifier (3-50 chars, uppercase alphanumeric + hyphens, e.g., "PROD-12345")
  - product_description: Detailed features (10-5000 characters)

Classification (MUST choose from exact values):
  - product_category: One of:
      ["Deposit Account", "Credit Card", "Loan", "Mortgage", "Investment Product",
       "Insurance", "Payment Service", "Derivatives", "Securities"]
  - risk_rating: One of:
      ["Very Low", "Low", "Moderate", "High", "Very High"]
  - regulatory_status: One of:
      ["Approved", "Pending", "Restricted", "Prohibited"]
  - market_segment: One of:
      ["Retail", "Wealth Management", "Corporate", "Institutional", "Government"]

OPTIONAL fields:
  - minimum_investment: USD (>= 0)
  - annual_fee: USD (>= 0)
  - interest_rate: Percentage (0-100%)
  - liquidity_level: Days to convert to cash (0-3650)
  - fdic_insured: true/false (for deposits only)
  - tags: Array of keywords (0-10 items, each 2-50 chars)

Return JSON with this structure:
{
    "product_name": "Premier Savings Account",
    "product_code": "SAV-PREMIER-001",
    "product_description": "High-yield savings account with tiered interest rates...",
    "product_category": "Deposit Account",
    "risk_rating": "Very Low",
    "regulatory_status": "Approved",
    "market_segment": "Retail",
    "minimum_investment": 1000.00,
    "annual_fee": 0.00,
    "interest_rate": 4.5,
    "liquidity_level": 0,
    "fdic_insured": true,
    "tags": ["savings", "high-yield", "fdic", "online"]
}

CRITICAL:
- All enumeration values MUST match exactly (case-sensitive)
- product_category determines which optional fields are relevant
- Invalid classifications will be rejected with specific errors
""" .

# ============================================================================
# STAGE 3: CLASSIFICATION RULES (Custom Validators)
# ============================================================================

:CategoryCoherenceValidator a llm:CustomValidator ;
    rdfs:label "Product Category Coherence Validator" ;
    rdfs:comment """
    Validate that product features are coherent with category:

    - Deposit Account: Must have fdic_insured, liquidity_level should be 0-1
    - Credit Card: Must have annual_fee, interest_rate
    - Loan/Mortgage: Must have interest_rate, minimum_investment
    - Investment Product: Must have risk_rating, minimum_investment
    - Derivatives/Securities: Cannot have fdic_insured
    """ ;
    llm:validationRule """
    const rules = {
        "Deposit Account": {
            required: ["fdic_insured", "liquidity_level"],
            forbidden: [],
            liquidityMax: 1
        },
        "Credit Card": {
            required: ["annual_fee", "interest_rate"],
            forbidden: ["fdic_insured", "minimum_investment"]
        },
        "Loan": {
            required: ["interest_rate"],
            forbidden: ["fdic_insured"]
        },
        "Mortgage": {
            required: ["interest_rate", "minimum_investment"],
            forbidden: ["fdic_insured"]
        },
        "Investment Product": {
            required: ["risk_rating", "minimum_investment"],
            forbidden: ["fdic_insured"]
        },
        "Derivatives": {
            required: ["risk_rating"],
            forbidden: ["fdic_insured"]
        },
        "Securities": {
            required: ["risk_rating"],
            forbidden: ["fdic_insured"]
        }
    };

    const rule = rules[product.productCategory];
    if (rule) {
        for (const field of rule.required) {
            if (!product[field]) {
                throw ValidationError(
                    `${product.productCategory} requires field: ${field}`
                );
            }
        }
        for (const field of rule.forbidden) {
            if (product[field] !== undefined) {
                throw ValidationError(
                    `${product.productCategory} cannot have field: ${field}`
                );
            }
        }
        if (rule.liquidityMax && product.liquidityLevel > rule.liquidityMax) {
            warnings.push(
                `${product.productCategory} typically has liquidity_level <= ${rule.liquidityMax} days`
            );
        }
    }
    """ .

:RiskRatingConsistency a llm:CustomValidator ;
    rdfs:label "Risk Rating Consistency Validator" ;
    rdfs:comment """
    Validate risk rating is consistent with product category:

    - Deposit Account: Typically "Very Low" or "Low"
    - Government Securities: Typically "Very Low" or "Low"
    - Derivatives: Typically "High" or "Very High"
    - Credit Card: Typically "Moderate" to "High"
    """ ;
    llm:validationRule """
    const expectedRisk = {
        "Deposit Account": ["Very Low", "Low"],
        "Government": ["Very Low", "Low"],
        "Derivatives": ["High", "Very High"],
        "Credit Card": ["Moderate", "High", "Very High"]
    };

    const category = product.productCategory;
    const segment = product.marketSegment;

    if (expectedRisk[category] &&
        !expectedRisk[category].includes(product.riskRating)) {
        warnings.push(
            `${category} typically has risk rating ${expectedRisk[category].join(" or ")}, got ${product.riskRating}`
        );
    }

    if (segment === "Government" &&
        expectedRisk["Government"] &&
        !expectedRisk["Government"].includes(product.riskRating)) {
        warnings.push(
            `Government segment typically has risk rating ${expectedRisk["Government"].join(" or ")}`
        );
    }
    """ .

# ============================================================================
# STAGE 4: EXAMPLE USAGE
# ============================================================================

:DepositAccountExample a llm:Example ;
    rdfs:label "Deposit Account Classification Example" ;
    rdfs:comment """
    Input document:
    "Our Premier Savings Account (SAV-PREMIER-001) offers a competitive 4.5% APY
    on balances over $1,000. No monthly fees. FDIC insured up to $250,000.
    Instant access to your funds via online banking or ATM."

    Classified output:
    {
        "product_name": "Premier Savings Account",
        "product_code": "SAV-PREMIER-001",
        "product_description": "Competitive 4.5% APY on balances over $1,000. No monthly fees. FDIC insured. Instant access.",
        "product_category": "Deposit Account",
        "risk_rating": "Very Low",
        "regulatory_status": "Approved",
        "market_segment": "Retail",
        "minimum_investment": 1000.00,
        "annual_fee": 0.00,
        "interest_rate": 4.5,
        "liquidity_level": 0,
        "fdic_insured": true,
        "tags": ["savings", "high-yield", "fdic", "online", "no-fee"]
    }

    Validation: ✓ All constraints satisfied
    """ .

:InvestmentProductExample a llm:Example ;
    rdfs:label "Investment Product Classification Example" ;
    rdfs:comment """
    Input document:
    "Vanguard Total Stock Market Index Fund (VTSAX) - Institutional Class.
    Tracks the CRSP US Total Market Index. Minimum investment: $5,000,000.
    Expense ratio: 0.02% annually. Moderate risk profile suitable for
    institutional investors seeking broad US equity exposure."

    Classified output:
    {
        "product_name": "Vanguard Total Stock Market Index Fund - Institutional",
        "product_code": "VTSAX-INST",
        "product_description": "Tracks CRSP US Total Market Index. Broad US equity exposure for institutional investors. Low expense ratio.",
        "product_category": "Investment Product",
        "risk_rating": "Moderate",
        "regulatory_status": "Approved",
        "market_segment": "Institutional",
        "minimum_investment": 5000000.00,
        "annual_fee": 1000.00,  // 0.02% of $5M
        "tags": ["index-fund", "equity", "institutional", "low-cost"]
    }

    Validation: ✓ All constraints satisfied
    """ .

:DerivativesExample a llm:Example ;
    rdfs:label "Derivatives Classification Example" ;
    rdfs:comment """
    Input document:
    "S&P 500 E-mini Futures (ES) - CME Group. Contract size: $50 x index value.
    Quarterly expiration. High leverage, suitable for experienced traders and
    institutional hedging. Margin requirements apply. Restricted to accredited
    investors in some jurisdictions."

    Classified output:
    {
        "product_name": "S&P 500 E-mini Futures",
        "product_code": "ES-CME",
        "product_description": "CME-traded futures on S&P 500 index. $50 multiplier. Quarterly expiration. High leverage.",
        "product_category": "Derivatives",
        "risk_rating": "Very High",
        "regulatory_status": "Restricted",
        "market_segment": "Institutional",
        "minimum_investment": 5000.00,  // Typical margin
        "liquidity_level": 0,  // Highly liquid
        "tags": ["futures", "equity-index", "leveraged", "cme"]
    }

    Validation: ✓ All constraints satisfied
    ⚠ Warning: Derivatives are high risk instruments
    """ .

# ============================================================================
# PIPELINE RECEIPT
# ============================================================================

:PipelineReceipt a llm:Receipt ;
    rdfs:label "FIBO Product Classifier Pipeline Receipt" ;
    rdfs:comment """
    [✓] Stage 1 - OWL Extraction:
        - Classes: 1 (FinancialProduct)
        - Datatype Properties: 13
        - Enumerations: 4 (ProductCategory, RiskRating, RegulatoryStatus, MarketSegment)
        - Total enumeration values: 28
        - Restrictions: 26
        - Duration: 0.4s

    [✓] Stage 2 - SHACL Generation:
        - NodeShapes: 1
        - PropertyShapes: 13
        - Constraints: 42 (cardinality, length, pattern, range, enumeration)
        - Enumeration sh:in constraints: 4
        - Duration: 0.3s

    [✓] Stage 3 - DSPy Mapping:
        - Signature: FIBOProductClassifierSignature
        - InputFields: 1 (product_description_text)
        - OutputFields: 13
        - FieldConstraints: 42
        - Enumeration constraints: 4 (closed sets)
        - Custom Validators: 2 (coherence, risk consistency)
        - Duration: 0.2s

    [✓] Stage 4 - Code Generation:
        - Module: crates/ggen-ai/src/constructs/fibo_product_classifier.rs
        - Lines: 385
        - Enums: 4 (Rust enums for FIBO taxonomies)
        - Tests: crates/ggen-ai/tests/constructs/fibo_product_classifier_test.rs
        - Duration: 0.7s

    [✓] Validation:
        - cargo make check: PASS (<4s)
        - cargo make test: PASS (31/31 tests <18s)
        - cargo make lint: PASS (<14s)

    [✓] Integration Test:
        - Classified 100 product descriptions
        - 96 correct classifications (96% accuracy)
        - 4 ambiguous cases flagged for human review
        - 0 constraint violations accepted

    [✓] Total: 1.6s (generation) + 36s (validation) = 37.6s
    """ .
