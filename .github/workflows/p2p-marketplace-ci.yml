name: P2P Marketplace CI/CD

on:
  push:
    branches: [master, main]
    paths:
      - 'ggen-marketplace/**'
      - 'cli/src/cmds/marketplace.rs'
      - 'cli/src/domain/marketplace/**'
      - '.github/workflows/p2p-marketplace-ci.yml'
  pull_request:
    branches: [master, main]
    paths:
      - 'ggen-marketplace/**'
      - 'cli/src/cmds/marketplace.rs'
      - 'cli/src/domain/marketplace/**'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Build Matrix - Test all feature combinations
  build-matrix:
    name: Build (${{ matrix.features }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        features:
          - name: "Default (crypto only)"
            flags: ""
          - name: "All Features (P2P + GraphQL + Crypto)"
            flags: "--all-features"
          - name: "No Default Features"
            flags: "--no-default-features"
          - name: "P2P Only"
            flags: "--no-default-features --features p2p"
          - name: "GraphQL Only"
            flags: "--no-default-features --features graphql"
          - name: "P2P + Crypto"
            flags: "--no-default-features --features p2p,crypto"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.features.name }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.features.name }}-
            ${{ runner.os }}-cargo-

      - name: Build workspace with ${{ matrix.features.name }}
        run: |
          echo "::group::Building with ${{ matrix.features.name }}"
          cargo build --workspace ${{ matrix.features.flags }}
          echo "::endgroup::"

      - name: Build ggen-marketplace with ${{ matrix.features.name }}
        run: |
          echo "::group::Building ggen-marketplace"
          cd ggen-marketplace
          cargo build ${{ matrix.features.flags }}
          echo "::endgroup::"

  # Test Matrix - Run tests with all feature combinations
  test-matrix:
    name: Test (${{ matrix.features }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        features:
          - name: "Default Features"
            flags: ""
          - name: "All Features"
            flags: "--all-features"
          - name: "No Default"
            flags: "--no-default-features"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-test-${{ matrix.features.name }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Run workspace tests
        run: |
          echo "::group::Workspace tests with ${{ matrix.features.name }}"
          cargo test --workspace ${{ matrix.features.flags }}
          echo "::endgroup::"

      - name: Run ggen-marketplace tests
        run: |
          echo "::group::Marketplace tests"
          cd ggen-marketplace
          cargo test ${{ matrix.features.flags }}
          echo "::endgroup::"

  # Chicago TDD Tests
  chicago-tdd:
    name: Chicago TDD Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-chicago-tdd-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Chicago TDD search tests
        run: |
          echo "::group::Chicago TDD Search Tests"
          cargo test --test marketplace_search_chicago_tdd
          echo "::endgroup::"

      - name: Run install integration tests
        run: |
          echo "::group::Install Integration Tests"
          cargo test --test marketplace_install_e2e
          echo "::endgroup::"

  # Security Audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo audit
        run: |
          echo "::group::Security Audit"
          cargo audit --deny warnings || echo "::warning::Security vulnerabilities found"
          echo "::endgroup::"

      - name: Check for yanked crates
        run: |
          echo "::group::Check Yanked Crates"
          cargo audit --deny yanked
          echo "::endgroup::"

  # Clippy Linting
  clippy-matrix:
    name: Clippy (${{ matrix.features }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        features: ["", "--all-features", "--no-default-features"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Run clippy on workspace
        run: |
          echo "::group::Clippy Workspace"
          cargo clippy --workspace ${{ matrix.features }} -- -D warnings
          echo "::endgroup::"

      - name: Run clippy on ggen-marketplace
        run: |
          echo "::group::Clippy Marketplace"
          cd ggen-marketplace
          cargo clippy ${{ matrix.features }} -- -D warnings
          echo "::endgroup::"

  # Documentation Build
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-docs-${{ hashFiles('**/Cargo.lock') }}

      - name: Build documentation
        run: |
          echo "::group::Build Docs"
          cargo doc --workspace --all-features --no-deps
          echo "::endgroup::"

      - name: Check doc warnings
        run: |
          echo "::group::Check Doc Warnings"
          cargo doc --workspace --all-features --no-deps 2>&1 | tee doc-output.txt
          if grep -i "warning" doc-output.txt; then
            echo "::warning::Documentation warnings found"
          fi
          echo "::endgroup::"

  # Performance Benchmarks
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Run marketplace benchmarks
        run: |
          echo "::group::Marketplace Benchmarks"
          cargo bench --bench marketplace_performance -- --output-format bencher | tee bench-output.txt
          echo "::endgroup::"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: bench-output.txt

  # Summary Job
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build-matrix, test-matrix, chicago-tdd, security-audit, clippy-matrix, docs]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## P2P Marketplace CI/CD Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Matrix: ${{ needs.build-matrix.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### Test Matrix: ${{ needs.test-matrix.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### Chicago TDD: ${{ needs.chicago-tdd.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### Security Audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### Clippy: ${{ needs.clippy-matrix.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### Documentation: ${{ needs.docs.result }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-matrix.result }}" != "success" ] || \
             [ "${{ needs.test-matrix.result }}" != "success" ] || \
             [ "${{ needs.chicago-tdd.result }}" != "success" ] || \
             [ "${{ needs.clippy-matrix.result }}" != "success" ]; then
            echo "::error::CI pipeline failed"
            exit 1
          fi

          echo "âœ… All CI checks passed!" >> $GITHUB_STEP_SUMMARY
