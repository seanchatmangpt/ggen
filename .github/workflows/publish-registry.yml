name: Publish Docs to GitHub Pages

on:
  push:
    paths:
      - "docs/**"
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-running: true

jobs:
  validate-registry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Validate registry index
        run: |
          # Check JSON syntax
          python3 -m json.tool docs/registry/index.json > /dev/null
          echo "✅ Registry index JSON is valid"

          # Check required fields
          python3 -c "
          import json
          with open('docs/registry/index.json') as f:
              data = json.load(f)

          # Validate structure
          assert 'updated' in data, 'Missing updated field'
          assert 'packs' in data, 'Missing packs field'

          for pack_id, pack in data['packs'].items():
              assert 'id' in pack, f'Pack {pack_id} missing id'
              assert 'latest_version' in pack, f'Pack {pack_id} missing latest_version'
              assert 'versions' in pack, f'Pack {pack_id} missing versions'
              
              for version, version_data in pack['versions'].items():
                  assert 'git_url' in version_data, f'Version {version} missing git_url'
                  assert 'git_rev' in version_data, f'Version {version} missing git_rev'
                  assert 'sha256' in version_data, f'Version {version} missing sha256'

          print('✅ Registry structure validation passed')
          "

      - name: Test registry client
        run: |
          cargo make test-marketplace

  build-and-deploy:
    needs: validate-registry
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare docs files
        run: |
          mkdir -p _site
          cp -r docs/* _site/

          # The docs/index.html will be used as the main page

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
