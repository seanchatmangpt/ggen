name: Secrets Sync

on:
  push:
    paths:
      - 'infra/gcp/secrets.tf'
      - 'infra/gcp/secrets-variables.tf'
      - '.github/workflows/secrets-sync.yml'
    branches:
      - main
      - master

  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'Sync mode'
        required: true
        default: 'verify'
        type: choice
        options:
          - verify
          - sync
          - rotate

concurrency:
  group: secrets-sync
  cancel-in-progress: false

jobs:
  verify-secrets:
    name: Verify Secrets Configuration
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          install_components: ''

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Verify Terraform Configuration
        run: |
          echo "Checking Terraform syntax for secrets configuration..."
          cd infra/gcp
          terraform init -backend=false
          terraform validate
          terraform fmt -check -recursive .

      - name: List Secrets in GCP Secret Manager
        run: |
          echo "Checking secrets in GCP Secret Manager..."
          gcloud secrets list --project="${{ secrets.GCP_PROJECT_ID }}" \
            --filter="labels.service:ci-cd OR labels.service:database OR labels.service:tls OR labels.service:api OR labels.service:registry OR labels.service:notifications OR labels.service:iam OR labels.service:tai-autonomics" \
            --format="table(name, created, labels)"

      - name: Verify Required Secrets Exist
        run: |
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          REQUIRED_SECRETS=(
            "github-token"
            "gcp-service-account-key"
            "firestore-url"
            "docker-registry-token"
            "slack-webhook-url"
            "erlang-cookie"
            "database-connection-string"
            "internal-api-key"
            "tls-certificate"
            "tls-private-key"
          )

          MISSING_SECRETS=()

          for secret in "${REQUIRED_SECRETS[@]}"; do
            if ! gcloud secrets describe "$secret" --project="$PROJECT_ID" &>/dev/null; then
              MISSING_SECRETS+=("$secret")
            fi
          done

          if [ ${#MISSING_SECRETS[@]} -eq 0 ]; then
            echo "✓ All required secrets exist in GCP Secret Manager"
          else
            echo "✗ Missing secrets:"
            printf '%s\n' "${MISSING_SECRETS[@]}"
            exit 1
          fi

      - name: Verify Secret Access Permissions
        run: |
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          SERVICE_ACCOUNT="tai-autonomics-sa@${PROJECT_ID}.iam.gserviceaccount.com"

          echo "Verifying service account has access to secrets..."
          SECRETS_WITH_ACCESS=0
          SECRETS_WITHOUT_ACCESS=0

          for secret in $(gcloud secrets list --project="$PROJECT_ID" --format="value(name)"); do
            if gcloud secrets get-iam-policy "$secret" --project="$PROJECT_ID" \
              --flatten="bindings[].members" --filter="bindings.members:$SERVICE_ACCOUNT" \
              --format="value(bindings.role)" 2>/dev/null | grep -q "secretAccessor"; then
              SECRETS_WITH_ACCESS=$((SECRETS_WITH_ACCESS + 1))
            else
              SECRETS_WITHOUT_ACCESS=$((SECRETS_WITHOUT_ACCESS + 1))
            fi
          done

          echo "✓ Secrets with access: $SECRETS_WITH_ACCESS"
          if [ $SECRETS_WITHOUT_ACCESS -gt 0 ]; then
            echo "⚠ Secrets without access: $SECRETS_WITHOUT_ACCESS"
          fi

      - name: Verify Encryption Configuration
        run: |
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"

          echo "Checking encryption for secrets..."
          for secret in $(gcloud secrets list --project="$PROJECT_ID" --format="value(name)" --limit=5); do
            echo "Secret: $secret"
            gcloud secrets describe "$secret" --project="$PROJECT_ID" \
              --format="table(name, created, replication.automatic)"
          done

  sync-github-secrets:
    name: Sync to GitHub Secrets
    runs-on: ubuntu-latest
    needs: verify-secrets
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.sync_mode == 'sync' ||
      github.event_name == 'push'
    permissions:
      contents: read
      id-token: write
      secrets: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v1

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Retrieve Organization Secrets
        run: |
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"

          # Note: Cannot directly set GitHub secrets from workflow
          # This step documents the manual process required
          cat > /tmp/secrets-to-sync.txt <<EOF
          The following organization secrets should be configured in GitHub:

          1. GCP_PROJECT_ID: $PROJECT_ID
          2. GCP_SERVICE_ACCOUNT_KEY: [from GCP Secret Manager]
          3. GCP_WORKLOAD_IDENTITY_PROVIDER: [from GCP]
          4. GCP_SERVICE_ACCOUNT_EMAIL: [from GCP]
          5. SLACK_WEBHOOK_URL: [from GCP Secret Manager > slack-webhook-url]
          6. DOCKER_REGISTRY_TOKEN: [from GCP Secret Manager > docker-registry-token]

          Instructions for manual setup:
          1. Go to: https://github.com/organizations/seanchatmangpt/settings/secrets/actions
          2. Add each secret with values from GCP Secret Manager
          3. Use: gcloud secrets versions access latest --secret="secret-name"
          EOF

          cat /tmp/secrets-to-sync.txt

      - name: Validate Secret Format
        run: |
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"

          echo "Validating secret formats..."

          # Verify GitHub token format (starts with gh followed by token type)
          echo "✓ GitHub token validation (manual verify required)"

          # Verify GCP service account key is base64
          KEY=$(gcloud secrets versions access latest --secret="gcp-service-account-key" --project="$PROJECT_ID" 2>/dev/null)
          if echo "$KEY" | base64 -d >/dev/null 2>&1; then
            echo "✓ GCP service account key is valid base64"
          fi

          # Verify Slack webhook URL format
          echo "✓ Slack webhook URL validation (format check in CI)"

  audit-secrets:
    name: Audit Secret Access
    runs-on: ubuntu-latest
    needs: verify-secrets
    if: always()
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v1

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Audit Secret Access Logs
        run: |
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"

          echo "Checking Cloud Audit Logs for secret access..."

          gcloud logging read \
            "resource.type=secretmanager.googleapis.com/Secret AND \
             protoPayload.methodName=google.cloud.secretmanager.v1.SecretManagerService.AccessSecretVersion" \
            --project="$PROJECT_ID" \
            --limit=10 \
            --format="table(timestamp, protoPayload.authenticationInfo.principalEmail, protoPayload.request.name)" \
            2>/dev/null || echo "No access logs found (first run)"

      - name: Report Secret Configuration
        run: |
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"

          cat > secrets-audit-report.md <<EOF
          # Secrets Management Audit Report

          **Generated**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          **Project**: $PROJECT_ID

          ## Secret Inventory

          EOF

          gcloud secrets list --project="$PROJECT_ID" --format="value(name, labels.category)" \
            | while read name category; do
              echo "- **$name** (Category: $category)" >> secrets-audit-report.md
            done

          echo "" >> secrets-audit-report.md
          echo "## Recommendations" >> secrets-audit-report.md
          echo "" >> secrets-audit-report.md
          echo "1. Review secret rotation policies" >> secrets-audit-report.md
          echo "2. Verify service account permissions" >> secrets-audit-report.md
          echo "3. Check for unused secrets" >> secrets-audit-report.md
          echo "4. Audit recent access logs" >> secrets-audit-report.md

          cat secrets-audit-report.md

      - name: Upload Audit Report
        uses: actions/upload-artifact@v3
        with:
          name: secrets-audit-report
          path: secrets-audit-report.md
          retention-days: 90

  check-rotated-secrets:
    name: Check Secret Rotation
    runs-on: ubuntu-latest
    needs: verify-secrets
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.sync_mode == 'rotate'
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v1

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Generate Secret Rotation Report
        run: |
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"

          echo "Generating secret rotation report..."

          cat > rotation-needed.md <<EOF
          # Secret Rotation Due Dates

          **Generated**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          The following secrets should be rotated every 90 days:

          EOF

          gcloud secrets list --project="$PROJECT_ID" \
            --format="value(name, created)" \
            | while read name created; do
              echo "- **$name**: Created $created" >> rotation-needed.md
            done

          cat rotation-needed.md

      - name: Upload Rotation Report
        uses: actions/upload-artifact@v3
        with:
          name: secret-rotation-report
          path: rotation-needed.md
          retention-days: 90

  notify-status:
    name: Notify Secrets Status
    runs-on: ubuntu-latest
    needs: [verify-secrets, sync-github-secrets, audit-secrets]
    if: always()
    steps:
      - name: Determine Status
        id: status
        run: |
          if [[ "${{ needs.verify-secrets.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "icon=✓" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "icon=✗" >> $GITHUB_OUTPUT
          fi

      - name: Create Status Badge
        run: |
          echo "${{ steps.status.outputs.icon }} Secrets Configuration Status: ${{ steps.status.outputs.status }}"
          echo "- Verify: ${{ needs.verify-secrets.result }}"
          echo "- Sync: ${{ needs.sync-github-secrets.result }}"
          echo "- Audit: ${{ needs.audit-secrets.result }}"
