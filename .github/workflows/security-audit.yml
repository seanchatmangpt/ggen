name: Security Audit - Week 8

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  schedule:
    # Run security audit daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  cargo-lock-verification:
    name: Cargo.lock Verification
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify Cargo.lock checksum
        run: |
          set -euo pipefail

          # Calculate SHA-256 checksum of Cargo.lock
          LOCK_HASH=$(sha256sum Cargo.lock | awk '{print $1}')
          echo "Cargo.lock SHA-256: $LOCK_HASH"

          # Store checksum for later verification
          echo "CARGO_LOCK_HASH=$LOCK_HASH" >> $GITHUB_ENV

          # Verify Cargo.lock is up to date with Cargo.toml
          cargo update --workspace --locked --dry-run

          # Verify no unexpected changes
          if ! git diff --exit-code Cargo.lock; then
            echo "::error::Cargo.lock has uncommitted changes!"
            exit 1
          fi

          echo "âœ… Cargo.lock verification passed"

      - name: Verify dependency checksums
        run: |
          set -euo pipefail

          # Verify checksums of downloaded crates
          cargo fetch --locked

          # Check for checksum mismatches (would indicate tampering)
          if cargo metadata --locked --format-version 1 > /dev/null 2>&1; then
            echo "âœ… All dependency checksums verified"
          else
            echo "::error::Dependency checksum verification failed!"
            exit 1
          fi

  security-audit:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust and cache
        uses: ./.github/actions/setup-rust-cached
        with:
          toolchain: stable
          components: clippy

      - name: Install security audit tools
        uses: ./.github/actions/install-cargo-tools
        with:
          tools: audit,deny,outdated
          cache-tools: "true"

      - name: Run cargo audit (comprehensive)
        id: audit
        continue-on-error: true
        run: |
          set -euo pipefail

          echo "## ðŸ”’ Cargo Audit Results" > audit-report.md
          echo "" >> audit-report.md

          # Run audit with JSON output for parsing
          if cargo audit --json --deny warnings > audit.json 2>&1; then
            echo "âœ… **No vulnerabilities found**" >> audit-report.md
            echo "status=success" >> $GITHUB_OUTPUT
            echo "has_critical=false" >> $GITHUB_OUTPUT
            echo "has_high=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ **Vulnerabilities detected**" >> audit-report.md
            echo "" >> audit-report.md

            # Parse vulnerabilities by severity
            CRITICAL_COUNT=$(jq '[.vulnerabilities.list[] | select(.advisory.severity == "critical")] | length' audit.json || echo "0")
            HIGH_COUNT=$(jq '[.vulnerabilities.list[] | select(.advisory.severity == "high")] | length' audit.json || echo "0")
            MEDIUM_COUNT=$(jq '[.vulnerabilities.list[] | select(.advisory.severity == "medium")] | length' audit.json || echo "0")
            LOW_COUNT=$(jq '[.vulnerabilities.list[] | select(.advisory.severity == "low")] | length' audit.json || echo "0")

            echo "### Vulnerability Summary" >> audit-report.md
            echo "- ðŸ”´ Critical: $CRITICAL_COUNT" >> audit-report.md
            echo "- ðŸŸ  High: $HIGH_COUNT" >> audit-report.md
            echo "- ðŸŸ¡ Medium: $MEDIUM_COUNT" >> audit-report.md
            echo "- ðŸŸ¢ Low: $LOW_COUNT" >> audit-report.md
            echo "" >> audit-report.md

            # Detailed vulnerability report
            echo "<details>" >> audit-report.md
            echo "<summary>Detailed Vulnerability Report</summary>" >> audit-report.md
            echo "" >> audit-report.md
            echo "\`\`\`" >> audit-report.md
            cargo audit >> audit-report.md 2>&1 || true
            echo "\`\`\`" >> audit-report.md
            echo "</details>" >> audit-report.md

            # Set output flags
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "has_critical=true" >> $GITHUB_OUTPUT
              echo "status=critical" >> $GITHUB_OUTPUT
            elif [ "$HIGH_COUNT" -gt 0 ]; then
              echo "has_critical=false" >> $GITHUB_OUTPUT
              echo "has_high=true" >> $GITHUB_OUTPUT
              echo "status=high" >> $GITHUB_OUTPUT
            else
              echo "has_critical=false" >> $GITHUB_OUTPUT
              echo "has_high=false" >> $GITHUB_OUTPUT
              echo "status=warning" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run cargo deny (licenses & advisories)
        id: deny
        continue-on-error: true
        run: |
          set -euo pipefail

          echo "" >> audit-report.md
          echo "## ðŸ“‹ License & Supply Chain Check" >> audit-report.md
          echo "" >> audit-report.md

          # Run all cargo-deny checks
          if cargo deny check 2>&1 | tee deny-output.txt; then
            echo "âœ… **All checks passed**" >> audit-report.md
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ **Issues detected**" >> audit-report.md
            echo "" >> audit-report.md
            echo "<details>" >> audit-report.md
            echo "<summary>Cargo Deny Report</summary>" >> audit-report.md
            echo "" >> audit-report.md
            echo "\`\`\`" >> audit-report.md
            cat deny-output.txt >> audit-report.md
            echo "\`\`\`" >> audit-report.md
            echo "</details>" >> audit-report.md
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Check for typosquatting
        id: typosquatting
        continue-on-error: true
        run: |
          set -euo pipefail

          echo "" >> audit-report.md
          echo "## ðŸ” Typosquatting Detection" >> audit-report.md
          echo "" >> audit-report.md

          # Run typosquatting detection script
          if ./scripts/detect-typosquatting.sh > typosquat-output.txt 2>&1; then
            echo "âœ… **No suspicious dependencies detected**" >> audit-report.md
            echo "status=clean" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ **Potential typosquatting detected**" >> audit-report.md
            echo "" >> audit-report.md
            echo "<details>" >> audit-report.md
            echo "<summary>Suspicious Dependencies</summary>" >> audit-report.md
            echo "" >> audit-report.md
            echo "\`\`\`" >> audit-report.md
            cat typosquat-output.txt >> audit-report.md
            echo "\`\`\`" >> audit-report.md
            echo "</details>" >> audit-report.md
            echo "status=suspicious" >> $GITHUB_OUTPUT
          fi

      - name: Run cargo outdated
        id: outdated
        continue-on-error: true
        run: |
          set -euo pipefail

          echo "" >> audit-report.md
          echo "## ðŸ“¦ Dependency Freshness" >> audit-report.md
          echo "" >> audit-report.md

          if cargo outdated --exit-code 1 2>&1 | tee outdated-output.txt; then
            echo "âœ… **All dependencies up to date**" >> audit-report.md
            echo "status=current" >> $GITHUB_OUTPUT
          else
            # Parse outdated dependencies
            OUTDATED_COUNT=$(grep -c "^[a-z]" outdated-output.txt || echo "0")
            echo "ðŸ“Š **$OUTDATED_COUNT outdated dependencies**" >> audit-report.md
            echo "" >> audit-report.md
            echo "<details>" >> audit-report.md
            echo "<summary>Outdated Dependencies</summary>" >> audit-report.md
            echo "" >> audit-report.md
            echo "\`\`\`" >> audit-report.md
            cat outdated-output.txt >> audit-report.md
            echo "\`\`\`" >> audit-report.md
            echo "</details>" >> audit-report.md
            echo "status=outdated" >> $GITHUB_OUTPUT
          fi

      - name: Generate security summary
        run: |
          set -euo pipefail

          echo "" >> audit-report.md
          echo "---" >> audit-report.md
          echo "" >> audit-report.md
          echo "### Summary" >> audit-report.md
          echo "- ðŸ”’ Vulnerability Scan: ${{ steps.audit.outputs.status }}" >> audit-report.md
          echo "- ðŸ“‹ License Check: ${{ steps.deny.outputs.status }}" >> audit-report.md
          echo "- ðŸ” Typosquatting: ${{ steps.typosquatting.outputs.status }}" >> audit-report.md
          echo "- ðŸ“¦ Dependencies: ${{ steps.outdated.outputs.status }}" >> audit-report.md
          echo "" >> audit-report.md
          echo "_Generated on $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> audit-report.md
          echo "" >> audit-report.md
          echo "**Cargo.lock Hash**: \`${CARGO_LOCK_HASH:-unknown}\`" >> audit-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: |
            audit-report.md
            audit.json
            deny-output.txt
            typosquat-output.txt
            outdated-output.txt
          retention-days: 90

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit-report.md', 'utf8');

            const body = `# ðŸ›¡ï¸ Security Audit Report (Week 8)\n\n${report}\n\n---\n*Automated security scan powered by cargo-audit, cargo-deny, and custom supply chain analysis*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Security Audit Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Create issue for critical vulnerabilities
        if: steps.audit.outputs.has_critical == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit-report.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ CRITICAL: Security Vulnerabilities Detected',
              body: `**STOP THE LINE** - Critical security vulnerabilities have been detected in dependencies.\n\n${report}\n\n**Action Required**: Please review and update affected dependencies immediately.\n\n## Remediation Steps:\n1. Review vulnerability details above\n2. Update affected dependencies\n3. Run \`cargo make audit\` locally to verify\n4. Test updated dependencies\n5. Create PR with fixes`,
              labels: ['security', 'critical', 'andon-red', 'dependencies']
            });

      - name: Fail on critical or high vulnerabilities
        if: steps.audit.outputs.has_critical == 'true' || steps.audit.outputs.has_high == 'true'
        run: |
          set -euo pipefail

          if [ "${{ steps.audit.outputs.has_critical }}" == "true" ]; then
            echo "::error::ðŸ”´ CRITICAL security vulnerabilities detected. Build failed."
            echo "::error::This is an ANDON SIGNAL - Stop the Line!"
            exit 1
          elif [ "${{ steps.audit.outputs.has_high }}" == "true" ]; then
            echo "::error::ðŸŸ  HIGH severity vulnerabilities detected. Build failed."
            echo "::error::This is an ANDON SIGNAL - Fix before proceeding!"
            exit 1
          fi

      - name: Warn on other issues
        if: |
          steps.audit.outputs.status == 'warning' ||
          steps.deny.outputs.status == 'failed' ||
          steps.typosquatting.outputs.status == 'suspicious'
        run: |
          set -euo pipefail
          echo "::warning::ðŸŸ¡ Security issues detected but not critical. Please review the audit report."

  sbom-generation:
    name: Generate SBOM (Software Bill of Materials)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      attestations: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx

      - name: Generate CycloneDX SBOM
        run: |
          set -euo pipefail

          # Generate SBOM in multiple formats
          cargo cyclonedx --format json --output-cdx sbom.cdx.json
          cargo cyclonedx --format xml --output-cdx sbom.cdx.xml

          echo "âœ… SBOM generated successfully"

      - name: Validate SBOM
        run: |
          set -euo pipefail

          # Verify SBOM contains required fields
          if jq -e '.bomFormat == "CycloneDX"' sbom.cdx.json > /dev/null; then
            echo "âœ… SBOM format validated"
          else
            echo "::error::Invalid SBOM format"
            exit 1
          fi

          # Count components
          COMPONENT_COUNT=$(jq '.components | length' sbom.cdx.json)
          echo "ðŸ“¦ SBOM contains $COMPONENT_COUNT components"

          # Extract and display component summary
          echo "### SBOM Component Summary" > sbom-summary.md
          jq -r '.components[] | "- \(.name)@\(.version) (\(.purl // "no-purl"))"' sbom.cdx.json >> sbom-summary.md

      - name: Generate SBOM attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: |
            sbom.cdx.json
            sbom.cdx.xml

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-artifacts
          path: |
            sbom.cdx.json
            sbom.cdx.xml
            sbom-summary.md
          retention-days: 90

      - name: Create SBOM release asset (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            sbom.cdx.json
            sbom.cdx.xml

  dependency-review:
    name: Dependency Review & Update Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0, SSPL-1.0
          comment-summary-in-pr: always
          vulnerability-check: true
          license-check: true
          config-file: .github/dependency-review-config.yml

  automated-dependency-updates:
    name: Automated Dependency Updates
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Check for security updates
        id: security_updates
        run: |
          set -euo pipefail

          # Run cargo audit to identify vulnerable dependencies
          cargo audit --json > audit-before.json || true

          # Extract vulnerable crates
          VULNERABLE_CRATES=$(jq -r '.vulnerabilities.list[] | .package.name' audit-before.json | sort -u)

          if [ -z "$VULNERABLE_CRATES" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… No security updates required"
            exit 0
          fi

          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "vulnerable_crates<<EOF" >> $GITHUB_OUTPUT
          echo "$VULNERABLE_CRATES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Apply security updates
        if: steps.security_updates.outputs.has_updates == 'true'
        run: |
          set -euo pipefail

          # Update vulnerable dependencies
          echo "${{ steps.security_updates.outputs.vulnerable_crates }}" | while read -r crate; do
            echo "Updating $crate..."
            cargo update -p "$crate" || echo "Failed to update $crate"
          done

          # Verify updates resolved vulnerabilities
          cargo audit --json > audit-after.json || true

          REMAINING=$(jq '.vulnerabilities.list | length' audit-after.json)
          echo "Remaining vulnerabilities: $REMAINING"

      - name: Run tests after updates
        if: steps.security_updates.outputs.has_updates == 'true'
        run: |
          set -euo pipefail
          timeout 120s cargo test --workspace --no-default-features || {
            echo "::error::Tests failed after dependency updates"
            exit 1
          }

      - name: Create Pull Request
        if: steps.security_updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "security: Update dependencies with known vulnerabilities"
          title: "ðŸ”’ Security: Automated dependency updates"
          body: |
            ## Security Updates

            This PR contains automated updates for dependencies with known security vulnerabilities.

            ### Updated Dependencies
            ${{ steps.security_updates.outputs.vulnerable_crates }}

            ### Verification
            - âœ… Cargo audit passed after updates
            - âœ… All tests passed
            - âœ… Cargo.lock updated

            **Automated by Week 8 Security Roadmap**
          branch: automated-security-updates
          labels: security, dependencies, automated
          reviewers: seanchatmangpt

  clippy-security:
    name: Clippy Security Lints
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Clippy with security lints
        run: |
          cargo clippy --all-targets --all-features -- \
            -W clippy::all \
            -W clippy::pedantic \
            -W clippy::nursery \
            -W clippy::cargo \
            -D warnings
